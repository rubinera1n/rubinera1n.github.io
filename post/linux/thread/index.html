<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Thread - Rubinera1n&#39;s Blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="rubinera1n" />
  <meta name="description" content="1. çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ çº¿ç¨‹è‹±æ–‡å•è¯æ˜¯ threadã€‚ è¯´åˆ°çº¿ç¨‹ä¸å¾—ä¸æåˆ°â€è¿›ç¨‹â€ï¼Œä¸€ä¸ªè¿›ç¨‹ä»£è¡¨è®¡ç®—æœºä¸­å®é™…è·‘èµ·æ¥çš„ä¸€ä¸ªç¨‹åºï¼Œåœ¨ç°ä»£æ“ä½œç³»ç»Ÿçš„ä¿æŠ¤æ¨¡å¼ä¸‹" />

  <meta name="keywords" content="Hugo, blog, rubinera1n" />






<meta name="generator" content="Hugo 0.70.0" />


<link rel="canonical" href="https://blog.xiufuguo.com/post/linux/thread/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.fa3d941d1d0e0ddc985804227feabffea55c89883eb0af34e0532a7ae9135151.css" integrity="sha256-&#43;j2UHR0ODdyYWAQif&#43;q//qVciYg&#43;sK804FMqeukTUVE=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Thread" />
<meta property="og:description" content="1. çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ çº¿ç¨‹è‹±æ–‡å•è¯æ˜¯ threadã€‚ è¯´åˆ°çº¿ç¨‹ä¸å¾—ä¸æåˆ°â€è¿›ç¨‹â€ï¼Œä¸€ä¸ªè¿›ç¨‹ä»£è¡¨è®¡ç®—æœºä¸­å®é™…è·‘èµ·æ¥çš„ä¸€ä¸ªç¨‹åºï¼Œåœ¨ç°ä»£æ“ä½œç³»ç»Ÿçš„ä¿æŠ¤æ¨¡å¼ä¸‹" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.xiufuguo.com/post/linux/thread/" />
<meta property="article:published_time" content="2020-06-26T04:34:52+08:00" />
<meta property="article:modified_time" content="2020-07-05T00:23:18+08:00" />
<meta itemprop="name" content="Thread">
<meta itemprop="description" content="1. çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ çº¿ç¨‹è‹±æ–‡å•è¯æ˜¯ threadã€‚ è¯´åˆ°çº¿ç¨‹ä¸å¾—ä¸æåˆ°â€è¿›ç¨‹â€ï¼Œä¸€ä¸ªè¿›ç¨‹ä»£è¡¨è®¡ç®—æœºä¸­å®é™…è·‘èµ·æ¥çš„ä¸€ä¸ªç¨‹åºï¼Œåœ¨ç°ä»£æ“ä½œç³»ç»Ÿçš„ä¿æŠ¤æ¨¡å¼ä¸‹">
<meta itemprop="datePublished" content="2020-06-26T04:34:52&#43;08:00" />
<meta itemprop="dateModified" content="2020-07-05T00:23:18&#43;08:00" />
<meta itemprop="wordCount" content="20412">



<meta itemprop="keywords" content="linux," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Thread"/>
<meta name="twitter:description" content="1. çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ çº¿ç¨‹è‹±æ–‡å•è¯æ˜¯ threadã€‚ è¯´åˆ°çº¿ç¨‹ä¸å¾—ä¸æåˆ°â€è¿›ç¨‹â€ï¼Œä¸€ä¸ªè¿›ç¨‹ä»£è¡¨è®¡ç®—æœºä¸­å®é™…è·‘èµ·æ¥çš„ä¸€ä¸ªç¨‹åºï¼Œåœ¨ç°ä»£æ“ä½œç³»ç»Ÿçš„ä¿æŠ¤æ¨¡å¼ä¸‹"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">rubinera1n</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.xiufuguo.com/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.xiufuguo.com/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.xiufuguo.com/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.xiufuguo.com/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.xiufuguo.com/about/">About</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      rubinera1n
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.xiufuguo.com/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.xiufuguo.com/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.xiufuguo.com/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.xiufuguo.com/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://blog.xiufuguo.com/about/">About</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Thread</h1>
      
      <div class="post-meta">
        <time datetime="2020-06-26" class="post-time">
          2020-06-26
        </time>
        <div class="post-category">
            <a href="https://blog.xiufuguo.com/categories/linux/"> linux </a>
            
          </div>
        <span class="more-meta"> 20412 words </span>
          <span class="more-meta"> 41 min read </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1-çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ">1. çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ</a>
      <ul>
        <li><a href="#ä¸€ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹">ä¸€ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹</a></li>
        <li><a href="#ä¸»çº¿ç¨‹é€€å‡ºæ”¯çº¿ç¨‹ä¹Ÿå°†é€€å‡ºå—">ä¸»çº¿ç¨‹é€€å‡ºï¼Œæ”¯çº¿ç¨‹ä¹Ÿå°†é€€å‡ºå—ï¼Ÿ</a></li>
        <li><a href="#æŸä¸ªçº¿ç¨‹å´©æºƒä¼šå¯¼è‡´è¿›ç¨‹é€€å‡ºå—">æŸä¸ªçº¿ç¨‹å´©æºƒï¼Œä¼šå¯¼è‡´è¿›ç¨‹é€€å‡ºå—ï¼Ÿ</a></li>
      </ul>
    </li>
    <li><a href="#2-çº¿ç¨‹åŸºæœ¬æ“ä½œ">2. çº¿ç¨‹åŸºæœ¬æ“ä½œ</a>
      <ul>
        <li><a href="#çº¿ç¨‹çš„åˆ›å»º">çº¿ç¨‹çš„åˆ›å»º</a></li>
        <li><a href="#çº¿ç¨‹-id">çº¿ç¨‹ ID</a></li>
        <li><a href="#åˆ©ç”¨-pstack-å‘½ä»¤æ’æŸ¥-linux-è¿›ç¨‹-cpu-ä½¿ç”¨ç‡è¿‡é«˜çš„é—®é¢˜">åˆ©ç”¨ PSTACK å‘½ä»¤æ’æŸ¥ LINUX è¿›ç¨‹ CPU ä½¿ç”¨ç‡è¿‡é«˜çš„é—®é¢˜</a></li>
        <li><a href="#ç­‰å¾…çº¿ç¨‹ç»“æŸ">ç­‰å¾…çº¿ç¨‹ç»“æŸ</a></li>
      </ul>
    </li>
    <li><a href="#3-æ•´å‹å˜é‡çš„åŸå­æ“ä½œ">3. æ•´å‹å˜é‡çš„åŸå­æ“ä½œ</a>
      <ul>
        <li><a href="#ä¸ºä»€ä¹ˆæ•´å‹å˜é‡èµ‹å€¼æ“ä½œä¸æ˜¯åŸå­çš„">ä¸ºä»€ä¹ˆæ•´å‹å˜é‡èµ‹å€¼æ“ä½œä¸æ˜¯åŸå­çš„</a></li>
      </ul>
    </li>
    <li><a href="#4-linux-çº¿ç¨‹èµ„æºåŒæ­¥å¯¹è±¡">4. Linux çº¿ç¨‹èµ„æºåŒæ­¥å¯¹è±¡</a>
      <ul>
        <li><a href="#linux-äº’æ–¥ä½“">LINUX äº’æ–¥ä½“</a></li>
        <li><a href="#pthread_mutex_normalæ™®é€šé”">PTHREAD_MUTEX_NORMALï¼ˆæ™®é€šé”ï¼‰</a></li>
        <li><a href="#pthread_mutex_errorcheckæ£€é”™é”">PTHREAD_MUTEX_ERRORCHECKï¼ˆæ£€é”™é”ï¼‰</a></li>
        <li><a href="#pthread_mutex_recursiveåµŒå¥—é”">PTHREAD_MUTEX_RECURSIVEï¼ˆåµŒå¥—é”ï¼‰</a></li>
        <li><a href="#linux-çš„ä¿¡å·é‡">LINUX çš„ä¿¡å·é‡</a></li>
        <li><a href="#linux-æ¡ä»¶å˜é‡">LINUX æ¡ä»¶å˜é‡</a></li>
        <li><a href="#linux-è¯»å†™é”">LINUX è¯»å†™é”</a></li>
      </ul>
    </li>
    <li><a href="#5-å¦‚ä½•ç¡®ä¿åˆ›å»ºçš„çº¿ç¨‹ä¸€å®šè¿è¡Œèµ·æ¥">5. å¦‚ä½•ç¡®ä¿åˆ›å»ºçš„çº¿ç¨‹ä¸€å®šè¿è¡Œèµ·æ¥ï¼Ÿ</a></li>
    <li><a href="#6-é”ä½¿ç”¨å®è·µç»éªŒæ€»ç»“">6. é”ä½¿ç”¨å®è·µç»éªŒæ€»ç»“</a>
      <ul>
        <li><a href="#å‡å°‘é”çš„ä½¿ç”¨">å‡å°‘é”çš„ä½¿ç”¨</a></li>
        <li><a href="#æ˜ç¡®é”çš„èŒƒå›´">æ˜ç¡®é”çš„èŒƒå›´</a></li>
        <li><a href="#å‡å°‘é”çš„ç²’åº¦">å‡å°‘é”çš„ç²’åº¦</a></li>
        <li><a href="#é¿å…æ­»é”çš„ä¸€äº›å»ºè®®">é¿å…æ­»é”çš„ä¸€äº›å»ºè®®</a></li>
        <li><a href="#é¿å…æ´»é”çš„ä¸€äº›å»ºè®®">é¿å…æ´»é”çš„ä¸€äº›å»ºè®®</a></li>
      </ul>
    </li>
    <li><a href="#7-çº¿ç¨‹å±€éƒ¨å­˜å‚¨">7. çº¿ç¨‹å±€éƒ¨å­˜å‚¨</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="1-çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ">1. çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µ</h2>
<p>çº¿ç¨‹è‹±æ–‡å•è¯æ˜¯ <strong>thread</strong>ã€‚</p>
<p>è¯´åˆ°çº¿ç¨‹ä¸å¾—ä¸æåˆ°â€<strong>è¿›ç¨‹</strong>â€ï¼Œä¸€ä¸ªè¿›ç¨‹ä»£è¡¨è®¡ç®—æœºä¸­å®é™…è·‘èµ·æ¥çš„ä¸€ä¸ªç¨‹åºï¼Œåœ¨ç°ä»£æ“ä½œç³»ç»Ÿçš„ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªè¿›ç¨‹æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„è¿›ç¨‹åœ°å€ç©ºé—´å’Œä¸Šä¸‹æ–‡å †æ ˆã€‚ä½†æ˜¯å°±ä¸€ä¸ªç¨‹åºæœ¬èº«æ‰§è¡Œçš„æ“ä½œæ¥è¯´ï¼Œè¿›ç¨‹å…¶å®ä»€ä¹ˆä¹Ÿä¸åšï¼ˆä¸æ‰§è¡Œä»»ä½•è¿›ç¨‹ä»£ç ï¼‰ï¼Œå®ƒåªæ˜¯æä¾›ä¸€ä¸ªå¤§ç¯å¢ƒå®¹å™¨ï¼Œåœ¨è¿›ç¨‹ä¸­å®é™…çš„æ‰§è¡Œä½“æ˜¯â€çº¿ç¨‹â€ã€‚</p>
<h3 id="ä¸€ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹">ä¸€ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹</h3>
<hr>
<p>ä¸Šæ–‡ä¹Ÿè¯´äº†ï¼Œçº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­å®é™…å¹²æ´»çš„å•ä½ï¼Œå› æ­¤ä¸€ä¸ªè¿›ç¨‹è‡³å°‘å¾—æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªçº¿ç§°ä¹‹ä¸ºâ€<strong>ä¸»çº¿ç¨‹</strong>â€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>ä¸€ä¸ªè¿›ç¨‹è‡³å°‘è¦æœ‰ä¸€ä¸ªä¸»çº¿ç¨‹</strong>ã€‚</p>
<h3 id="ä¸»çº¿ç¨‹é€€å‡ºæ”¯çº¿ç¨‹ä¹Ÿå°†é€€å‡ºå—">ä¸»çº¿ç¨‹é€€å‡ºï¼Œæ”¯çº¿ç¨‹ä¹Ÿå°†é€€å‡ºå—ï¼Ÿ</h3>
<hr>
<p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸»çº¿ç¨‹é€€å‡ºï¼Œå·¥ä½œçº¿ç¨‹ä¸€èˆ¬ä¸ä¼šå—åˆ°å½±å“ï¼Œè¿˜ä¼šç»§ç»­è¿è¡Œä¸‹å»ï¼Œä½†æ˜¯æ­¤æ—¶è¿™ä¸ªè¿›ç¨‹å°±ä¼šå˜æˆæ‰€è°“çš„**åƒµå°¸è¿›ç¨‹ï¼Œ**è¿™æ˜¯ä¸€ç§ä¸å¥½çš„åšæ³•ï¼Œå®é™…å¼€å‘ä¸­åº”è¯¥é¿å…äº§ç”Ÿåƒµå°¸è¿›ç¨‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1">### ps -ef å‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿè¿›ç¨‹åˆ—è¡¨æ—¶ï¼Œå¸¦æœ‰&lt;defunct&gt;å­—æ ·çš„è¿›ç¨‹å³åƒµå°¸è¿›ç¨‹</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ps -ef</span>
UID        PID  PPID  C STIME TTY          TIME CMD
root         <span class="m">2</span>     <span class="m">0</span>  <span class="m">0</span> Jan18 ?        00:00:01 <span class="o">[</span>kthreadd<span class="o">]</span>
root         <span class="m">3</span>     <span class="m">2</span>  <span class="m">0</span> Jan18 ?        00:00:25 <span class="o">[</span>ksoftirqd/0<span class="o">]</span>
root         <span class="m">5</span>     <span class="m">2</span>  <span class="m">0</span> Jan18 ?        00:00:00 <span class="o">[</span>kworker/0:0H<span class="o">]</span>
root     <span class="m">60928</span>     <span class="m">1</span>  <span class="m">0</span> 14:48 pts/1    00:00:00 <span class="o">[</span>linuxtid<span class="o">]</span> &lt;defunct&gt;
</code></pre></td></tr></table>
</div>
</div><h3 id="æŸä¸ªçº¿ç¨‹å´©æºƒä¼šå¯¼è‡´è¿›ç¨‹é€€å‡ºå—">æŸä¸ªçº¿ç¨‹å´©æºƒï¼Œä¼šå¯¼è‡´è¿›ç¨‹é€€å‡ºå—ï¼Ÿ</h3>
<hr>
<p>è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„é¢è¯•é¢˜ï¼Œè¿˜æœ‰ä¸€ç§é—®æ³•æ˜¯ï¼š<strong>è¿›ç¨‹ä¸­æŸä¸ªçº¿ç¨‹å´©æºƒï¼Œæ˜¯å¦ä¼šå¯¹å…¶ä»–çº¿ç¨‹é€ æˆå½±å“ï¼Ÿ</strong></p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯ç‹¬ç«‹æ‰§è¡Œçš„å•ä½ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸Šä¸‹æ–‡å †æ ˆï¼Œä¸€ä¸ªçº¿ç¨‹çš„çš„å´©æºƒä¸ä¼šå¯¹å…¶ä»–çº¿ç¨‹é€ æˆå½±å“ã€‚ä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹å´©æºƒä¼šäº§ç”Ÿä¸€ä¸ªè¿›ç¨‹å†…çš„é”™è¯¯ï¼Œä¾‹å¦‚åœ¨ Linux æ“ä½œç³»ç»Ÿä¸­ï¼Œå¯èƒ½ä¼šäº§ç”Ÿä¸€ä¸ª <strong>Segment Fault</strong> é”™è¯¯ï¼Œè¿™ä¸ªé”™è¯¯ä¼šäº§ç”Ÿä¸€ä¸ªä¿¡å·ï¼Œæ“ä½œç³»ç»Ÿé»˜è®¤å¯¹è¿™ä¸ªä¿¡å·çš„å¤„ç†å°±æ˜¯ç»“æŸè¿›ç¨‹ï¼Œæ•´ä¸ªè¿›ç¨‹éƒ½è¢«é”€æ¯äº†ï¼Œè¿™æ ·çš„è¯è¿™ä¸ªè¿›ç¨‹ä¸­å­˜åœ¨çš„å…¶ä»–çº¿ç¨‹è‡ªç„¶ä¹Ÿå°±ä¸å­˜åœ¨äº†ã€‚</p>
<h2 id="2-çº¿ç¨‹åŸºæœ¬æ“ä½œ">2. çº¿ç¨‹åŸºæœ¬æ“ä½œ</h2>
<h3 id="çº¿ç¨‹çš„åˆ›å»º">çº¿ç¨‹çš„åˆ›å»º</h3>
<hr>
<p>åœ¨ä½¿ç”¨çº¿ç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å­¦ä¼šå¦‚ä½•åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚ä¸ç®¡æ˜¯å“ªä¸ªåº“é‚„æ˜¯å“ªå€‹é«˜ç´šèªè¨€ï¼ˆå¦‚ Javaï¼‰ï¼Œçº¿ç¨‹çš„åˆ›å»ºæœ€ç»ˆè¿˜æ˜¯è°ƒç”¨æ“ä½œç³»ç»Ÿçš„ <strong>API</strong> æ¥è¿›è¡Œçš„ã€‚</p>
<h4 id="linuxçº¿ç¨‹åˆ›å»º">Linuxçº¿ç¨‹åˆ›å»º</h4>
<hr>
<p>Linuxå¹³å°ä¸Šä½¿ç”¨ <strong>pthread_create</strong> é€™å€‹ <strong>API</strong> æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå…¶å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_create</span><span class="p">(</span><span class="n">pthread_t</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span>
									 <span class="k">const</span> <span class="n">pthread_attr_t</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
									 <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">start_routine</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
									 <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>å‚æ•° <strong>thread</strong>ï¼Œæ˜¯ä¸€ä¸ªè¾“å…¥å‚æ•°ï¼Œå¦‚æœçº¿ç¨‹åˆ›å»ºæˆåŠŸï¼Œé€šè¿‡è¿™ä¸ªå‚æ•°å¯ä»¥å¾—åˆ°åˆ›å»ºæˆåŠŸçš„çº¿ç¨‹ IDï¼ˆä¸‹æ–‡ä¼šä»‹ç»çº¿ç¨‹IDçš„çŸ¥è¯†ï¼‰ã€‚</p>
</li>
<li>
<p>å‚æ•° <strong>attr</strong> æŒ‡å®šäº†è¯¥çº¿ç¨‹çš„å±æ€§ï¼Œä¸€èˆ¬è®¾ç½®ä¸º NULLï¼Œè¡¨ç¤ºä½¿ç”¨é»˜è®¤å±æ€§ã€‚</p>
</li>
<li>
<p>å‚æ•° <strong>start_routine</strong> æŒ‡å®šäº†çº¿ç¨‹å‡½æ•°ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªå‡½æ•°çš„è°ƒç”¨æ–¹å¼å¿…é¡»æ˜¯ <strong>__cdecl</strong> è°ƒç”¨ï¼Œå³ <strong>C</strong> <strong>Decl</strong>aration çš„ç¼©å†™ï¼Œè¿™æ˜¯ C/C++ ä¸­å®šä¹‰å‡½æ•°æ—¶é»˜è®¤çš„è°ƒç”¨æ–¹å¼ï¼Œä¸€èˆ¬å¾ˆå°‘æœ‰äººæ³¨æ„åˆ°è¿™ä¸€ç‚¹ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚ä¸‹å‡½æ•°çš„è°ƒç”¨æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">//ä»£ç ç‰‡æ®µ1ï¼š ä¸æ˜¾å¼æŒ‡å®šå‡½æ•°è°ƒç”¨æ–¹å¼ï¼Œå…¶è°ƒç”¨æ–¹å¼ä¸ºé»˜è®¤çš„__cdecl
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">start_routine</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="c1">//ä»£ç ç‰‡æ®µ2ï¼š æ˜¾å¼æŒ‡å®šå‡½æ•°è°ƒç”¨æ–¹å¼ä¸ºé»˜è®¤çš„__cdeclï¼Œç­‰ä»·äºä»£ç ç‰‡æ®µ1
</span><span class="c1"></span><span class="kt">void</span> <span class="kr">__cdecl</span> <span class="nf">start_routine</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>å‚æ•° <strong>arg</strong>ï¼Œé€šè¿‡è¿™ä¸€å‚æ•°å¯ä»¥åœ¨åˆ›å»ºçº¿ç¨‹æ—¶å°†æŸä¸ªå‚æ•°ä¼ å…¥çº¿ç¨‹å‡½æ•°ä¸­ï¼Œç”±äºè¿™æ˜¯ä¸€ä¸ª <strong>void</strong>* ç±»å‹ï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æœ€å¤§åŒ–åœ°ä¼ å…¥ä»»æ„å¤šçš„ä¿¡æ¯ç»™çº¿ç¨‹å‡½æ•°ã€‚</p>
</li>
<li>
<p>è¿”å›å€¼ï¼šå¦‚æœæˆåŠŸåˆ›å»ºçº¿ç¨‹ï¼Œè¿”å› 0; å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œåˆ™è¿”å›å“åº”çš„é”™è¯¯ç ï¼Œå¸¸è§çš„é”™è¯¯ç æœ‰ <strong>EAGAIN</strong>ã€<strong>EINVAL</strong>ã€<strong>EPERM</strong>ã€‚</p>
</li>
</ul>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ <strong>pthread_create</strong> åˆ›å»ºçº¿ç¨‹çš„ç®€å•ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">void</span><span class="o">*</span> <span class="nf">threadfunc</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// sleep 1s
</span><span class="c1"></span>        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;I am New Thread!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">pthread_t</span> <span class="n">threadid</span><span class="p">;</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">threadfunc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="c1">// æƒå®œä¹‹è®¡ï¼Œè®©ä¸»çº¿ç¨‹ä¸è¦æå‰é€€å‡º
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="python-thread">Python Thread</h4>
<hr>
<p>æˆ‘å€‘å¯ä»¥çœ‹åˆ° Python Source Codeï¼ˆthread_pthread.hï¼‰ï¼Œå‘ç°ä¹Ÿæ˜¯è°ƒç”¨ <strong>pthread_create</strong> API å®ç°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">long</span>
<span class="nf">PyThread_start_new_thread</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span>
<span class="cp">#if defined(THREAD_STACK_SIZE) || defined(PTHREAD_SYSTEM_SCHED_SUPPORTED)
</span><span class="cp"></span>                         <span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span>
<span class="cp">#else
</span><span class="cp"></span>                         <span class="p">(</span><span class="n">pthread_attr_t</span><span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span>
<span class="cp">#endif
</span><span class="cp"></span>                         <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">))</span><span class="n">func</span><span class="p">,</span>
                         <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span>
                         <span class="p">);</span>

<span class="cp">#if defined(THREAD_STACK_SIZE) || defined(PTHREAD_SYSTEM_SCHED_SUPPORTED)
</span><span class="cp"></span>    <span class="n">pthread_attr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attrs</span><span class="p">);</span>
<span class="cp">#endif
</span><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="n">pthread_detach</span><span class="p">(</span><span class="n">th</span><span class="p">);</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="çº¿ç¨‹-id">çº¿ç¨‹ ID</h3>
<hr>
<p>ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºæˆåŠŸä»¥åï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°ä¸€ä¸ªçº¿ç¨‹ idï¼Œçº¿ç¨‹ id æ˜¯åœ¨æ•´ä¸ªæ“ä½œç³»ç»ŸèŒƒå›´å†…æ˜¯å”¯ä¸€çš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨çº¿ç¨‹ id æ¥æ ‡è¯†å’ŒåŒºåˆ†çº¿ç¨‹ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æŠŠæ‰“å°æ—¥å¿—çš„æ‰€åœ¨çš„çº¿ç¨‹ id ä¹Ÿä¸€èµ·æ‰“å°å‡ºæ¥ï¼Œè¿™æ ·ä¹Ÿæ–¹ä¾¿æˆ‘ä»¬åˆ¤æ–­å’Œæ’æŸ¥é—®é¢˜ã€‚åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œä¸Šæ–‡ä¹Ÿä»‹ç»äº†å¯ä»¥é€šè¿‡ <strong>pthread_create</strong> å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° <strong>thread</strong> ï¼ˆlinuxå¹³å°ï¼‰å¾—åˆ°çº¿ç¨‹çš„ idã€‚å¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å½“å‰è°ƒç”¨çº¿ç¨‹ä¸­è·å–å½“å‰çº¿ç¨‹çš„ idï¼Œåœ¨ Linux å¹³å°ä¸Šå¯ä»¥ä½¿ç”¨ <strong>pthread_self</strong> å‡½æ•°è·å–ï¼Œè¿™ä¸ªå‡½æ•°çš„ç­¾ååˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">pthread_t</span> <span class="nf">pthread_self</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="pstack-å‘½ä»¤">pstack å‘½ä»¤</h4>
<hr>
<p>Linux ç³»ç»Ÿä¸­å¯ä»¥é€šè¿‡ <strong>pstack</strong> å‘½ä»¤æŸ¥çœ‹ä¸€ä¸ªè¿›ç¨‹çš„çº¿ç¨‹æ•°é‡å’Œæ¯ä¸ªçº¿ç¨‹çš„è°ƒç”¨å †æ ˆæƒ…å†µã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">pstack</span> <span class="n">pid</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>pid</strong> è®¾ç½®ä¸ºè¦æŸ¥çœ‹çš„è¿›ç¨‹çš„ id å³å¯ã€‚ä»¥æˆ‘æœºå™¨ä¸Š nginx çš„ worker è¿›ç¨‹ä¸ºä¾‹ï¼Œé¦–å…ˆä½¿ç”¨ <strong>ps</strong> å‘½ä»¤æŸ¥çœ‹ä¸‹ nginx è¿›ç¨‹idï¼Œç„¶åä½¿ç”¨ <strong>pstack</strong> å³å¯æŸ¥çœ‹è¯¥è¿›ç¨‹æ¯ä¸ªçº¿ç¨‹çš„è°ƒç”¨å †æ ˆï¼ˆæˆ‘è¿™é‡Œæ¼”ç¤ºçš„ nginx åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œä¼šæ˜¾ç¤ºæ¯ä¸ªçº¿ç¨‹çš„è°ƒç”¨å †æ ˆï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">root on 127.0.0.1.16clouds.com in ~
$ ps -ef <span class="p">|</span> grep nginx
root      <span class="m">6112</span>     <span class="m">1</span>  <span class="m">0</span> Feb29 ?        00:00:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf
root     <span class="m">19971</span> <span class="m">19702</span>  <span class="m">0</span> 03:20 pts/0    00:00:00 grep --color<span class="o">=</span>auto --exclude-dir<span class="o">=</span>.bzr --exclude-dir<span class="o">=</span>CVS --exclude-dir<span class="o">=</span>.git --exclude-dir<span class="o">=</span>.hg --exclude-dir<span class="o">=</span>.svn nginx
root     <span class="m">22255</span>  <span class="m">6112</span>  <span class="m">0</span> May22 ?        00:47:20 nginx: worker process
root on 127.0.0.1.16clouds.com in ~
$ pstack <span class="m">22255</span>
<span class="c1">#0  0x00007f6a4627fe43 in __epoll_wait_nocancel () from /lib64/libc.so.6</span>
<span class="c1">#1  0x000055b2c2f84a23 in ngx_epoll_process_events ()</span>
<span class="c1">#2  0x000055b2c2f7b27a in ngx_process_events_and_timers ()</span>
<span class="c1">#3  0x000055b2c2f82f41 in ngx_worker_process_cycle ()</span>
<span class="c1">#4  0x000055b2c2f813eb in ngx_spawn_process ()</span>
<span class="c1">#5  0x000055b2c2f825f0 in ngx_start_worker_processes ()</span>
<span class="c1">#6  0x000055b2c2f83a20 in ngx_master_process_cycle ()</span>
<span class="c1">#7  0x000055b2c2f5ad0f in main ()</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ³¨æ„ï¼š<strong>pstack</strong> å‘½ä»¤æŸ¥çœ‹çš„ç¨‹åºå¿…é¡»æºå¸¦è°ƒè¯•ç¬¦å·ï¼Œä¸”æ‚¨æ‰€ä½¿ç”¨çš„ç”¨æˆ·å¿…é¡»å…·æœ‰ç›¸åº”çš„æŸ¥çœ‹æƒé™ã€‚</p>
</blockquote>
<h3 id="åˆ©ç”¨-pstack-å‘½ä»¤æ’æŸ¥-linux-è¿›ç¨‹-cpu-ä½¿ç”¨ç‡è¿‡é«˜çš„é—®é¢˜">åˆ©ç”¨ PSTACK å‘½ä»¤æ’æŸ¥ LINUX è¿›ç¨‹ CPU ä½¿ç”¨ç‡è¿‡é«˜çš„é—®é¢˜</h3>
<hr>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å»æ’æŸ¥å’Œå®šä½ä¸€ä¸ªè¿›ç¨‹ CPU å ç”¨ç‡è¿‡é«˜çš„é—®é¢˜ï¼Œå¦‚ä½•æ’æŸ¥å‘¢ï¼Ÿè¿™é‡Œå¯ä»¥ä½¿ç”¨ Linux <strong>top</strong> å’Œ <strong>pstack</strong> å‘½ä»¤ç»“åˆä½¿ç”¨æ¥æ’æŸ¥ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼š</p>
<p>æˆ‘ä»¬ä½¿ç”¨ top å‘½ä»¤å‘ç°æˆ‘ä»¬çš„æœºå™¨ä¸Šæœ‰ä¸€ä¸ªå« qmarket çš„è¿›ç¨‹ CPU ä½¿ç”¨ç‡éå¸¸é«˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://qbdu2qzd0.bkt.clouddn.com/thread_1.png" alt="avatar"></p>
<p>ä¸Šå›¾ä¸­è¿›ç¨‹ ID ä¸º <strong>4427</strong> çš„ qmarket è¿›ç¨‹å ç”¨ CPU ä½¿ç”¨ç‡è¾¾åˆ° <strong>22.8%</strong>ã€‚æˆ‘ä»¬ä½¿ç”¨ <strong>top -H</strong> å‘½ä»¤å†æ¬¡è¾“å‡ºä¸‹ç³»ç»Ÿçš„â€œè¿›ç¨‹â€åˆ—è¡¨ã€‚</p>
<blockquote>
<p>top å‘½ä»¤çš„ -H é€‰é¡¹çš„ä½œç”¨æ˜¯æ˜¾ç¤ºæ¯ä¸ªä¸€ä¸ªè¿›ç¨‹çš„å„ä¸ªçº¿ç¨‹è¿è¡ŒçŠ¶æ€ï¼ˆçº¿ç¨‹æ¨¡å¼ï¼‰ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹æ‰§è¡Œç»“æœï¼š</p>
<p><img src="http://qbdu2qzd0.bkt.clouddn.com/thread_2.png" alt="avatar"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œtop å‘½ä»¤ç¬¬ä¸€æ è™½ç„¶è¾“å‡ºè¿˜å« PIDï¼Œä½†æ­¤æ—¶æ˜¾ç¤ºçš„å®é™…æ˜¯æ¯ä¸ªçº¿ç¨‹çš„çº¿ç¨‹ IDã€‚æˆ‘ä»¬å¯ä»¥å‘ç° qmarket ç¨‹åºçš„çº¿ç¨‹å·ä¸º <strong>4429</strong>ã€<strong>4430</strong>ã€<strong>4431</strong>ã€<strong>4432</strong>ã€<strong>4433</strong>ã€<strong>4434</strong>ã€<strong>4445</strong> è¿™å‡ ä¸ªçº¿ç¨‹å ç”¨ CPU ä½¿ç”¨ç‡è¾ƒé«˜ã€‚é‚£ä¹ˆè¿™å‡ ä¸ªçº¿ç¨‹åˆ°åº•åšäº†ä»€ä¹ˆå¯¼è‡´ CPU ä½¿ç”¨ç‡é«˜å‘¢ï¼Ÿæˆ‘ä»¬ä½¿ç”¨ <strong>pstack 4427</strong> æ¥çœ‹ä¸€ä¸‹è¿™å‡ ä¸ªçº¿ç¨‹ï¼ˆ<strong>4427</strong> æ˜¯ qmarket çš„è¿›ç¨‹ IDï¼‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@127.0.0.1 ~<span class="o">]</span><span class="c1"># pstack 4427</span>
Thread <span class="m">9</span> <span class="o">(</span>Thread 0x7f315cb39700 <span class="o">(</span>LWP 4428<span class="o">))</span>:
<span class="c1">#0  0x00007f315db3d965 in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0</span>
<span class="c1">#1  0x00007f315d8dc82c in std::condition_variable::wait(std::unique_lock&lt;std::mutex&gt;&amp;) () from /lib64/libstdc++.so.6</span>
<span class="c1">#2  0x0000000000467a89 in CAsyncLog::WriteThreadProc () at ../../sourcebase/utility/AsyncLog.cpp:300</span>
<span class="c1">#3  0x0000000000469a0f in std::_Bind_simple&lt;void (*())()&gt;::_M_invoke&lt;&gt;(std::_Index_tuple&lt;&gt;) (this=0xddeb60) at /usr/include/c++/4.8.2/functional:1732</span>
<span class="c1">#4  0x0000000000469969 in std::_Bind_simple&lt;void (*())()&gt;::operator()() (this=0xddeb60) at /usr/include/c++/4.8.2/functional:1720</span>
<span class="c1">#5  0x0000000000469902 in std:ğŸ§µ:_Impl&lt;std::_Bind_simple&lt;void (*())()&gt; &gt;::_M_run() (this=0xddeb48) at /usr/include/c++/4.8.2/thread:115</span>
<span class="c1">#6  0x00007f315d8e0070 in ?? () from /lib64/libstdc++.so.6</span>
<span class="c1">#7  0x00007f315db39dd5 in start_thread () from /lib64/libpthread.so.0</span>
<span class="c1">#8  0x00007f315d043ead in clone () from /lib64/libc.so.6</span>
Thread <span class="m">8</span> <span class="o">(</span>Thread 0x7f3157fff700 <span class="o">(</span>LWP 4429<span class="o">))</span>:
<span class="c1">#0  0x00007f315d00ae2d in nanosleep () from /lib64/libc.so.6</span>
<span class="c1">#1  0x00007f315d03b704 in usleep () from /lib64/libc.so.6</span>
<span class="c1">#2  0x000000000043ed67 in CThread::SleepMs (this=0x7ffc5eed32e0, nMilliseconds=1000) at ../../sourcebase/event/Thread.cpp:106</span>
<span class="c1">#3  0x0000000000441f82 in CEventDispatcher::Run (this=0x7ffc5eed32e0) at ../../sourcebase/event/EventDispatcher.cpp:63</span>
<span class="c1">#4  0x000000000043eb33 in CThread::_ThreadEntry (pParam=0x7ffc5eed32e0) at ../../sourcebase/event/Thread.cpp:26</span>
<span class="c1">#5  0x00007f315db39dd5 in start_thread () from /lib64/libpthread.so.0</span>
<span class="c1">#6  0x00007f315d043ead in clone () from /lib64/libc.so.6</span>
Thread <span class="m">7</span> <span class="o">(</span>Thread 0x7f31573fd700 <span class="o">(</span>LWP 4430<span class="o">))</span>:
<span class="c1">#0  0x00007f315d00ae2d in nanosleep () from /lib64/libc.so.6</span>
<span class="c1">#1  0x00007f315d03b704 in usleep () from /lib64/libc.so.6</span>
<span class="c1">#2  0x000000000043ed67 in CThread::SleepMs (this=0x7f3150022390, nMilliseconds=1000) at ../../sourcebase/event/Thread.cpp:106</span>
<span class="c1">#3  0x0000000000441f82 in CEventDispatcher::Run (this=0x7f3150022390) at ../../sourcebase/event/EventDispatcher.cpp:63</span>
<span class="c1">#4  0x000000000043eb33 in CThread::_ThreadEntry (pParam=0x7f3150022390) at ../../sourcebase/event/Thread.cpp:26</span>
<span class="c1">#5  0x00007f315db39dd5 in start_thread () from /lib64/libpthread.so.0</span>
<span class="c1">#6  0x00007f315d043ead in clone () from /lib64/libc.so.6</span>
Thread <span class="m">6</span> <span class="o">(</span>Thread 0x7f3156bfc700 <span class="o">(</span>LWP 4431<span class="o">))</span>:
<span class="c1">#0  0x00007f315d00ae2d in nanosleep () from /lib64/libc.so.6</span>
<span class="c1">#1  0x00007f315d03b704 in usleep () from /lib64/libc.so.6</span>
<span class="c1">#2  0x000000000043ed67 in CThread::SleepMs (this=0x7f3150047890, nMilliseconds=1000) at ../../sourcebase/event/Thread.cpp:106</span>
<span class="c1">#3  0x0000000000441f82 in CEventDispatcher::Run (this=0x7f3150047890) at ../../sourcebase/event/EventDispatcher.cpp:63</span>
<span class="c1">#4  0x000000000043eb33 in CThread::_ThreadEntry (pParam=0x7f3150047890) at ../../sourcebase/event/Thread.cpp:26</span>
<span class="c1">#5  0x00007f315db39dd5 in start_thread () from /lib64/libpthread.so.0</span>
<span class="c1">#6  0x00007f315d043ead in clone () from /lib64/libc.so.6</span>
Thread <span class="m">5</span> <span class="o">(</span>Thread 0x7f31563fb700 <span class="o">(</span>LWP 4432<span class="o">))</span>:
<span class="c1">#0  0x00007f315d00ae2d in nanosleep () from /lib64/libc.so.6</span>
<span class="c1">#1  0x00007f315d03b704 in usleep () from /lib64/libc.so.6</span>
<span class="c1">#2  0x000000000043ed67 in CThread::SleepMs (this=0x7f3148041fd8, nMilliseconds=1000) at ../../sourcebase/event/Thread.cpp:106</span>
<span class="c1">#3  0x0000000000441f82 in CEventDispatcher::Run (this=0x7f3148041fd8) at ../../sourcebase/event/EventDispatcher.cpp:63</span>
<span class="c1">#4  0x000000000043eb33 in CThread::_ThreadEntry (pParam=0x7f3148041fd8) at ../../sourcebase/event/Thread.cpp:26</span>
<span class="c1">#5  0x00007f315db39dd5 in start_thread () from /lib64/libpthread.so.0</span>
<span class="c1">#6  0x00007f315d043ead in clone () from /lib64/libc.so.6</span>
Thread <span class="m">4</span> <span class="o">(</span>Thread 0x7f3155bfa700 <span class="o">(</span>LWP 4433<span class="o">))</span>:
<span class="c1">#0  0x00007f315d00ae2d in nanosleep () from /lib64/libc.so.6</span>
<span class="c1">#1  0x00007f315d03b704 in usleep () from /lib64/libc.so.6</span>
<span class="c1">#2  0x000000000043ed67 in CThread::SleepMs (this=0x7f3148052620, nMilliseconds=1000) at ../../sourcebase/event/Thread.cpp:106</span>
<span class="c1">#3  0x0000000000441f82 in CEventDispatcher::Run (this=0x7f3148052620) at ../../sourcebase/event/EventDispatcher.cpp:63</span>
<span class="c1">#4  0x000000000043eb33 in CThread::_ThreadEntry (pParam=0x7f3148052620) at ../../sourcebase/event/Thread.cpp:26</span>
<span class="c1">#5  0x00007f315db39dd5 in start_thread () from /lib64/libpthread.so.0</span>
<span class="c1">#6  0x00007f315d043ead in clone () from /lib64/libc.so.6</span>
Thread <span class="m">3</span> <span class="o">(</span>Thread 0x7f31553f9700 <span class="o">(</span>LWP 4434<span class="o">))</span>:
<span class="c1">#0  0x00007f315d00ae2d in nanosleep () from /lib64/libc.so.6</span>
<span class="c1">#1  0x00007f315d03b704 in usleep () from /lib64/libc.so.6</span>
<span class="c1">#2  0x000000000043ed67 in CThread::SleepMs (this=0x7f3148062ee0, nMilliseconds=1000) at ../../sourcebase/event/Thread.cpp:106</span>
<span class="c1">#3  0x0000000000441f82 in CEventDispatcher::Run (this=0x7f3148062ee0) at ../../sourcebase/event/EventDispatcher.cpp:63</span>
<span class="c1">#4  0x000000000043eb33 in CThread::_ThreadEntry (pParam=0x7f3148062ee0) at ../../sourcebase/event/Thread.cpp:26</span>
<span class="c1">#5  0x00007f315db39dd5 in start_thread () from /lib64/libpthread.so.0</span>
<span class="c1">#6  0x00007f315d043ead in clone () from /lib64/libc.so.6</span>
Thread <span class="m">2</span> <span class="o">(</span>Thread 0x7f3154bf8700 <span class="o">(</span>LWP 4445<span class="o">))</span>:
<span class="c1">#0  0x00007f315d00ae2d in nanosleep () from /lib64/libc.so.6</span>
<span class="c1">#1  0x00007f315d03b704 in usleep () from /lib64/libc.so.6</span>
<span class="c1">#2  0x000000000043ed67 in CThread::SleepMs (this=0x7f3150001b00, nMilliseconds=1000) at ../../sourcebase/event/Thread.cpp:106</span>
<span class="c1">#3  0x0000000000441f82 in CEventDispatcher::Run (this=0x7f3150001b00) at ../../sourcebase/event/EventDispatcher.cpp:63</span>
<span class="c1">#4  0x000000000043eb33 in CThread::_ThreadEntry (pParam=0x7f3150001b00) at ../../sourcebase/event/Thread.cpp:26</span>
<span class="c1">#5  0x00007f315db39dd5 in start_thread () from /lib64/libpthread.so.0</span>
<span class="c1">#6  0x00007f315d043ead in clone () from /lib64/libc.so.6</span>
Thread <span class="m">1</span> <span class="o">(</span>Thread 0x7f315f2ca3c0 <span class="o">(</span>LWP 4427<span class="o">))</span>:
<span class="c1">#0  0x00007f315db3af47 in pthread_join () from /lib64/libpthread.so.0</span>
<span class="c1">#1  0x000000000043edc7 in CThread::Join (this=0x7ffc5eed32e0) at ../../sourcebase/event/Thread.cpp:130</span>
<span class="c1">#2  0x000000000040cc61 in main (argc=1, argv=0x7ffc5eed3668) at ../../sourceapp/qmarket/qmarket.cpp:309</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ pstack è¾“å‡ºçš„å„ä¸ªçº¿ç¨‹ä¸­ï¼Œåªè¦é€ä¸€å¯¹ç…§æˆ‘ä»¬çš„ç¨‹åºæºç æ¥æ¢³ç†ä¸‹è¯¥çº¿ç¨‹ä¸­æ˜¯å¦æœ‰å¤§å¤šæ•°æ—¶é—´éƒ½å¤„äºç©ºè½¬çš„é€»è¾‘ï¼Œç„¶åä¿®æ”¹å’Œä¼˜åŒ–è¿™äº›é€»è¾‘å°±å¯ä»¥è§£å†³ CPU ä½¿ç”¨ç‡è¿‡é«˜çš„é—®é¢˜äº†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸å·¥ä½œçš„çº¿ç¨‹åº”å°½é‡ä½¿ç”¨é”å¯¹è±¡è®©å…¶æŒ‚èµ·ï¼Œè€Œä¸æ˜¯ç©ºè½¬ï¼Œè¿™æ ·å¯ä»¥æé«˜ç³»ç»Ÿèµ„æºåˆ©ç”¨ç‡ã€‚</p>
<h4 id="linux-ç³»ç»Ÿçº¿ç¨‹-id-çš„æœ¬è´¨">Linux ç³»ç»Ÿçº¿ç¨‹ ID çš„æœ¬è´¨</h4>
<hr>
<p>æ–¹æ³•ä¸€ï¼š</p>
<p>è°ƒç”¨ <strong>pthread_create</strong> å‡½æ•°æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°åœ¨å‡½æ•°è°ƒç”¨æˆåŠŸåå¯ä»¥å¾—åˆ°çº¿ç¨‹ IDï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">pthread_t</span> <span class="n">tid</span><span class="p">;</span>
<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">thread_proc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>æ–¹æ³•äºŒï¼š</p>
<p>åœ¨éœ€è¦è·å– ID çš„çº¿ç¨‹ä¸­è°ƒç”¨ <strong>pthread_self()</strong> å‡½æ•°è·å–ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">pthread_t</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">pthread_self</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><p>æ–¹æ³•ä¸‰ï¼š</p>
<p>é€šè¿‡ç³»ç»Ÿè°ƒç”¨è·å–çº¿ç¨‹ ID</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">syscall</span><span class="p">(</span><span class="n">SYS_gettid</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>æ–¹æ³•ä¸€</strong>å’Œ<strong>æ–¹æ³•äºŒ</strong>è·å–çš„çº¿ç¨‹ ID ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œè¿™æ˜¯ä¸€ä¸ª <strong>pthread_t</strong>ï¼Œè¾“å‡ºæ—¶æœ¬è´¨ä¸Šæ˜¯ä¸€å—å†…å­˜ç©ºé—´åœ°å€ã€‚</p>
<p>ç”±äºä¸åŒçš„è¿›ç¨‹å¯èƒ½æœ‰åŒæ ·åœ°å€çš„å†…å­˜å—ï¼Œå› æ­¤<strong>æ–¹æ³•ä¸€</strong>å’Œ<strong>æ–¹æ³•äºŒ</strong>è·å–çš„çº¿ç¨‹ ID å¯èƒ½ä¸æ˜¯å…¨ç³»ç»Ÿå”¯ä¸€çš„ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°å­—ï¼ˆå†…å­˜åœ°å€ï¼‰ã€‚è€Œ<strong>æ–¹æ³•ä¸‰</strong>è·å–çš„çº¿ç¨‹ ID æ˜¯ ç³»ç»ŸèŒƒå›´å†…å…¨å±€å”¯ä¸€çš„ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªä¸ä¼šå¤ªå¤§çš„æ•´æ•°ï¼Œè¿™ä¸ªæ•°å­—ä¹Ÿæ˜¯å°±æ˜¯æ‰€è°“çš„ LWP ï¼ˆLight Weight Processï¼Œè½»é‡çº§è¿›ç¨‹ï¼Œæ—©æœŸçš„ Linux ç³»ç»Ÿçš„çº¿ç¨‹æ˜¯é€šè¿‡è¿›ç¨‹æ¥å®ç°çš„ï¼Œè¿™ç§çº¿ç¨‹è¢«ç§°ä¸ºè½»é‡çº§çº¿ç¨‹ï¼‰çš„ IDã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€æ®µå…·ä½“çš„ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">void</span><span class="o">*</span> <span class="nf">thread_proc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pthread_t</span><span class="o">*</span> <span class="n">tid1</span> <span class="o">=</span> <span class="p">(</span><span class="n">pthread_t</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tid2</span> <span class="o">=</span> <span class="n">syscall</span><span class="p">(</span><span class="n">SYS_gettid</span><span class="p">);</span>
	<span class="n">pthread_t</span> <span class="n">tid3</span> <span class="o">=</span> <span class="n">pthread_self</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
  <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;tid1: %ld, tid2: %ld, tid3: %ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">tid1</span><span class="p">,</span> <span class="n">tid2</span><span class="p">,</span> <span class="n">tid3</span><span class="p">);</span>
		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">pthread_t</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">thread_proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">pthread_join</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç åœ¨æ–°å¼€çš„çº¿ç¨‹ä¸­ä½¿ç”¨ä¸Šé¢ä»‹ç»çš„ä¸‰ç§æ–¹å¼è·å–çº¿ç¨‹ IDï¼Œå¹¶æ‰“å°å‡ºæ¥ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">tid1: 140185007511296, tid2: 60837, tid3: <span class="m">140185007511296</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>tid2</strong> å³ LWP çš„ IDï¼Œè€Œ <strong>tid1</strong> å’Œ <strong>tid3</strong> æ˜¯ä¸€ä¸ªå†…å­˜åœ°å€ï¼Œè½¬æ¢æˆ 16 è¿›åˆ¶å³ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">0x7F7F5D935700
</code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸æˆ‘ä»¬ç”¨ pstack å‘½ä»¤çœ‹åˆ°çš„çº¿ç¨‹ ID æ˜¯ä¸€æ ·çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ps -efL | grep linuxtid</span>
root     <span class="m">60712</span> <span class="m">60363</span> <span class="m">60712</span>  <span class="m">0</span>    <span class="m">2</span> 13:25 pts/1    00:00:00 ./linuxtid
root     <span class="m">60712</span> <span class="m">60363</span> <span class="m">60713</span>  <span class="m">0</span>    <span class="m">2</span> 13:25 pts/1    00:00:00 ./linuxtid
root     <span class="m">60720</span> <span class="m">60364</span> <span class="m">60720</span>  <span class="m">0</span>    <span class="m">1</span> 13:25 pts/3    00:00:00 grep --color<span class="o">=</span>auto linuxtid
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># pstack 60712</span>
Thread <span class="m">2</span> <span class="o">(</span>Thread 0x7fd897a50700 <span class="o">(</span>LWP 60713<span class="o">))</span>:
<span class="c1">#0  0x00007fd897b15e2d in nanosleep () from /lib64/libc.so.6</span>
<span class="c1">#1  0x00007fd897b15cc4 in sleep () from /lib64/libc.so.6</span>
<span class="c1">#2  0x0000000000400746 in thread_proc (arg=0x7fff390921c8) at linuxtid.cpp:15</span>
<span class="c1">#3  0x00007fd898644dd5 in start_thread () from /lib64/libpthread.so.0</span>
<span class="c1">#4  0x00007fd897b4eead in clone () from /lib64/libc.so.6</span>
Thread <span class="m">1</span> <span class="o">(</span>Thread 0x7fd898a6e740 <span class="o">(</span>LWP 60712<span class="o">))</span>:
<span class="c1">#0  0x00007fd898645f47 in pthread_join () from /lib64/libpthread.so.0</span>
<span class="c1">#1  0x000000000040077e in main () at linuxtid.cpp:25</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ps -ef | grep linuxtid</span>
root     <span class="m">60838</span> <span class="m">60363</span>  <span class="m">0</span> 14:27 pts/1    00:00:00 ./linuxtid
root     <span class="m">60846</span> <span class="m">60364</span>  <span class="m">0</span> 14:28 pts/3    00:00:00 grep --color<span class="o">=</span>auto linuxtid
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># pstack 60838</span>
Thread <span class="m">2</span> <span class="o">(</span>Thread 0x7f7f5d935700 <span class="o">(</span>LWP 60839<span class="o">))</span>:
<span class="c1">#0  0x00007f7f5d9fae2d in nanosleep () from /lib64/libc.so.6</span>
<span class="c1">#1  0x00007f7f5d9facc4 in sleep () from /lib64/libc.so.6</span>
<span class="c1">#2  0x0000000000400746 in thread_proc (arg=0x7fff0523ae68) at linuxtid.cpp:15</span>
<span class="c1">#3  0x00007f7f5e529dd5 in start_thread () from /lib64/libpthread.so.0</span>
<span class="c1">#4  0x00007f7f5da33ead in clone () from /lib64/libc.so.6</span>
Thread <span class="m">1</span> <span class="o">(</span>Thread 0x7f7f5e953740 <span class="o">(</span>LWP 60838<span class="o">))</span>:
<span class="c1">#0  0x00007f7f5e52af47 in pthread_join () from /lib64/libpthread.so.0</span>
<span class="c1">#1  0x000000000040077e in main () at linuxtid.cpp:25</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="ç­‰å¾…çº¿ç¨‹ç»“æŸ">ç­‰å¾…çº¿ç¨‹ç»“æŸ</h3>
<p>å®é™…é¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šæœ‰è¿™æ ·ä¸€ç§éœ€æ±‚ï¼Œå³ä¸€ä¸ªçº¿ç¨‹éœ€è¦ç­‰å¾…å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡é€€å‡ºåå†ç»§ç»­æ‰§è¡Œã€‚è¿™åœ¨ Linux æ“ä½œç³»ç»Ÿä¸­éƒ½æä¾›äº†ç›¸åº”çš„æ“ä½œç³»ç»Ÿ APIï¼Œæˆ‘ä»¬æ¥åˆ†åˆ«ä»‹ç»ä¸€ä¸‹ã€‚</p>
<h4 id="linux-ä¸‹ç­‰å¾…çº¿ç¨‹ç»“æŸ">Linux ä¸‹ç­‰å¾…çº¿ç¨‹ç»“æŸ</h4>
<hr>
<p>Linux çº¿ç¨‹åº“æä¾›äº† <strong>pthread_join</strong> å‡½æ•°ï¼Œç”¨æ¥ç­‰å¾…æŸçº¿ç¨‹çš„é€€å‡ºå¹¶æ¥æ”¶å®ƒçš„è¿”å›å€¼ã€‚è¿™ç§æ“ä½œè¢«ç§°ä¸º<strong>è¿æ¥</strong>ï¼ˆjoiningï¼‰ï¼Œ<strong>pthread_join</strong> å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_join</span><span class="p">(</span><span class="n">pthread_t</span> <span class="kr">thread</span><span class="p">,</span> <span class="kt">void</span><span class="o">**</span> <span class="n">retval</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>å‚æ•° <strong>thread</strong>ï¼Œéœ€è¦ç­‰å¾…çš„çº¿ç¨‹ idã€‚</li>
<li>å‚æ•° <strong>retval</strong>ï¼Œè¾“å‡ºå‚æ•°ï¼Œç”¨äºæ¥æ”¶ç­‰å¾…é€€å‡ºçš„çº¿ç¨‹çš„é€€å‡ºç ï¼ˆ<strong>Exit Code</strong>ï¼‰ï¼Œçº¿ç¨‹é€€å‡ºç å¯ä»¥é€šè¿‡è°ƒç”¨ <strong>pthread_exit</strong> é€€å‡ºçº¿ç¨‹æ—¶æŒ‡å®šï¼Œä¹Ÿå¯ä»¥åœ¨çº¿ç¨‹å‡½æ•°ä¸­é€šè¿‡ <strong>return</strong> è¯­å¥è¿”å›ã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">void</span> <span class="nf">pthread_exit</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">value_ptr</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>å‚æ•° <strong>value_ptr</strong> çš„å€¼å¯ä»¥åœ¨ <strong>pthread_join</strong> ä¸­æ‹¿åˆ°ï¼Œæ²¡æœ‰å¯ä»¥è®¾ç½®ä¸º NULLã€‚</p>
<p><strong>pthread_join å‡½æ•°ç­‰å¾…å…¶ä»–çº¿ç¨‹é€€å‡ºæœŸé—´ä¼šæŒ‚èµ·ç­‰å¾…çš„çº¿ç¨‹</strong>ï¼Œè¢«æŒ‚èµ·çš„çº¿ç¨‹ä¸ä¼šæ¶ˆè€—å®è´µä»»ä½•CPUæ—¶é—´ç‰‡ã€‚ç›´åˆ°ç›®æ ‡çº¿ç¨‹é€€å‡ºåï¼Œç­‰å¾…çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®ä¾‹æ¥æ¼”ç¤ºä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ï¼Œå®ä¾‹åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<p>ç¨‹åºå¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå·¥ä½œçº¿ç¨‹å°†å½“å‰ç³»ç»Ÿæ—¶é—´å†™å…¥æ–‡ä»¶ä¸­åé€€å‡ºï¼Œä¸»çº¿ç¨‹ç­‰å¾…å·¥ä½œçº¿ç¨‹é€€å‡ºåï¼Œä»æ–‡ä»¶ä¸­è¯»å–å‡ºæ—¶é—´å¹¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define TIME_FILENAME &#34;time.txt&#34;
</span><span class="cp"></span>
<span class="kt">void</span><span class="o">*</span> <span class="nf">fileThreadFunc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">time_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tm</span><span class="o">*</span> <span class="n">t</span> <span class="o">=</span> <span class="n">localtime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">timeStr</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">timeStr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&#34;%04d/%02d/%02d %02d:%02d:%02d&#34;</span><span class="p">,</span>
			 <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_year</span><span class="o">+</span><span class="mi">1900</span><span class="p">,</span>
			 <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_mon</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
			 <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_mday</span><span class="p">,</span>
			 <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_hour</span><span class="p">,</span>
			 <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_min</span><span class="p">,</span>
			 <span class="n">t</span><span class="o">-&gt;</span><span class="n">tm_sec</span><span class="p">);</span>
	<span class="c1">//æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºï¼›å­˜åœ¨ï¼Œåˆ™è¦†ç›–ã€‚
</span><span class="c1"></span>	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">TIME_FILENAME</span><span class="p">,</span> <span class="s">&#34;w&#34;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
	  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Failed to create time.txt.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

  <span class="n">size_t</span> <span class="n">sizeToWrite</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">timeStr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">size_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">timeStr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sizeToWrite</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">sizeToWrite</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Write file error.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">pthread_t</span> <span class="n">fileThreadID</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fileThreadID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">fileThreadFunc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Failed to create fileThread.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
	  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

  <span class="kt">int</span><span class="o">*</span> <span class="n">retval</span><span class="p">;</span>
  <span class="n">pthread_join</span><span class="p">(</span><span class="n">fileThreadID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">retval</span><span class="p">);</span>

	<span class="c1">//ä½¿ç”¨ré€‰é¡¹ï¼Œè¦æ±‚æ–‡ä»¶å¿…é¡»å­˜åœ¨
</span><span class="c1"></span>	<span class="n">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">TIME_FILENAME</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
	    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;open file error.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
	    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">sizeRead</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sizeRead</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;read file error.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
	  <span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Current Time is: %s.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç¨‹åºæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@localhost threadtest<span class="o">]</span><span class="c1"># ./test</span>
Current Time is: 2018/09/24 21:06:01.
</code></pre></td></tr></table>
</div>
</div><h2 id="3-æ•´å‹å˜é‡çš„åŸå­æ“ä½œ">3. æ•´å‹å˜é‡çš„åŸå­æ“ä½œ</h2>
<h3 id="ä¸ºä»€ä¹ˆæ•´å‹å˜é‡èµ‹å€¼æ“ä½œä¸æ˜¯åŸå­çš„">ä¸ºä»€ä¹ˆæ•´å‹å˜é‡èµ‹å€¼æ“ä½œä¸æ˜¯åŸå­çš„</h3>
<hr>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆæ•´å‹å˜é‡çš„æ“ä½œä¸æ˜¯åŸå­æ€§çš„å‘¢ï¼Ÿå¸¸è§çš„æ•´å‹å˜é‡æ“ä½œæœ‰å¦‚ä¸‹å‡ ç§æƒ…å†µï¼š</p>
<ul>
<li>ç»™æ•´å‹å˜é‡èµ‹å€¼ä¸€ä¸ªç¡®å®šçš„å€¼ï¼Œå¦‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ¡æŒ‡ä»¤æ“ä½œä¸€èˆ¬æ˜¯åŸå­çš„ï¼Œå› ä¸ºå¯¹åº”ç€ä¸€æ¡è®¡ç®—æœºæŒ‡ä»¤ï¼ŒCPU å°†ç«‹å³æ•° 1 æ¬è¿åˆ°å˜é‡ <strong>a</strong> çš„å†…å­˜åœ°å€ä¸­å³å¯ï¼Œæ±‡ç¼–æŒ‡ä»¤å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="mi">2</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åè¿™ç¡®æ˜¯æœ€ä¸å¸¸è§çš„æƒ…å½¢ï¼Œç”±äºç°ä»£ç¼–è¯‘å™¨ä¸€èˆ¬å­˜åœ¨ä¼˜åŒ–ç­–ç•¥ï¼Œå¦‚æœå˜é‡ <strong>a</strong> çš„å€¼åœ¨ç¼–è¯‘æœŸé—´å°±å¯ä»¥è®¡ç®—å‡ºæ¥ï¼ˆä¾‹å¦‚è¿™é‡Œçš„ä¾‹å­ä¸­ <strong>a</strong> çš„å€¼å°±æ˜¯<strong>1</strong>ï¼‰ï¼Œé‚£ä¹ˆ <strong>a</strong> è¿™ä¸ªå˜é‡æœ¬èº«åœ¨æ­£å¼ç‰ˆæœ¬çš„è½¯ä»¶ä¸­ï¼ˆreleaseç‰ˆï¼‰å°±å¾ˆæœ‰å¯èƒ½è¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰ï¼Œå‡¡æ˜¯ä½¿ç”¨ <strong>a</strong> çš„åœ°æ–¹ï¼Œç›´æ¥ä½¿ç”¨å¸¸é‡ <strong>1</strong> æ¥ä»£æ›¿ã€‚æ‰€ä»¥å®é™…çš„æ‰§è¡ŒæŒ‡ä»¤ä¸­ï¼Œè¿™æ ·çš„æŒ‡ä»¤å­˜åœ¨çš„å¯èƒ½æ€§æ¯”è¾ƒä½ã€‚</p>
<ul>
<li>å˜é‡è‡ªèº«å¢åŠ æˆ–è€…å‡å»ä¸€ä¸ªå€¼ï¼Œå¦‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">a</span><span class="o">++</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>ä» C/C++ è¯­æ³•çš„çº§åˆ«æ¥çœ‹ï¼Œè¿™æ˜¯ä¸€æ¡è¯­å¥ï¼Œæ˜¯åŸå­çš„ï¼›ä½†æ˜¯ä»å®é™…æ‰§è¡Œçš„äºŒè¿›åˆ¶æŒ‡ä»¤æ¥çœ‹ï¼Œä¹Ÿä¸æ˜¯åŸå­çš„ï¼Œå…¶ä¸€èˆ¬å¯¹åº”ä¸‰æ¡æŒ‡ä»¤ï¼Œé¦–å…ˆå°†å˜é‡ <strong>a</strong> å¯¹åº”çš„å†…å­˜å€¼æ¬è¿åˆ°æŸä¸ªå¯„å­˜å™¨ï¼ˆå¦‚ <strong>eax</strong> ï¼‰ä¸­ï¼Œç„¶åå°†è¯¥å¯„å­˜å™¨ä¸­çš„å€¼è‡ªå¢ <strong>1</strong>ï¼Œå†å°†è¯¥å¯„å­˜å™¨ä¸­çš„å€¼æ¬è¿å› <strong>a</strong> ä»£è¡¨çš„å†…å­˜ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
<span class="n">inc</span> <span class="n">eax</span>
<span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">eax</span>
</code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨å‡è®¾ <strong>a</strong> çš„å€¼æ˜¯0ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹å˜é‡ <strong>a</strong> çš„å€¼é€’å¢ <strong>1</strong>ï¼Œæˆ‘ä»¬é¢„æƒ³çš„ç»“æœåº”è¯¥æ˜¯ <strong>2</strong>ï¼Œå¯å®é™…è¿è¡Œçš„ç»“æœå¯èƒ½æ˜¯ <strong>1</strong>ï¼æ˜¯ä¸æ˜¯å¾ˆå¥‡æ€ªï¼Ÿåˆ†æå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">//çº¿ç¨‹1
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">thread_func1</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">a</span> <span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//çº¿ç¨‹2
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">thread_func2</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">a</span> <span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="http://qbdu2qzd0.bkt.clouddn.com/thread_3.png" alt="avatar"></p>
<p>æˆ‘ä»¬é¢„æƒ³çš„ç»“æœæ˜¯<strong>çº¿ç¨‹ 1</strong> å’Œ<strong>çº¿ç¨‹ 2</strong> çš„ä¸‰æ¡æŒ‡ä»¤å„è‡ªæ‰§è¡Œï¼Œ<em><em>æœ€ç»ˆ *<em>a</em></em> çš„å€¼å˜ä¸º <strong>2</strong>ï¼Œä½†æ˜¯ç”±äºæ“ä½œç³»ç»Ÿçº¿ç¨‹è°ƒåº¦çš„ä¸ç¡®å®šæ€§ï¼Œ<strong>çº¿ç¨‹ 1</strong> æ‰§è¡Œå®ŒæŒ‡ä»¤â‘ å’Œâ‘¡åï¼Œ<strong>eax</strong> å¯„å­˜å™¨ä¸­çš„å€¼å˜ä¸º <strong>1</strong>ï¼Œæ­¤æ—¶æ“ä½œç³»ç»Ÿåˆ‡æ¢åˆ° <strong>çº¿ç¨‹2</strong> æ‰§è¡Œï¼Œæ‰§è¡ŒæŒ‡ä»¤â‘¢â‘£â‘¤ï¼Œæ­¤æ—¶ <strong>eax</strong> çš„å€¼å˜ä¸º</em><em>1</em>*ï¼›æ¥ç€æ“ä½œç³»ç»Ÿåˆ‡å›**çº¿ç¨‹ 1 **ç»§ç»­æ‰§è¡Œï¼Œæ‰§è¡ŒæŒ‡ä»¤â‘¦ï¼Œå¾—åˆ° *****a** çš„æœ€ç»ˆç»“æœ **1**ã€‚</p>
<ul>
<li>æŠŠä¸€ä¸ªå˜é‡çš„å€¼èµ‹å€¼ç»™å¦å¤–ä¸€ä¸ªå˜é‡ï¼Œæˆ–è€…æŠŠä¸€ä¸ªè¡¨è¾¾å¼çš„å€¼èµ‹å€¼ç»™å¦å¤–ä¸€ä¸ªå˜é‡ï¼Œå¦‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>ä» C/C++ è¯­æ³•çš„çº§åˆ«æ¥çœ‹ï¼Œè¿™æ˜¯ä¹Ÿæ˜¯ä¸€æ¡è¯­å¥ï¼Œæ˜¯åŸå­çš„ï¼›ä½†æ˜¯ä»å®é™…æ‰§è¡Œçš„äºŒè¿›åˆ¶æŒ‡ä»¤æ¥çœ‹ï¼Œç”±äºç°ä»£è®¡ç®—æœºCPUæ¶æ„ä½“ç³»çš„é™åˆ¶ï¼Œæ•°æ®ä¸å¯ä»¥ç›´æ¥ä»å†…å­˜æ¬è¿åˆ°å¦å¤–ä¸€å—å†…å­˜ï¼Œå¿…é¡»å€ŸåŠ©å¯„å­˜å™¨ä¸­æ–­ï¼Œè¿™æ¡è¯­å¥ä¸€èˆ¬å¯¹åº”ä¸¤æ¡è®¡ç®—æœºæŒ‡ä»¤ï¼Œå³å°†å˜é‡ <strong>b</strong> çš„å€¼æ¬è¿åˆ°æŸä¸ªå¯„å­˜å™¨ï¼ˆå¦‚<strong>eax</strong>ï¼‰ä¸­ï¼Œå†ä»è¯¥å¯„å­˜å™¨æ¬è¿åˆ°å˜é‡ <strong>a</strong> çš„å†…å­˜åœ°å€ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span>
<span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">eax</span>
</code></pre></td></tr></table>
</div>
</div><p>æ—¢ç„¶æ˜¯ä¸¤æ¡æŒ‡ä»¤ï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œè¿™ä¸¤æ¡æŒ‡ä»¤æ—¶ï¼ŒæŸä¸ªçº¿ç¨‹å¯èƒ½ä¼šåœ¨ç¬¬ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•åè¢«å‰¥å¤º CPU æ—¶é—´ç‰‡ï¼Œåˆ‡æ¢åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹è€Œäº§ç”Ÿä¸ç¡®å®šçš„æƒ…å†µã€‚è¿™å’Œä¸Šä¸€ç§æƒ…å†µç±»ä¼¼ï¼Œå°±ä¸å†è¯¦ç»†åˆ†æäº†ã€‚</p>
<p>è¯´ç‚¹é¢˜å¤–è¯ï¼Œç½‘ä¸Šå¾ˆå¤šäººå¼ºè°ƒæŸäº›ç‰¹æ®Šçš„æ•´å‹æ•°å€¼ç±»å‹ï¼ˆå¦‚ bool ç±»å‹ï¼‰çš„æ“ä½œæ˜¯åŸå­çš„ï¼Œè¿™æ˜¯ç”±äºï¼ŒæŸäº› CPU ç”Ÿäº§å•†å¼€å§‹æœ‰æ„è¯†åœ°ä»ç¡¬ä»¶å¹³å°ä¿è¯è¿™ä¸€ç±»æ“ä½œçš„åŸå­æ€§ï¼Œä½†è¿™å¹¶ä¸æ˜¯æ¯ä¸€ç§ç±»å‹çš„ CPU æ¶æ„éƒ½æ”¯æŒï¼Œåœ¨è¿™ä¸€äº‹å®æˆä¸ºæ ‡å‡†ä¹‹å‰ï¼Œæˆ‘ä»¬åœ¨å¤šçº¿ç¨‹æ“ä½œæ•´å‹æ—¶è¿˜æ˜¯è€è€å®å®ä½¿ç”¨ä¸‹æ–‡ä»‹ç»çš„åŸå­æ“ä½œæˆ–çº¿ç¨‹åŒæ­¥æŠ€æœ¯æ¥å¯¹è¿™äº›æ•°æ®ç±»å‹è¿›è¡Œä¿æŠ¤ã€‚</p>
<h2 id="4-linux-çº¿ç¨‹èµ„æºåŒæ­¥å¯¹è±¡">4. Linux çº¿ç¨‹èµ„æºåŒæ­¥å¯¹è±¡</h2>
<h3 id="linux-äº’æ–¥ä½“">LINUX äº’æ–¥ä½“</h3>
<hr>
<p>Linux äº’æ–¥ä½“çš„ç”¨æ³•ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡é™åˆ¶å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡ŒæŸæ®µä»£ç æ¥è¾¾åˆ°ä¿æŠ¤èµ„æºçš„ç›®çš„ã€‚å’Œæ¥ä¸‹æ¥è¦ä»‹ç»çš„ä¿¡å·é‡ã€æ¡ä»¶å˜é‡ä¸€æ ·ï¼ŒLinux äº’æ–¥ä½“éƒ½å®ç°åœ¨ NPTL ï¼ˆNative POSIX Thread Libraryï¼‰ã€‚åœ¨ NPTL ä¸­æˆ‘ä»¬ä½¿ç”¨æ•°æ®ç»“æ„ <strong>pthread_mutex_t</strong> æ¥è¡¨ç¤ºä¸€ä¸ªäº’æ–¥ä½“å¯¹è±¡ï¼ˆå®šä¹‰äº <strong>pthread.h</strong> å¤´æ–‡ä»¶ä¸­ï¼‰ã€‚äº’æ–¥ä½“å¯¹è±¡æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹å¼æ¥åˆå§‹åŒ–ï¼š</p>
<ul>
<li>ä½¿ç”¨ <strong>PTHREAD_MUTEX_INITIALIZER</strong> ç›´æ¥ç»™äº’æ–¥ä½“å˜é‡èµ‹å€¼</li>
</ul>
<p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="n">pthread_mutex_t</span> <span class="n">mymutex</span> <span class="o">=</span> <span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>ä½¿ç”¨ <strong>pthread_mutex_init</strong> å‡½æ•°åˆå§‹åŒ–</li>
</ul>
<p>å¦‚æœäº’æ–¥é‡æ˜¯åŠ¨æ€åˆ†é…çš„æˆ–è€…éœ€è¦ç»™äº’æ–¥é‡è®¾ç½®å±æ€§ï¼Œåˆ™éœ€è¦ä½¿ç”¨ <strong>pthread_mutex_init</strong> å‡½æ•°æ¥åˆå§‹åŒ–äº’æ–¥ä½“ï¼Œè¿™ä¸ªå‡½æ•°çš„ç­¾åå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_mutex_init</span><span class="p">(</span><span class="n">pthread_mutex_t</span><span class="o">*</span> <span class="kr">restrict</span> <span class="n">mutex</span><span class="p">,</span>
					   <span class="k">const</span> <span class="n">pthread_mutexattr_t</span><span class="o">*</span> <span class="kr">restrict</span> <span class="n">attr</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>å‚æ•° <strong>mutex</strong> å³æˆ‘ä»¬éœ€è¦åˆå§‹åŒ–çš„ mutex å¯¹è±¡çš„æŒ‡é’ˆï¼Œå‚æ•° <strong>attr</strong> æ˜¯éœ€è¦è®¾ç½®çš„äº’æ–¥ä½“å±æ€§ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨é»˜è®¤å±æ€§å¯ä»¥å°†è¿™ä¸ªå‚æ•°è®¾ç½®ä¸º NULLï¼Œåé¢æˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç»æ¯ä¸€ç§å±æ€§çš„ç”¨æ³•ã€‚ <strong>pthread_mutex_init</strong> ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">pthread_mutex_t</span> <span class="n">mymutex</span><span class="p">;</span>
<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>å½“æˆ‘ä»¬ä¸å†éœ€è¦ä¸€ä¸ªäº’æ–¥ä½“å¯¹è±¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <strong>pthread_mutex_destroy</strong> å‡½æ•°æ¥é”€æ¯å®ƒï¼Œ <strong>pthread_mutex_destroy</strong> å‡½æ•°çš„ç­¾åå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_mutex_destroy</span><span class="p">(</span><span class="n">pthread_mutex_t</span><span class="o">*</span> <span class="n">mutex</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>å‚æ•° <strong>mutex</strong> å³æˆ‘ä»¬éœ€è¦é”€æ¯çš„äº’æ–¥ä½“å¯¹è±¡ï¼Œå¦‚æœå‡½æ•°æ‰§è¡ŒæˆåŠŸä¼šè¿”å› 0ï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ç è¡¨é¢å‡ºé”™åŸå› ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š</p>
<ul>
<li><strong>ä½¿ç”¨ PTHREAD_MUTEX_INITIALIZER åˆå§‹åŒ–çš„äº’æ–¥é‡æ— é¡»é”€æ¯</strong>ï¼›</li>
<li><strong>ä¸è¦å»é”€æ¯ä¸€ä¸ªå·²ç»åŠ é”æˆ–æ­£åœ¨è¢«æ¡ä»¶å˜é‡ä½¿ç”¨çš„äº’æ–¥ä½“å¯¹è±¡</strong>ï¼Œå½“äº’æ–¥é‡å¤„äºå·²åŠ é”çš„çŠ¶æ€æˆ–è€…æ­£åœ¨å’Œæ¡ä»¶å˜é‡é…åˆä½¿ç”¨æ—¶ï¼Œè°ƒç”¨ pthread_mutex_destroy å‡½æ•°ä¼šè¿”å› EBUSY é”™è¯¯ç ã€‚å½“ç„¶ï¼Œè¿™ä¸æ˜¯ç»å¯¹çš„ï¼Œä¸åŒçš„ Linux æ“ä½œç³»ç»Ÿå¯¹è¿™ä¸ªå‡½æ•°çš„å®ç°å¯èƒ½ä¸åŒï¼Œå› æ­¤å…¶è¡Œä¸ºå’Œè¿”å›ç»“æœå¯èƒ½ä¹Ÿä¸ä¸€æ ·ã€‚ç¬”è€…åœ¨ CentOS 7.0 å’Œ Ubuntu 18.10 ä¸Šæµ‹è¯•ä¸‹é¢çš„ä»£ç ï¼Œç»“æœä¸ä¸€æ ·ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">pthread_mutex_t</span> <span class="n">mymutex</span><span class="p">;</span>
	<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EBUSY</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;EBUSY</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Failed to destroy mutex.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Succeed to destroy mutex.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ç”±äºä¸åŒæ“ä½œç³»ç»Ÿï¼Œå¯¹ mutex å¯¹è±¡ç›¸å…³å‡½æ•°çš„è¡Œä¸ºç»“æœè¡¨ç°ä¸åŒï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå¦‚æœæˆ‘ä»¬éµå¾ªä¸€å®šçš„ä½¿ç”¨è§„èŒƒï¼ˆå¦‚åˆ›å»º mutex å¯¹è±¡åï¼Œå†å¯¹å…¶åŠ é”ï¼ŒåŠ é”åæ‰å¯¹å…¶è¿›è¡Œè§£é”æ“ä½œï¼Œè§£é”åæ‰é”€æ¯ï¼‰ï¼Œé‚£ä¹ˆç¼–ç æ—¶æˆ‘ä»¬ä¸€èˆ¬ä¸ç”¨è€ƒè™‘ <strong>pthread_mutex_init</strong>/<strong>pthread_mutex_destroy</strong>/<strong>pthread_mutex_lock</strong>/<strong>pthread_mutex_unlock</strong> ç­‰å‡½æ•°çš„è¿”å›å€¼ã€‚</p>
</blockquote>
<p>å¯¹äºäº’æ–¥ä½“çš„åŠ é”å’Œè§£é”æ“ä½œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ä»¥ä¸‹ä¸‰ä¸ªå‡½æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="n">pthread_mutex_t</span><span class="o">*</span> <span class="n">mutex</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_mutex_trylock</span><span class="p">(</span><span class="n">pthread_mutex_t</span><span class="o">*</span> <span class="n">mutex</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="n">pthread_mutex_t</span><span class="o">*</span> <span class="n">mutex</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>å‚æ•° <strong>mutex</strong> è®¾ç½®ä¸ºæˆ‘ä»¬éœ€è¦åŠ é”å’Œè§£é”çš„äº’æ–¥ä½“å¯¹è±¡ï¼Œä¸Šè¿°å‡½æ•°æ‰§è¡ŒæˆåŠŸè¿”å› 0ï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥åˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ç è¡¨ç¤ºå…·ä½“çš„å‡ºé”™åŸå› ã€‚å…·ä½“é”™è¯¯ç ï¼Œéšäº’æ–¥ä½“å¯¹è±¡çš„å±æ€§ç±»å‹çš„ä¸åŒè€Œä¸åŒã€‚</p>
<p>è®¾ç½®äº’æ–¥ä½“å¯¹è±¡çš„å±æ€§éœ€è¦åˆ›å»ºä¸€ä¸ª pthread_mutexattr_t ç±»å‹çš„å¯¹è±¡ï¼Œå’Œäº’æ–¥ä½“å¯¹è±¡ä¸€æ ·ï¼Œéœ€è¦ä½¿ç”¨ pthread_mutexattr_init å‡½æ•°åˆå§‹åŒ–ä¹‹ï¼Œå½“ä¸éœ€è¦è¿™ä¸ªå±æ€§å¯¹è±¡æ—¶ï¼Œè®°å¾—ä½¿ç”¨ pthread_mutexattr_destroy å»é”€æ¯å®ƒï¼Œè¿™ä¸¤ä¸ªå‡½æ•°çš„ç­¾åå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_mutexattr_init</span><span class="p">(</span><span class="n">pthread_mutexattr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_mutexattr_destroy</span><span class="p">(</span><span class="n">pthread_mutexattr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨ <strong>pthread_mutexattr_settype</strong>/<strong>pthread_mutexattr_gettype</strong> è®¾ç½®æˆ–è·å–ä½ æƒ³è¦çš„å±æ€§ç±»å‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_mutexattr_settype</span><span class="p">(</span><span class="n">pthread_mutexattr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_mutexattr_gettype</span><span class="p">(</span><span class="k">const</span> <span class="n">pthread_mutexattr_t</span><span class="o">*</span> <span class="kr">restrict</span> <span class="n">attr</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="kr">restrict</span> <span class="n">type</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>å±æ€§ç±»å‹ä¸€èˆ¬æœ‰å¦‚ä¸‹å–å€¼ï¼š</p>
<h3 id="pthread_mutex_normalæ™®é€šé”">PTHREAD_MUTEX_NORMALï¼ˆæ™®é€šé”ï¼‰</h3>
<hr>
<p>è¿™æ˜¯äº’æ–¥ä½“å¯¹è±¡çš„é»˜è®¤å±æ€§ï¼ˆå³ä¸Šæ–‡ä¸­ä»‹ç»çš„ <strong>pthread_mutex_init</strong> ç¬¬äºŒä¸ªå‡½æ•°è®¾ç½®ä¸º NULLï¼‰ã€‚å½“ä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªæ™®é€šé”åŠ é”ä»¥åï¼Œå…¶ä»–çº¿ç¨‹ä¼šé˜»å¡åœ¨ <strong>pthread_mutex_lock</strong> è°ƒç”¨å¤„ï¼Œ ç›´åˆ°å¯¹äº’æ–¥ä½“åŠ é”çš„çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œæˆ‘ä»¬æ¥ç”¨ä¸€æ®µå®ä¾‹ä»£ç æ¥éªŒè¯ä¸€ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">pthread_mutex_t</span> <span class="n">mymutex</span><span class="p">;</span>
<span class="kt">int</span>             <span class="n">resourceNo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">worker_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pthread_t</span> <span class="n">threadID</span> <span class="o">=</span> <span class="n">pthread_self</span><span class="p">();</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;thread start, ThreadID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">threadID</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>

		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Mutex lock, resourceNo: %d, ThreadID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">resourceNo</span><span class="p">,</span> <span class="n">threadID</span><span class="p">);</span>
		<span class="n">resourceNo</span><span class="o">++</span><span class="p">;</span>

		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Mutex unlock, resourceNo: %d, ThreadID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">resourceNo</span><span class="p">,</span> <span class="n">threadID</span><span class="p">);</span>

		<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>

		<span class="c1">//ä¼‘çœ 1ç§’
</span><span class="c1"></span>		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">pthread_mutexattr_t</span> <span class="n">mutex_attr</span><span class="p">;</span>
	<span class="n">pthread_mutexattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">);</span>
	<span class="n">pthread_mutexattr_settype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">,</span> <span class="n">PTHREAD_MUTEX_NORMAL</span><span class="p">);</span>
	<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">);</span>

	<span class="c1">//åˆ›å»º5ä¸ªå·¥ä½œçº¿ç¨‹
</span><span class="c1"></span>	<span class="n">pthread_t</span> <span class="n">threadID</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">worker_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_join</span><span class="p">(</span><span class="n">threadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
	<span class="n">pthread_mutexattr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç åˆ›å»ºäº†äº”ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œç”±äºä½¿ç”¨äº†äº’æ–¥ä½“ä¿æŠ¤èµ„æº <strong>resourceNo</strong>ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨ <strong>pthread_mutex_lock</strong> ä¸ <strong>pthread_mutex_unlock</strong> ä¹‹é—´çš„è¾“å‡ºéƒ½æ˜¯è¿ç»­çš„ï¼Œä¸€ä¸ªçº¿ç¨‹å¿…é¡»å®Œæˆäº†è¿™ä¸ªå·¥ä½œï¼Œå…¶ä»–çº¿ç¨‹æ‰æœ‰æœºä¼šè·å¾—æ‰§è¡Œè¿™æ®µä»£ç çš„æœºä¼šï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°é”åï¼Œå…¶ä»–çº¿ç¨‹ä¼šé˜»å¡åœ¨ <strong>pthread_mutex_lock</strong> å¤„ã€‚</p>
<p>ç¨‹åºæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># ./test</span>
thread start, ThreadID: <span class="m">520349440</span>
Mutex lock, resourceNo: 0, ThreadID: <span class="m">520349440</span>
Mutex unlock, resourceNo: 1, ThreadID: <span class="m">520349440</span>
thread start, ThreadID: <span class="m">545527552</span>
Mutex lock, resourceNo: 1, ThreadID: <span class="m">545527552</span>
Mutex unlock, resourceNo: 2, ThreadID: <span class="m">545527552</span>
thread start, ThreadID: <span class="m">511956736</span>
Mutex lock, resourceNo: 2, ThreadID: <span class="m">511956736</span>
Mutex unlock, resourceNo: 3, ThreadID: <span class="m">511956736</span>
thread start, ThreadID: <span class="m">537134848</span>
Mutex lock, resourceNo: 3, ThreadID: <span class="m">537134848</span>
Mutex unlock, resourceNo: 4, ThreadID: <span class="m">537134848</span>
thread start, ThreadID: <span class="m">528742144</span>
Mutex lock, resourceNo: 4, ThreadID: <span class="m">528742144</span>
Mutex unlock, resourceNo: 5, ThreadID: <span class="m">528742144</span>
Mutex lock, resourceNo: 5, ThreadID: <span class="m">545527552</span>
Mutex unlock, resourceNo: 6, ThreadID: <span class="m">545527552</span>
Mutex lock, resourceNo: 6, ThreadID: <span class="m">537134848</span>
Mutex unlock, resourceNo: 7, ThreadID: <span class="m">537134848</span>
Mutex lock, resourceNo: 7, ThreadID: <span class="m">528742144</span>
Mutex unlock, resourceNo: 8, ThreadID: <span class="m">528742144</span>
Mutex lock, resourceNo: 8, ThreadID: <span class="m">520349440</span>
Mutex unlock, resourceNo: 9, ThreadID: <span class="m">520349440</span>
Mutex lock, resourceNo: 9, ThreadID: <span class="m">511956736</span>
Mutex unlock, resourceNo: 10, ThreadID: <span class="m">511956736</span>
Mutex lock, resourceNo: 10, ThreadID: <span class="m">545527552</span>
Mutex unlock, resourceNo: 11, ThreadID: <span class="m">545527552</span>
Mutex lock, resourceNo: 11, ThreadID: <span class="m">537134848</span>
Mutex unlock, resourceNo: 12, ThreadID: <span class="m">537134848</span>
Mutex lock, resourceNo: 12, ThreadID: <span class="m">520349440</span>
Mutex unlock, resourceNo: 13, ThreadID: <span class="m">520349440</span>
Mutex lock, resourceNo: 13, ThreadID: <span class="m">528742144</span>
Mutex unlock, resourceNo: 14, ThreadID: <span class="m">528742144</span>
Mutex lock, resourceNo: 14, ThreadID: <span class="m">511956736</span>
Mutex unlock, resourceNo: 15, ThreadID: <span class="m">511956736</span>
Mutex lock, resourceNo: 15, ThreadID: <span class="m">528742144</span>
Mutex unlock, resourceNo: 16, ThreadID: <span class="m">528742144</span>
Mutex lock, resourceNo: 16, ThreadID: <span class="m">545527552</span>
Mutex unlock, resourceNo: 17, ThreadID: <span class="m">545527552</span>
Mutex lock, resourceNo: 17, ThreadID: <span class="m">520349440</span>
Mutex unlock, resourceNo: 18, ThreadID: <span class="m">520349440</span>
Mutex lock, resourceNo: 18, ThreadID: <span class="m">537134848</span>
Mutex unlock, resourceNo: 19, ThreadID: <span class="m">537134848</span>
Mutex lock, resourceNo: 19, ThreadID: <span class="m">511956736</span>
Mutex unlock, resourceNo: 20, ThreadID: <span class="m">511956736</span>
Mutex lock, resourceNo: 20, ThreadID: <span class="m">545527552</span>
Mutex unlock, resourceNo: 21, ThreadID: <span class="m">545527552</span>
Mutex lock, resourceNo: 21, ThreadID: <span class="m">528742144</span>
Mutex unlock, resourceNo: 22, ThreadID: <span class="m">528742144</span>
Mutex lock, resourceNo: 22, ThreadID: <span class="m">520349440</span>
Mutex unlock, resourceNo: 23, ThreadID: <span class="m">520349440</span>
Mutex lock, resourceNo: 23, ThreadID: <span class="m">537134848</span>
Mutex unlock, resourceNo: 24, ThreadID: <span class="m">537134848</span>
Mutex lock, resourceNo: 24, ThreadID: <span class="m">511956736</span>
Mutex unlock, resourceNo: 25, ThreadID: <span class="m">511956736</span>
Mutex lock, resourceNo: 25, ThreadID: <span class="m">528742144</span>
Mutex unlock, resourceNo: 26, ThreadID: <span class="m">528742144</span>
Mutex lock, resourceNo: 26, ThreadID: <span class="m">545527552</span>
Mutex unlock, resourceNo: 27, ThreadID: <span class="m">545527552</span>
Mutex lock, resourceNo: 27, ThreadID: <span class="m">520349440</span>
Mutex unlock, resourceNo: 28, ThreadID: <span class="m">520349440</span>
Mutex lock, resourceNo: 28, ThreadID: <span class="m">511956736</span>
Mutex unlock, resourceNo: 29, ThreadID: <span class="m">511956736</span>
Mutex lock, resourceNo: 29, ThreadID: <span class="m">537134848</span>
Mutex unlock, resourceNo: 30, ThreadID: <span class="m">537134848</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸€ä¸ªçº¿ç¨‹å¦‚æœå¯¹ä¸€ä¸ªå·²ç»åŠ é”çš„æ™®é€šé”å†æ¬¡ä½¿ç”¨ pthread_mutex_lock åŠ é”ï¼Œç¨‹åºä¼šé˜»å¡åœ¨ç¬¬äºŒæ¬¡è°ƒç”¨ pthread_mutex_lock ä»£ç å¤„ã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">pthread_mutex_t</span> <span class="n">mymutex</span><span class="p">;</span>
	<span class="n">pthread_mutexattr_t</span> <span class="n">mutex_attr</span><span class="p">;</span>
	<span class="n">pthread_mutexattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">);</span>
	<span class="n">pthread_mutexattr_settype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">,</span> <span class="n">PTHREAD_MUTEX_NORMAL</span><span class="p">);</span>
	<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;ret = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;ret = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
	<span class="n">pthread_mutexattr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç¼–è¯‘å¹¶ä½¿ç”¨ gdb å°†ç¨‹åºè¿è¡Œèµ·æ¥ï¼Œç¨‹åºåªè¾“å‡ºäº†ä¸€è¡Œï¼Œæˆ‘ä»¬æŒ‰ Ctrl + C ï¼ˆä¸‹æ–‡ä¸­ ^C å­—ç¬¦ï¼‰å°† gdb ä¸­æ–­ä¸‹æ¥ï¼Œç„¶åä½¿ç”¨ bt å‘½ä»¤å‘ç°ç¨‹åºç¡®å®é˜»å¡åœ¨ç¬¬äºŒä¸ª <strong>pthread_mutex_lock</strong> å‡½æ•°è°ƒç”¨å¤„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># g++ -g -o test test.cpp -lpthread</span>
<span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># gdb test</span>
Reading symbols from /root/testmultithread/test...done.
<span class="o">(</span>gdb<span class="o">)</span> r
Starting program: /root/testmultithread/test
<span class="o">[</span>Thread debugging using libthread_db enabled<span class="o">]</span>
Using host libthread_db library <span class="s2">&#34;/lib64/libthread_db.so.1&#34;</span>.
<span class="nv">ret</span> <span class="o">=</span> <span class="m">0</span>
^C
Program received signal SIGINT, Interrupt.
0x00007ffff7bcd4ed in __lll_lock_wait <span class="o">()</span> from /lib64/libpthread.so.0
Missing separate debuginfos, use: debuginfo-install glibc-2.17-260.el7.x86_64 libgcc-4.8.5-36.el7.x86_64 libstdc++-4.8.5-36.el7.x86_64
<span class="o">(</span>gdb<span class="o">)</span> bt
<span class="c1">#0  0x00007ffff7bcd4ed in __lll_lock_wait () from /lib64/libpthread.so.0</span>
<span class="c1">#1  0x00007ffff7bc8dcb in _L_lock_883 () from /lib64/libpthread.so.0</span>
<span class="c1">#2  0x00007ffff7bc8c98 in pthread_mutex_lock () from /lib64/libpthread.so.0</span>
<span class="c1">#3  0x00000000004007f4 in main () at ConsoleApplication10.cpp:17</span>
<span class="o">(</span>gdb<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨è¿™ç§ç±»å‹çš„æƒ…å†µï¼Œ <strong>pthread_mutex_trylock</strong> å‡½æ•°å¦‚æœæ‹¿ä¸åˆ°é”ï¼Œä¸ä¼šé˜»å¡ï¼Œå‡½æ•°ä¼šç«‹å³è¿”å›ï¼Œå¹¶è¿”å› <strong>EBUSY</strong> é”™è¯¯ç ã€‚</p>
<h3 id="pthread_mutex_errorcheckæ£€é”™é”">PTHREAD_MUTEX_ERRORCHECKï¼ˆæ£€é”™é”ï¼‰</h3>
<hr>
<p>å¦‚æœä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ <strong>pthread_mutex_lock</strong> å¯¹å·²ç»åŠ é”çš„äº’æ–¥ä½“å¯¹è±¡å†æ¬¡åŠ é”ï¼Œ<strong>pthread_mutex_lock</strong> ä¼šè¿”å› <strong>EDEADLK</strong>ã€‚</p>
<p>æˆ‘ä»¬éªŒè¯ä¸€ä¸‹çº¿ç¨‹å¯¹è‡ªå·±å·²ç»åŠ é”çš„äº’æ–¥ä½“å¯¹è±¡å†æ¬¡åŠ é”æ˜¯ä»€ä¹ˆè¡Œä¸ºï¼Ÿ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">pthread_mutex_t</span> <span class="n">mymutex</span><span class="p">;</span>
	<span class="n">pthread_mutexattr_t</span> <span class="n">mutex_attr</span><span class="p">;</span>
	<span class="n">pthread_mutexattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">);</span>
	<span class="n">pthread_mutexattr_settype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">,</span> <span class="n">PTHREAD_MUTEX_ERRORCHECK</span><span class="p">);</span>
	<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;ret = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;ret = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">EDEADLK</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;EDEADLK</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
	<span class="n">pthread_mutexattr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç¼–è¯‘å¹¶è¿è¡Œç¨‹åºï¼Œç¨‹åºè¾“å‡ºç»“æœç¡®å®å¦‚ä¸Šé¢æ‰€è¯´ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># g++ -g -o test11 test.cpp -lpthread</span>
<span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># ./test11</span>
<span class="nv">ret</span> <span class="o">=</span> <span class="m">0</span>
<span class="nv">ret</span> <span class="o">=</span> <span class="m">35</span>
EDEADLK
</code></pre></td></tr></table>
</div>
</div><p>å†æ¥çœ‹ä¸€ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹åŠ é”ï¼Œå…¶ä»–çº¿ç¨‹å†æ¬¡åŠ é”çš„æ•ˆæœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">pthread_mutex_t</span> <span class="n">mymutex</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">worker_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pthread_t</span> <span class="n">threadID</span> <span class="o">=</span> <span class="n">pthread_self</span><span class="p">();</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;thread start, ThreadID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">threadID</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">EDEADLK</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;EDEADLK, ThreadID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">threadID</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&#34;ret = %d, ThreadID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">threadID</span><span class="p">);</span>

		<span class="c1">//ä¼‘çœ 1ç§’
</span><span class="c1"></span>		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">pthread_mutexattr_t</span> <span class="n">mutex_attr</span><span class="p">;</span>
	<span class="n">pthread_mutexattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">);</span>
	<span class="n">pthread_mutexattr_settype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">,</span> <span class="n">PTHREAD_MUTEX_ERRORCHECK</span><span class="p">);</span>
	<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;ret = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="c1">//åˆ›å»º5ä¸ªå·¥ä½œçº¿ç¨‹
</span><span class="c1"></span>	<span class="n">pthread_t</span> <span class="n">threadID</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">worker_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_join</span><span class="p">(</span><span class="n">threadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
	<span class="n">pthread_mutexattr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_attr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç¼–è¯‘ç¨‹åºï¼Œç„¶åä½¿ç”¨ gdb è¿è¡Œèµ·æ¥ï¼Œå‘ç°ç¨‹åºå¹¶æ²¡æœ‰æœ‰ä»»ä½•è¾“å‡ºï¼ŒæŒ‰ Ctrl + C ä¸­æ–­ä¸‹æ¥ï¼Œè¾“å…¥ <strong>info thread</strong> å‘½ä»¤å‘ç°å·¥ä½œçº¿ç¨‹å‡é˜»å¡åœ¨ <strong>pthread_mutex_lock</strong> å‡½æ•°è°ƒç”¨å¤„ã€‚æ“ä½œåŠè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># g++ -g -o test8 ConsoleApplication8.cpp -lpthread</span>
<span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># ./test8</span>
<span class="nv">ret</span> <span class="o">=</span> <span class="m">0</span>
thread start, ThreadID: -1821989120
thread start, ThreadID: -1830381824
thread start, ThreadID: -1838774528
thread start, ThreadID: -1847167232
thread start, ThreadID: -1813596416
^C
<span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># gdb test8</span>
GNU gdb <span class="o">(</span>GDB<span class="o">)</span> Red Hat Enterprise Linux 7.6.1-114.el7
Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2013</span> Free Software Foundation, Inc.
License GPLv3+: GNU GPL version <span class="m">3</span> or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type <span class="s2">&#34;show copying&#34;</span>
and <span class="s2">&#34;show warranty&#34;</span> <span class="k">for</span> details.
This GDB was configured as <span class="s2">&#34;x86_64-redhat-linux-gnu&#34;</span>.
For bug reporting instructions, please see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;...
Reading symbols from /root/testmultithread/test8...done.
<span class="o">(</span>gdb<span class="o">)</span> r
Starting program: /root/testmultithread/test8
<span class="o">[</span>Thread debugging using libthread_db enabled<span class="o">]</span>
Using host libthread_db library <span class="s2">&#34;/lib64/libthread_db.so.1&#34;</span>.
<span class="nv">ret</span> <span class="o">=</span> <span class="m">0</span>
<span class="o">[</span>New Thread 0x7ffff6fd2700 <span class="o">(</span>LWP 3276<span class="o">)]</span>
thread start, ThreadID: -151181568
<span class="o">[</span>New Thread 0x7ffff67d1700 <span class="o">(</span>LWP 3277<span class="o">)]</span>
thread start, ThreadID: -159574272
<span class="o">[</span>New Thread 0x7ffff5fd0700 <span class="o">(</span>LWP 3278<span class="o">)]</span>
thread start, ThreadID: -167966976
<span class="o">[</span>New Thread 0x7ffff57cf700 <span class="o">(</span>LWP 3279<span class="o">)]</span>
thread start, ThreadID: -176359680
<span class="o">[</span>New Thread 0x7ffff4fce700 <span class="o">(</span>LWP 3280<span class="o">)]</span>
thread start, ThreadID: -184752384
^C
Program received signal SIGINT, Interrupt.
0x00007ffff7bc7f47 in pthread_join <span class="o">()</span> from /lib64/libpthread.so.0
Missing separate debuginfos, use: debuginfo-install glibc-2.17-260.el7.x86_64 libgcc-4.8.5-36.el7.x86_64 libstdc++-4.8.5-36.el7.x86_64
<span class="o">(</span>gdb<span class="o">)</span> bt
<span class="c1">#0  0x00007ffff7bc7f47 in pthread_join () from /lib64/libpthread.so.0</span>
<span class="c1">#1  0x00000000004009e9 in main () at ConsoleApplication8.cpp:50</span>
<span class="o">(</span>gdb<span class="o">)</span> inf threads
  Id   Target Id         Frame
  <span class="m">6</span>    Thread 0x7ffff4fce700 <span class="o">(</span>LWP 3280<span class="o">)</span> <span class="s2">&#34;test8&#34;</span> 0x00007ffff7bcd4ed in __lll_lock_wait <span class="o">()</span> from /lib64/libpthread.so.0
  <span class="m">5</span>    Thread 0x7ffff57cf700 <span class="o">(</span>LWP 3279<span class="o">)</span> <span class="s2">&#34;test8&#34;</span> 0x00007ffff7bcd4ed in __lll_lock_wait <span class="o">()</span> from /lib64/libpthread.so.0
  <span class="m">4</span>    Thread 0x7ffff5fd0700 <span class="o">(</span>LWP 3278<span class="o">)</span> <span class="s2">&#34;test8&#34;</span> 0x00007ffff7bcd4ed in __lll_lock_wait <span class="o">()</span> from /lib64/libpthread.so.0
  <span class="m">3</span>    Thread 0x7ffff67d1700 <span class="o">(</span>LWP 3277<span class="o">)</span> <span class="s2">&#34;test8&#34;</span> 0x00007ffff7bcd4ed in __lll_lock_wait <span class="o">()</span> from /lib64/libpthread.so.0
  <span class="m">2</span>    Thread 0x7ffff6fd2700 <span class="o">(</span>LWP 3276<span class="o">)</span> <span class="s2">&#34;test8&#34;</span> 0x00007ffff7bcd4ed in __lll_lock_wait <span class="o">()</span> from /lib64/libpthread.so.0
* <span class="m">1</span>    Thread 0x7ffff7fee740 <span class="o">(</span>LWP 3272<span class="o">)</span> <span class="s2">&#34;test8&#34;</span> 0x00007ffff7bc7f47 in pthread_join <span class="o">()</span> from /lib64/libpthread.so.0
<span class="o">(</span>gdb<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡ä¸Šé¢çš„å®éªŒï¼Œå¦‚æœäº’æ–¥ä½“çš„å±æ€§æ˜¯ <strong>PTHREAD_MUTEX_ERRORCHECK</strong>ï¼Œå½“å‰çº¿ç¨‹é‡å¤è°ƒç”¨ <strong>pthread_mutex_lock</strong> ä¼šç›´æ¥è¿”å› <strong>EDEADLOCK</strong>ï¼Œå…¶ä»–çº¿ç¨‹å¦‚æœå¯¹è¿™ä¸ªäº’æ–¥ä½“å†æ¬¡è°ƒç”¨ <strong>pthread_mutex_lock</strong> ä¼šé˜»å¡åœ¨è¯¥å‡½æ•°çš„è°ƒç”¨å¤„ã€‚</p>
<h3 id="pthread_mutex_recursiveåµŒå¥—é”">PTHREAD_MUTEX_RECURSIVEï¼ˆåµŒå¥—é”ï¼‰</h3>
<hr>
<ul>
<li>è¯¥å±æ€§å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹å…¶æŒæœ‰çš„äº’æ–¥ä½“é‡å¤åŠ é”ï¼Œæ¯æ¬¡æˆåŠŸè°ƒç”¨ <strong>pthread_mutex_lock</strong> ä¸€æ¬¡ï¼Œè¯¥äº’æ–¥ä½“å¯¹è±¡çš„é”å¼•ç”¨è®¡æ•°å°±ä¼šå¢åŠ ä¸€æ¬¡ï¼Œç›¸åï¼Œæ¯æ¬¡æˆåŠŸè°ƒç”¨ <strong>pthread_mutex_unlock</strong> ä¸€æ¬¡ï¼Œé”å¼•ç”¨è®¡æ•°å°±ä¼šå‡å°‘ä¸€æ¬¡ï¼Œå½“é”å¼•ç”¨è®¡æ•°å€¼ä¸º 0 æ—¶å…è®¸å…¶ä»–çº¿ç¨‹è·å¾—è¯¥é”ï¼Œå¦åˆ™å…¶ä»–çº¿ç¨‹è°ƒç”¨ <strong>pthread_mutex_lock</strong> æ—¶å°è¯•è·å–é”æ—¶ï¼Œä¼šé˜»å¡åœ¨é‚£é‡Œã€‚è¿™ç§æ–¹å¼å¾ˆå¥½ç†è§£ï¼Œè¿™é‡Œå°±ä¸è´´ç¤ºä¾‹ä»£ç äº†ã€‚</li>
</ul>
<p>æˆ‘ä»¬æ¥æ€»ç»“ä¸‹ Linux ä¸‹çš„äº’æ–¥ä½“å¯¹è±¡çš„ä½¿ç”¨è¦ç‚¹ï¼š</p>
<ul>
<li>è™½ç„¶æˆ‘åœ¨ä¸Šæ–‡æ¼”ç¤ºäº†åŒä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªäº’æ–¥ä½“å¯¹è±¡åå¤è¿›è¡ŒåŠ é”ï¼Œä½†å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°è¿™ç§åœºæ™¯çš„æƒ…å½¢éå¸¸å°‘ã€‚</li>
<li>ä¸ Windows çš„ä¸´ç•ŒåŒºå¯¹è±¡ä¸€æ ·ï¼Œä¸€äº›æœ‰å¾ˆå¤šå‡ºå£çš„é€»è¾‘ä¸­ï¼Œä¸ºäº†é¿å…å› å¿˜è®°è°ƒç”¨ <strong>pthread_mutex_lock</strong> å‡ºç°æ­»é”æˆ–è€…åœ¨é€»è¾‘å‡ºå£å¤„æœ‰å¤§é‡è§£é”çš„é‡å¤ä»£ç å‡ºç°ï¼Œå»ºè®®ä½¿ç”¨ RAII æŠ€æœ¯å°†äº’æ–¥ä½“å¯¹è±¡å°è£…èµ·æ¥ï¼Œå…·ä½“æ–¹å¼æˆ‘åœ¨ä¸Šæ–‡ä¸­å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</li>
</ul>
<h3 id="linux-çš„ä¿¡å·é‡">LINUX çš„ä¿¡å·é‡</h3>
<hr>
<p>ä¸ Windows çš„ Semaphore å¯¹è±¡ä½¿ç”¨åŸç†ä¸€æ ·ï¼ŒLinux çš„ä¿¡å·é‡æœ¬è´¨ä¸Šä¹Ÿæ˜¯æš—å«ç€â€œèµ„æºæœ‰å¤šä»½ï¼Œå¯ä»¥åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®â€çš„æ„å‘³ï¼Œæ•…ä¿¡å·é‡çš„åŸç†è¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<p>Linux ä¿¡å·é‡å¸¸ç”¨çš„ä¸€ç»„ API å‡½æ•°æ˜¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;semaphore.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="kt">int</span> <span class="nf">sem_init</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">sem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pshared</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">sem_destroy</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">sem</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">sem_post</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">sem</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">sem_wait</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">sem</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">sem_trywait</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">sem</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">sem_timedwait</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">sem</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span><span class="o">*</span> <span class="n">abs_timeout</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>å‡½æ•° <strong>sem_init</strong> ç”¨äºåˆå§‹åŒ–ä¸€ä¸ªä¿¡å·é‡ï¼Œç¬¬ä¸€ä¸ªå‚æ•° <strong>sem</strong> ä¼ å…¥éœ€è¦åˆå§‹åŒ–çš„ä¿¡å·é‡å¯¹è±¡çš„åœ°å€ï¼›ç¬¬äºŒä¸ªå‚æ•° <strong>pshared</strong> è¡¨ç¤ºè¯¥ä¿¡å·é‡æ˜¯å¦å¯ä»¥è¢«åˆå§‹åŒ–è¯¥ä¿¡å·é‡çš„è¿›ç¨‹ fork å‡ºæ¥çš„å­è¿›ç¨‹å…±äº«ï¼Œå–å€¼ä¸º 0 ï¼ˆä¸å¯ä»¥å…±äº«ï¼‰ï¼Œ1 ï¼ˆå¯ä»¥å…±äº«ï¼‰ï¼›ç¬¬ä¸‰ä¸ªå‚æ•° <strong>value</strong> ç”¨äºè®¾ç½®ä¿¡å·é‡åˆå§‹çŠ¶æ€ä¸‹èµ„æºçš„æ•°é‡ã€‚å‡½æ•° <strong>sem_init</strong> å‡½æ•°è°ƒç”¨æˆåŠŸè¿”å› 0ï¼Œ å¤±è´¥è¿”å› -1ï¼Œå®é™…ç¼–ç ä¸­åªè¦æˆ‘ä»¬çš„å†™æ³•å¾—å½“ä¸€èˆ¬ä¸å…³å¿ƒè¯¥å‡½æ•°çš„è¿”å›å€¼ã€‚</li>
<li>å‡½æ•° <strong>sem_destroy</strong> ç”¨äºé”€æ¯ä¸€ä¸ªä¿¡å·é‡ã€‚</li>
<li>å‡½æ•° <strong>sem_post</strong> å°†ä¿¡å·é‡çš„èµ„æºè®¡æ•°é€’å¢ 1ï¼Œå¹¶è§£é”è¯¥ä¿¡å·é‡å¯¹è±¡ï¼Œè¿™æ ·å…¶ä»–ç”±äºä½¿ç”¨ <strong>sem_wait</strong> è¢«é˜»å¡çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ã€‚</li>
<li>å¦‚æœå½“å‰ä¿¡å·é‡èµ„æºè®¡æ•°ä¸º 0ï¼Œå‡½æ•° <strong>sem_wait</strong> ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹ï¼›ç›´åˆ°ä¿¡å·é‡å¯¹è±¡çš„èµ„æºè®¡æ•°å¤§äº 0 æ—¶è¢«å”¤é†’ï¼Œå”¤é†’åå°†èµ„æºè®¡æ•°é€’å‡ 1ï¼Œç„¶åç«‹å³è¿”å›ï¼›å‡½æ•° <strong>sem_trywait</strong> æ˜¯å‡½æ•° <strong>sem_wait</strong> çš„éé˜»å¡ç‰ˆæœ¬ï¼Œå¦‚æœå½“å‰ä¿¡å·é‡å¯¹è±¡çš„èµ„æºè®¡æ•°ç­‰äº 0ï¼Œ<strong>sem_trywait</strong> ä¼šç«‹å³è¿”å›ä¸ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œè¿”å›å€¼æ˜¯ -1ï¼Œé”™è¯¯ç  errno è¢«è®¾ç½®æˆ <strong>EAGAIN</strong>ï¼›å‡½æ•° <strong>sem_timedwait</strong> æ˜¯å¸¦æœ‰ç­‰å¾…æ—¶é—´çš„ç‰ˆæœ¬ï¼Œç­‰å¾…æ—¶é—´åœ¨ç¬¬äºŒä¸ªå‚æ•° <strong>abs_timeout</strong> ä¸­è®¾ç½®ï¼Œè¿™æ˜¯ä¸ªç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">timespec</span>
<span class="p">{</span>
	<span class="n">time_t</span> <span class="n">tv_sec</span><span class="p">;</span>      <span class="cm">/* ç§’ */</span>
	<span class="kt">long</span>   <span class="n">tv_nsec</span><span class="p">;</span>     <span class="cm">/* çº³ç§’ [0 .. 999999999] */</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>sem_timedwait</strong> åœ¨å‚æ•° <strong>abs_timeout</strong> è®¾ç½®çš„æ—¶é—´å†…ç­‰å¾…ä¿¡å·é‡å¯¹è±¡çš„èµ„æºè®¡æ•°å¤§äº0ï¼Œå¦åˆ™è¶…æ—¶è¿”å›ï¼Œè¿”å›å€¼ä¸º -1ï¼Œé”™è¯¯ç  errno æ˜¯ <strong>ETIMEDOUT</strong>ã€‚å½“ä½¿ç”¨ <strong>sem_timedwait</strong> æ—¶ï¼Œå‚æ•° <strong>abs_timeout</strong> ä¸èƒ½è®¾ç½®ä¸º NULLï¼Œå¦åˆ™ç¨‹åºä¼šåœ¨è¿è¡Œæ—¶è°ƒç”¨ <strong>sem_timedwait</strong> äº§ç”Ÿå´©æºƒã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼š</p>
<ol>
<li>sem_waitã€sem_trywaitã€sem_timedwait å‡½æ•°å°†èµ„æºè®¡æ•°é€’å‡ä¸€æ—¶ä¼šåŒæ—¶é”å®šä¿¡å·é‡å¯¹è±¡ï¼Œå› æ­¤å½“èµ„æºè®¡æ•°ä¸º 1 æ—¶ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è°ƒç”¨ sem_wait ç­‰å‡½æ•°ç­‰å¾…è¯¥ä¿¡å·é‡æ—¶ï¼Œåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹è¢«å”¤é†’ã€‚sem_wait å‡½æ•°è¿”å›æ—¶ï¼Œä¼šé‡Šæ”¾å¯¹è¯¥ä¿¡å·é‡çš„é”ã€‚</li>
<li>sem_waitã€sem_trywaitã€sem_timedwait å‡½æ•°è°ƒç”¨æˆåŠŸåè¿”å›å€¼å‡ä¸º 0ï¼Œè°ƒç”¨å¤±è´¥è¿”å› -1ï¼Œå¯ä»¥é€šè¿‡é”™è¯¯ç  errno è·å¾—å¤±è´¥åŸå› ã€‚</li>
<li>sem_waitã€sem_trywaitã€sem_timedwait å¯ä»¥è¢« Linux ä¿¡å·ä¸­æ–­ï¼Œè¢«ä¿¡å·ä¸­æ–­åï¼Œå‡½æ•°ç«‹å³è¿”å›ï¼Œè¿”å›å€¼æ˜¯ -1ï¼Œé”™è¯¯ç  errno ä¸ºEINTRã€‚</li>
</ol>
</blockquote>
<blockquote>
<p>è™½ç„¶ä¸Šè¿°å‡½æ•°æ²¡æœ‰ä»¥ pthread_ ä½œä¸ºå‰ç¼€ï¼Œå®é™…ä½¿ç”¨è¿™ä¸ªç³»åˆ—çš„å‡½æ•°æ—¶éœ€è¦é“¾æ¥ pthread åº“ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬çœ‹ä¸€ä¸ªä¿¡å·é‡çš„å…·ä½“ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;list&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;semaphore.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">class</span> <span class="n">Task</span>
<span class="p">{</span>
<span class="nl">public</span><span class="p">:</span>
	<span class="n">Task</span><span class="p">(</span><span class="kt">int</span> <span class="n">taskID</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">taskID</span> <span class="o">=</span> <span class="n">taskID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">void</span> <span class="n">doTask</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;handle a task, taskID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">taskID</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, threadID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">pthread_self</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">private</span><span class="p">:</span>
	<span class="kt">int</span> <span class="n">taskID</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">pthread_mutex_t</span>  <span class="n">mymutex</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">*&gt;</span> <span class="n">tasks</span><span class="p">;</span>
<span class="n">sem_t</span>            <span class="n">mysemaphore</span><span class="p">;</span>


<span class="kt">void</span><span class="o">*</span> <span class="nf">consumer_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Task</span><span class="o">*</span> <span class="n">pTask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysemaphore</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tasks</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
		<span class="n">pTask</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
		<span class="n">tasks</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
		<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>

		<span class="n">pTask</span><span class="o">-&gt;</span><span class="n">doTask</span><span class="p">();</span>
		<span class="n">delete</span> <span class="n">pTask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">producer_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">taskID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Task</span><span class="o">*</span> <span class="n">pTask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pTask</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Task</span><span class="p">(</span><span class="n">taskID</span><span class="p">);</span>

		<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
		<span class="n">tasks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pTask</span><span class="p">);</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;produce a task, taskID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">taskID</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, threadID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">pthread_self</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

		<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>

		<span class="c1">//é‡Šæ”¾ä¿¡å·é‡ï¼Œé€šçŸ¥æ¶ˆè´¹è€…çº¿ç¨‹
</span><span class="c1"></span>		<span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysemaphore</span><span class="p">);</span>

		<span class="n">taskID</span> <span class="o">++</span><span class="p">;</span>

		<span class="c1">//ä¼‘çœ 1ç§’
</span><span class="c1"></span>		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="c1">//åˆå§‹ä¿¡å·é‡èµ„æºè®¡æ•°ä¸º0
</span><span class="c1"></span>	<span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysemaphore</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="c1">//åˆ›å»º5ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹
</span><span class="c1"></span>	<span class="n">pthread_t</span> <span class="n">consumerThreadID</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">consumerThreadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">consumer_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="c1">//åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹
</span><span class="c1"></span>	<span class="n">pthread_t</span> <span class="n">producerThreadID</span><span class="p">;</span>
	<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">producerThreadID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">producer_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">pthread_join</span><span class="p">(</span><span class="n">producerThreadID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_join</span><span class="p">(</span><span class="n">consumerThreadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sem_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysemaphore</span><span class="p">);</span>
	<span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä»¥ä¸Šä»£ç ä¸­æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹å’Œ 5 ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œåˆå§‹ä¿¡å·é‡è®¡æ•°ä¸º 0 ä»£è¡¨å¼€å§‹æ²¡æœ‰å¯æ‰§è¡Œä»»åŠ¡ï¼Œæ‰€ä»¥ 5 ä¸ªæ¶ˆè´¹çº¿ç¨‹å‡é˜»å¡åœ¨ <strong>sem_wait</strong> è°ƒç”¨å¤„ï¼Œæ¥ç€ç”Ÿäº§è€…æ¯éš” 1 ç§’äº§ç”Ÿä¸€ä¸ªä»»åŠ¡ï¼Œç„¶åé€šè¿‡è°ƒç”¨ <strong>sem_post</strong> å°†ä¿¡å·é‡èµ„æºè®¡æ•°å¢åŠ ä¸€ï¼Œæ­¤æ—¶å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œç„¶åæˆ‘ä»¬ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡ï¼Œæ‰§è¡Œä»»åŠ¡ï¼Œç”±äºä»»åŠ¡å¯¹è±¡æ˜¯ new å‡ºæ¥çš„ï¼Œæˆ‘ä»¬éœ€è¦ delete æ‰ä»¥é¿å…å†…å­˜æ³„éœ²ã€‚</p>
<p>æœ‰äººå¯èƒ½ä¼šè§‰å¾—å¥‡æ€ªï¼Œåœ¨è°ƒç”¨ <strong>sem_wait</strong> å’Œ <strong>sem_post</strong> æ—¶ä¼šå¯¹ä¿¡å·é‡å¯¹è±¡è¿›è¡ŒåŠ é”å’Œè§£é”ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¿˜éœ€è¦ä½¿ç”¨ä¸€ä¸ª mutexï¼Ÿè¿™ä¸ª mutex æ˜¯ç”¨æ¥ä¿æŠ¤é˜Ÿåˆ— <strong>tasks</strong> çš„ï¼Œå› ä¸ºå¤šä¸ªçº¿ç¨‹ä¼šåŒæ—¶è¯»å†™ä¹‹ã€‚è¿™ä¸ªä¾‹å­ç±»ä¼¼äºé“¶è¡Œé‡Œå¤šä¸ªå®¢æˆ·ç­‰å¾…æŸœå°æœ‰ç©ºé—²åŠç†å–é’±ä¸šåŠ¡ï¼Œæ¯æ¬¡æœ‰ç©ºé—²çš„æŸœå°ï¼Œå°±å¯ä»¥å‘Šè¯‰å®¢æˆ·ï¼Œä½†æ˜¯å¤šäººåŒæ—¶å–é’±æ—¶ï¼Œé“¶è¡Œçš„èµ„é‡‘æ€»è´¦æˆ·å¢å‡ä¸€å®šæ˜¯åŸå­æ€§çš„ã€‚</p>
<p>ç¼–è¯‘å¹¶ç”Ÿæˆæ–‡ä»¶ <strong>semaphore</strong> ï¼Œç„¶åè¿è¡Œä¹‹ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@localhost testsemaphore<span class="o">]</span><span class="c1"># g++ -g -o semaphore semaphore.cpp -lpthread</span>
<span class="o">[</span>root@localhost testsemaphore<span class="o">]</span><span class="c1"># ./semaphore</span>
produce a task, taskID: 0, threadID: <span class="m">140055260595968</span>
handle a task, taskID: 0, threadID: <span class="m">140055277381376</span>
produce a task, taskID: 1, threadID: <span class="m">140055260595968</span>
handle a task, taskID: 1, threadID: <span class="m">140055277381376</span>
produce a task, taskID: 2, threadID: <span class="m">140055260595968</span>
handle a task, taskID: 2, threadID: <span class="m">140055268988672</span>
produce a task, taskID: 3, threadID: <span class="m">140055260595968</span>
handle a task, taskID: 3, threadID: <span class="m">140055294166784</span>
produce a task, taskID: 4, threadID: <span class="m">140055260595968</span>
handle a task, taskID: 4, threadID: <span class="m">140055302559488</span>
produce a task, taskID: 5, threadID: <span class="m">140055260595968</span>
handle a task, taskID: 5, threadID: <span class="m">140055285774080</span>
produce a task, taskID: 6, threadID: <span class="m">140055260595968</span>
handle a task, taskID: 6, threadID: <span class="m">140055277381376</span>
produce a task, taskID: 7, threadID: <span class="m">140055260595968</span>
handle a task, taskID: 7, threadID: <span class="m">140055268988672</span>
produce a task, taskID: 8, threadID: <span class="m">140055260595968</span>
handle a task, taskID: 8, threadID: <span class="m">140055294166784</span>
produce a task, taskID: 9, threadID: <span class="m">140055260595968</span>
handle a task, taskID: 9, threadID: <span class="m">140055302559488</span>
...æ›´å¤šè¾“å‡ºç»“æœçœç•¥...
</code></pre></td></tr></table>
</div>
</div><h3 id="linux-æ¡ä»¶å˜é‡">LINUX æ¡ä»¶å˜é‡</h3>
<hr>
<p>æœ‰äººè¯´ Linux æ¡ä»¶å˜é‡ï¼ˆCondition Variableï¼‰æ˜¯æœ€ä¸ä¼šç”¨é”™çš„ä¸€ç§çº¿ç¨‹åŒæ­¥å¯¹è±¡ï¼Œç¡®å®æ˜¯è¿™æ ·ï¼Œä½†è¿™å¿…é¡»å»ºç«‹åœ¨ä½ å¯¹æ¡ä»¶å˜é‡ç†Ÿç»ƒä½¿ç”¨çš„åŸºç¡€ä¹‹ä¸Šã€‚æˆ‘ä»¬å…ˆæ¥è®¨è®ºä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šå­˜åœ¨æ¡ä»¶å˜é‡è¿™æ ·ä¸€ç§æœºåˆ¶ã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨æ¡ä»¶å˜é‡">ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨æ¡ä»¶å˜é‡ï¼Ÿ</h4>
<hr>
<p>å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šæœ‰ç±»ä¼¼å¦‚ä¸‹éœ€æ±‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">//ä»¥ä¸‹æ˜¯ä¼ªç ï¼Œmçš„ç±»å‹æ˜¯pthread_mutex_tï¼Œå¹¶ä¸”å·²ç»åˆå§‹åŒ–è¿‡äº†
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">WaitForTrue</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">condition</span> <span class="n">is</span> <span class="nb">false</span><span class="p">)</span>		<span class="c1">//æ¡ä»¶ä¸æ»¡è¶³
</span><span class="c1"></span>	<span class="p">{</span>
		<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>	<span class="c1">//è§£é”ç­‰å¾…å…¶ä»–çº¿ç¨‹æ”¹å˜condition
</span><span class="c1"></span>		<span class="n">sleep</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>					<span class="c1">//ç¡çœ nç§’
</span><span class="c1"></span>		<span class="c1">//nç§’åå†æ¬¡åŠ é”éªŒè¯æ¡ä»¶æ˜¯å¦æ»¡è¶³
</span><span class="c1"></span>		<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="http://qbdu2qzd0.bkt.clouddn.com/thread_4.png" alt="avatar"></p>
<p>è¿™æ®µé€»è¾‘çš„ç”¨é€”æ˜¯æˆ‘ä»¬éœ€è¦åå¤åˆ¤æ–­ä¸€ä¸ªå¤šçº¿ç¨‹å…±äº«æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œä¸€ç›´åˆ°è¯¥æ¡ä»¶æ»¡è¶³ä¸ºæ­¢ï¼Œç”±äºè¯¥æ¡ä»¶è¢«å¤šä¸ªçº¿ç¨‹æ“ä½œå› æ­¤æ¯æ¬¡åˆ¤æ–­ä¹‹å‰æˆ‘ä»¬éƒ½éœ€è¦è¿›è¡ŒåŠ é”æ“ä½œï¼Œåˆ¤æ–­å®Œæ¯•åéœ€è¦è¿›è¡Œè§£é”æ“ä½œã€‚ä½†æ˜¯ä¸Šè¿°é€»è¾‘å­˜åœ¨ä¸¥é‡çš„æ•ˆç‡é—®é¢˜ï¼Œå‡è®¾æˆ‘ä»¬è§£é”ç¦»å¼€ä¸´ç•ŒåŒºåï¼Œæ­¤æ—¶ç”±äºå…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†æ¡ä»¶å¯¼è‡´æ¡ä»¶æ»¡è¶³äº†ï¼Œæ­¤æ—¶ç¨‹åºä»ç„¶éœ€è¦ç¡çœ  n ç§’åæ‰èƒ½å¾—åˆ°åé¦ˆã€‚å› æ­¤æˆ‘ä»¬éœ€è¦è¿™æ ·ä¸€ç§æœºåˆ¶ï¼š</p>
<blockquote>
<p>æŸä¸ªçº¿ç¨‹ A åœ¨æ¡ä»¶ä¸æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œä¸»åŠ¨è®©å‡ºäº’æ–¥é‡ï¼Œè®©å…¶ä»–çº¿ç¨‹å»æŠ˜è…¾ï¼Œçº¿ç¨‹åœ¨æ­¤å¤„ç­‰å¾…ï¼Œç­‰å¾…æ¡ä»¶çš„æ»¡è¶³ï¼›ä¸€æ—¦æ¡ä»¶æ»¡è¶³ï¼Œçº¿ç¨‹å°±å¯ä»¥è¢«ç«‹åˆ»å”¤é†’ã€‚çº¿ç¨‹ A ä¹‹æ‰€ä»¥å¯ä»¥å®‰å¿ƒç­‰å¾…ï¼Œä¾èµ–çš„æ˜¯å…¶ä»–çº¿ç¨‹çš„åä½œï¼Œå®ƒç¡®ä¿¡ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å‘ç°æ¡ä»¶æ»¡è¶³ä»¥åï¼Œå°†å‘å®ƒå‘é€ä¿¡å·ï¼Œå¹¶ä¸”è®©å‡ºäº’æ–¥é‡ã€‚å¦‚æœå…¶ä»–çº¿ç¨‹ä¸é…åˆï¼ˆä¸å‘ä¿¡å·ï¼Œä¸è®©å‡ºäº’æ–¥é‡ï¼‰ï¼Œè¿™ä¸ªä¸»åŠ¨è®©å‡ºäº’æ–¥é‡å¹¶ç­‰å¾…äº‹ä»¶å‘ç”Ÿçš„çº¿ç¨‹ A å°±çœŸçš„è¦ç­‰åˆ°èŠ±å„¿éƒ½è°¢äº†ã€‚</p>
</blockquote>
<p>è¿™ä¸ªä¾‹å­è§£é‡Šäº†ä¸ºä»€ä¹ˆéœ€è¦æ¡ä»¶ç­‰å¾…ï¼Œä½†æ˜¯æ¡ä»¶ç­‰å¾…è¿˜ä¸æ˜¯æ¡ä»¶å˜é‡çš„å…¨éƒ¨åŠŸèƒ½ã€‚</p>
<h4 id="æ¡ä»¶å˜é‡ä¸ºä»€ä¹ˆè¦ä¸äº’æ–¥ä½“å¯¹è±¡ç»“åˆ">æ¡ä»¶å˜é‡ä¸ºä»€ä¹ˆè¦ä¸äº’æ–¥ä½“å¯¹è±¡ç»“åˆ</h4>
<hr>
<p>å¾ˆå¤šç¬¬ä¸€æ¬¡å­¦ä¹  Linux æ¡ä»¶å˜é‡çš„è¯»è€…ä¼šè§‰å¾—å›°æƒ‘ï¼šä¸ºä»€ä¹ˆæ¡ä»¶å˜é‡ä¸€å®šè¦ä¸ä¸€ä¸ªäº’æ–¥ä½“å¯¹è±¡ç»“åˆä½¿ç”¨ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹ï¼Œå‡è®¾æ¡ä»¶å˜é‡ä¸ä¸äº’æ–¥ä½“å¯¹è±¡ç»“åˆçš„æ•ˆæœã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="mi">1</span> <span class="c1">//mçš„ç±»å‹æ˜¯pthread_mutex_tï¼Œå¹¶ä¸”å·²ç»åˆå§‹åŒ–è¿‡äº†ï¼Œcvæ˜¯æ¡ä»¶å˜é‡
</span><span class="c1"></span><span class="mi">2</span> <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">)</span>
<span class="mi">3</span> <span class="k">while</span><span class="p">(</span><span class="n">condition_is_false</span><span class="p">)</span>
<span class="mi">4</span> <span class="p">{</span>
<span class="mi">5</span>     <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
<span class="mi">6</span>     <span class="c1">//è§£é”ä¹‹åï¼Œç­‰å¾…ä¹‹å‰ï¼Œå¯èƒ½æ¡ä»¶å·²ç»æ»¡è¶³ï¼Œä¿¡å·å·²ç»å‘å‡ºï¼Œä½†æ˜¯è¯¥ä¿¡å·å¯èƒ½ä¼šè¢«é”™è¿‡
</span><span class="c1"></span><span class="mi">7</span>     <span class="n">cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">);</span>
<span class="mi">8</span>     <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
<span class="mi">9</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç ä¸­ï¼Œå‡è®¾çº¿ç¨‹ A æ‰§è¡Œå®Œç¬¬ 5 è¡Œä»£ç  pthread_mutex_unlock(&amp;m); å CPU æ—¶é—´ç‰‡è¢«å‰¥å¤ºï¼Œæ­¤æ—¶å¦å¤–ä¸€ä¸ªçº¿ç¨‹ B è·å¾—è¯¥äº’æ–¥ä½“å¯¹è±¡ mï¼Œç„¶åå‘é€æ¡ä»¶ä¿¡å·ï¼Œç­‰çº¿ç¨‹ A é‡æ–°è·å¾—æ—¶é—´ç‰‡åï¼Œç”±äºè¯¥ä¿¡å·å·²ç»è¢«é”™è¿‡äº†ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´çº¿ç¨‹ A åœ¨ ç¬¬ 7 è¡Œ cond_wait(&amp;cv); æ— é™é˜»å¡ä¸‹å»ã€‚</p>
<p>é€ æˆè¿™ä¸ªé—®é¢˜çš„æ ¹æºæ˜¯é‡Šæ”¾äº’æ–¥ä½“å¯¹è±¡ä¸æ¡ä»¶å˜é‡ç­‰å¾…å”¤é†’ä¸æ˜¯åŸå­æ“ä½œï¼Œå³è§£é”å’Œç­‰å¾…è¿™ä¸¤ä¸ªæ­¥éª¤å¿…é¡»æ˜¯åŒä¸€ä¸ªåŸå­æ€§çš„æ“ä½œï¼Œä»¥ç¡®ä¿ cond_wait å”¤é†’ä¹‹å‰ä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹è·å¾—è¿™ä¸ªäº’æ–¥ä½“å¯¹è±¡ã€‚</p>
<h4 id="æ¡ä»¶å˜é‡çš„ä½¿ç”¨">æ¡ä»¶å˜é‡çš„ä½¿ç”¨</h4>
<hr>
<p>ä»‹ç»äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬æ¥æ­£å¼ä»‹ç»ä¸€ä¸‹æ¡ä»¶å˜é‡ç›¸å…³çš„ç³»ç»Ÿ API çš„ä½¿ç”¨æ–¹æ³•ã€‚</p>
<p>æ¡ä»¶å˜é‡çš„åˆå§‹åŒ–å’Œé”€æ¯å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ API å‡½æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_cond_init</span><span class="p">(</span><span class="n">pthread_cond_t</span><span class="o">*</span> <span class="n">cond</span><span class="p">,</span> <span class="k">const</span> <span class="n">pthread_condattr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_cond_destroy</span><span class="p">(</span><span class="n">pthread_cond_t</span><span class="o">*</span> <span class="n">cond</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ Linux ç³»ç»Ÿä¸­ <strong>pthread_cond_t</strong> å³æ˜¯æ¡ä»¶å˜é‡çš„ç±»å‹ï¼Œå½“ç„¶å’Œå‰é¢ä»‹ç»çš„äº’æ–¥ä½“ä¸€æ ·ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å»åˆå§‹åŒ–ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">pthread_cond_t</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">PTHREAD_COND_INITIALIZER</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>ç­‰å¾…æ¡ä»¶å˜é‡çš„æ»¡è¶³å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ API å‡½æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_cond_wait</span><span class="p">(</span><span class="n">pthread_cond_t</span><span class="o">*</span> <span class="kr">restrict</span> <span class="n">cond</span><span class="p">,</span> <span class="n">pthread_mutex_t</span><span class="o">*</span> <span class="kr">restrict</span> <span class="n">mutex</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_cond_timedwait</span><span class="p">(</span><span class="n">pthread_cond_t</span><span class="o">*</span> <span class="kr">restrict</span> <span class="n">cond</span><span class="p">,</span> <span class="n">pthread_mutex_t</span><span class="o">*</span> <span class="kr">restrict</span> <span class="n">mutex</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span><span class="o">*</span> <span class="kr">restrict</span> <span class="n">abstime</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸€èˆ¬æƒ…å†µä¸‹å¦‚æœæ¡ä»¶å˜é‡ä»£è¡¨çš„æ¡ä»¶ä¸ä¼šæ»¡è¶³ï¼Œè°ƒç”¨ <strong>pthread_cond_wait</strong> çš„çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼›<strong>pthread_cond_timedwait</strong> æ˜¯ <strong>pthread_cond_wait</strong> éé˜»å¡ç‰ˆæœ¬ï¼Œå®ƒä¼šåœ¨æŒ‡å®šæ—¶é—´å†…ç­‰å¾…æ¡ä»¶æ»¡è¶³ï¼Œè¶…è¿‡å‚æ•° <strong>abstime</strong> è®¾ç½®çš„æ—¶å€™å <strong>pthread_cond_timedwait</strong> å‡½æ•°ä¼šç«‹å³è¿”å›ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šå¯¹äºå‚æ•° <strong>abstime</strong>ï¼Œæ­£å¦‚å…¶åå­—æš—ç¤ºçš„ï¼Œè¿™æ˜¯ä¸€ä¸ª absolute timeï¼ˆç»å¯¹æ—¶é—´ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½ æ‰“ç®—è®©å‡½æ•°ç­‰å¾… 5 ç§’ï¼Œé‚£ä¹ˆä½ åº”è¯¥å…ˆå¾—åˆ°å½“å‰ç³»ç»Ÿçš„æ—¶é—´ï¼Œç„¶ååŠ ä¸Š 5 ç§’è®¡ç®—å‡ºæœ€ç»ˆçš„æ—¶é—´ä½œä¸ºå‚æ•° <strong>abstime</strong> çš„å€¼ã€‚</p>
</blockquote>
<p>å› è°ƒç”¨ <strong>pthread_cond_wait</strong> ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥è¢«ä»¥ä¸‹ API å‡½æ•°å”¤é†’ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_cond_signal</span><span class="p">(</span><span class="n">pthread_cond_t</span><span class="o">*</span> <span class="n">cond</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_cond_broadcast</span><span class="p">(</span><span class="n">pthread_cond_t</span><span class="o">*</span> <span class="n">cond</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>pthread_cond_signal</strong> ä¸€æ¬¡å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è°ƒç”¨ <strong>pthread_cond_wait</strong> ç­‰å¾…ï¼Œå…·ä½“å“ªä¸ªçº¿ç¨‹è¢«å”¤é†’æ˜¯ä¸ç¡®å®šçš„ï¼ˆå¯ä»¥è®¤ä¸ºæ˜¯éšæœºçš„ï¼‰ï¼›<strong>pthread_cond_broadcast</strong> å¯ä»¥åŒæ—¶å”¤é†’å¤šä¸ªè°ƒç”¨ <strong>pthread_cond_wait</strong> ç­‰å¾…çš„çº¿ç¨‹ã€‚å‰è€…ç›¸å½“äºå‘é€ä¸€æ¬¡æ¡ä»¶é€šçŸ¥ï¼Œåè€…å¹¿æ’­ä¸€æ¬¡æ¡ä»¶é€šçŸ¥ã€‚æˆåŠŸç­‰å¾…åˆ°æ¡ä»¶ä¿¡å·ï¼Œ<strong>pthread_cond_signal</strong> å’Œ <strong>pthread_cond_broadcast</strong> è¿”å› 0ï¼Œåä¹‹è¿”å›é0å€¼ï¼Œå…·ä½“é”™è¯¯åŸå› å¯ä»¥é€šè¿‡é”™è¯¯ç  errno è·å¾—ã€‚</p>
<p>æˆ‘ä»¬å°†å‰æ–‡ä¸­ä»‹ç»ä¿¡å·é‡çš„ç¤ºä¾‹ä»£ç ç”¨æ¡ä»¶å˜é‡æ¥æ”¹å†™ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;list&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;semaphore.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">class</span> <span class="n">Task</span>
<span class="p">{</span>
<span class="nl">public</span><span class="p">:</span>
	<span class="n">Task</span><span class="p">(</span><span class="kt">int</span> <span class="n">taskID</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">taskID</span> <span class="o">=</span> <span class="n">taskID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">void</span> <span class="n">doTask</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;handle a task, taskID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">taskID</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, threadID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">pthread_self</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">private</span><span class="p">:</span>
	<span class="kt">int</span> <span class="n">taskID</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">pthread_mutex_t</span>  <span class="n">mymutex</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">*&gt;</span> <span class="n">tasks</span><span class="p">;</span>
<span class="n">pthread_cond_t</span>   <span class="n">mycv</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">consumer_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Task</span><span class="o">*</span> <span class="n">pTask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tasks</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
		<span class="p">{</span>
			<span class="c1">//å¦‚æœè·å¾—äº†äº’æ–¥é”ï¼Œä½†æ˜¯æ¡ä»¶ä¸åˆé€‚çš„è¯ï¼Œpthread_cond_waitä¼šé‡Šæ”¾é”ï¼Œä¸å¾€ä¸‹æ‰§è¡Œã€‚
</span><span class="c1"></span>			<span class="c1">//å½“å‘ç”Ÿå˜åŒ–åï¼Œæ¡ä»¶åˆé€‚ï¼Œpthread_cond_waitå°†ç›´æ¥è·å¾—é”ã€‚
</span><span class="c1"></span>			<span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pTask</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
		<span class="n">tasks</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>

		<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pTask</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pTask</span><span class="o">-&gt;</span><span class="n">doTask</span><span class="p">();</span>
		<span class="n">delete</span> <span class="n">pTask</span><span class="p">;</span>
		<span class="n">pTask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">producer_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">taskID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Task</span><span class="o">*</span> <span class="n">pTask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pTask</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Task</span><span class="p">(</span><span class="n">taskID</span><span class="p">);</span>

		<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
		<span class="n">tasks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pTask</span><span class="p">);</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;produce a task, taskID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">taskID</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, threadID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">pthread_self</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

		<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>

		<span class="c1">//é‡Šæ”¾ä¿¡å·é‡ï¼Œé€šçŸ¥æ¶ˆè´¹è€…çº¿ç¨‹
</span><span class="c1"></span>		<span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycv</span><span class="p">);</span>

		<span class="n">taskID</span> <span class="o">++</span><span class="p">;</span>

		<span class="c1">//ä¼‘çœ 1ç§’
</span><span class="c1"></span>		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pthread_cond_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="c1">//åˆ›å»º5ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹
</span><span class="c1"></span>	<span class="n">pthread_t</span> <span class="n">consumerThreadID</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">consumerThreadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">consumer_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="c1">//åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹
</span><span class="c1"></span>	<span class="n">pthread_t</span> <span class="n">producerThreadID</span><span class="p">;</span>
	<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">producerThreadID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">producer_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">pthread_join</span><span class="p">(</span><span class="n">producerThreadID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_join</span><span class="p">(</span><span class="n">consumerThreadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pthread_cond_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycv</span><span class="p">);</span>
	<span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç¼–è¯‘å¹¶æ‰§è¡Œä¸Šè¿°ç¨‹åºï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="n">testsemaphore</span><span class="p">]</span><span class="err">#</span> <span class="n">g</span><span class="o">++</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">o</span> <span class="n">cv</span> <span class="n">cv</span><span class="p">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">lpthread</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="n">testsemaphore</span><span class="p">]</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">cv</span>
<span class="n">produce</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571200554752</span>
<span class="n">handle</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571242518272</span>
<span class="n">produce</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571200554752</span>
<span class="n">handle</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571225732864</span>
<span class="n">produce</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571200554752</span>
<span class="n">handle</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571208947456</span>
<span class="n">produce</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571200554752</span>
<span class="n">handle</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571242518272</span>
<span class="n">produce</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571200554752</span>
<span class="n">handle</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571234125568</span>
<span class="n">produce</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571200554752</span>
<span class="n">handle</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571217340160</span>
<span class="n">produce</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571200554752</span>
<span class="n">handle</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571225732864</span>
<span class="n">produce</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571200554752</span>
<span class="n">handle</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571208947456</span>
<span class="n">produce</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571200554752</span>
<span class="n">handle</span> <span class="n">a</span> <span class="n">task</span><span class="p">,</span> <span class="nl">taskID</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="nl">threadID</span><span class="p">:</span> <span class="mi">140571242518272</span>
<span class="p">...</span><span class="err">æ›´å¤šè¾“å‡ºç»“æœçœç•¥</span><span class="p">...</span>
</code></pre></td></tr></table>
</div>
</div><p>æ¡ä»¶å˜é‡æœ€å…³é”®çš„ä¸€ä¸ªåœ°æ–¹å°±æ˜¯éœ€è¦æ¸…æ¥šåœ°è®°å¾— <strong>pthread_cond_wait</strong> åœ¨æ¡ä»¶æ»¡è¶³ä¸ä¸æ»¡è¶³æ—¶çš„ä¸¤ç§è¡Œä¸ºï¼Œè¿™æ˜¯éš¾ç‚¹ä¹Ÿæ˜¯<strong>é‡ç‚¹</strong>ï¼š</p>
<ul>
<li>å½“ <strong>pthread_cond_wait</strong> å‡½æ•°é˜»å¡æ—¶ï¼Œå®ƒä¼šé‡Šæ”¾å…¶ç»‘å®šçš„äº’æ–¥ä½“ï¼Œå¹¶é˜»å¡çº¿ç¨‹ï¼Œå› æ­¤åœ¨è°ƒç”¨è¯¥å‡½æ•°å‰åº”è¯¥å¯¹äº’æ–¥ä½“æœ‰ä¸ªåŠ é”æ“ä½œï¼ˆä¸Šè¿°ä»£ç çš„ç¬¬ <strong>34</strong> è¡Œçš„ pthread_mutex_lock(&amp;mymutex);ï¼‰ã€‚</li>
<li>å½“æ”¶åˆ°æ¡ä»¶ä¿¡å·æ—¶ï¼Œ <strong>pthread_cond_wait</strong> ä¼šè¿”å›å¹¶å¯¹å…¶ç»‘å®šçš„äº’æ–¥ä½“è¿›è¡ŒåŠ é”ï¼Œå› æ­¤åœ¨å…¶ä¸‹é¢ä¸€å®šæœ‰ä¸ªå¯¹äº’æ–¥ä½“è¿›è¡Œè§£é”çš„æ“ä½œï¼ˆä¸Šè¿°ä»£ç çš„ç¬¬ <strong>45</strong> è¡Œ pthread_mutex_unlock(&amp;mymutex);ï¼‰ã€‚</li>
</ul>
<h4 id="æ¡ä»¶å˜é‡çš„è™šå‡å”¤é†’">æ¡ä»¶å˜é‡çš„è™šå‡å”¤é†’</h4>
<hr>
<p>ä¸Šé¢å°†äº’æ–¥é‡å’Œæ¡ä»¶å˜é‡é…åˆä½¿ç”¨çš„ç¤ºä¾‹ä»£ç ä¸­æœ‰ä¸ªå¾ˆæœ‰æ„æ€çš„åœ°æ–¹ï¼Œå°±æ˜¯ç”¨äº† while è¯­å¥ï¼Œé†’æ¥
ä¹‹åè¦å†æ¬¡åˆ¤æ–­æ¡ä»¶æ˜¯å¦æ»¡è¶³ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">while</span> <span class="p">(</span><span class="n">tasks</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<span class="p">{</span>
	<span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸ºä»€ä¹ˆä¸å†™æˆï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">if</span> <span class="p">(</span><span class="n">tasks</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<span class="p">{</span>
	<span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mycv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mymutex</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç­”æ¡ˆæ˜¯ä¸å¾—ä¸å¦‚æ­¤ã€‚å› ä¸ºå¯èƒ½æŸæ¬¡æ“ä½œç³»ç»Ÿå”¤é†’ pthread_cond_wait æ—¶ tasks.empty() å¯èƒ½ä»ç„¶ä¸º trueï¼Œè¨€ä¸‹ä¹‹æ„å°±æ˜¯æ“ä½œç³»ç»Ÿå¯èƒ½ä¼šåœ¨ä¸€äº›æƒ…å†µä¸‹å”¤é†’æ¡ä»¶å˜é‡ï¼Œå³ä½¿æ²¡æœ‰å…¶ä»–çº¿ç¨‹å‘æ¡ä»¶å˜é‡å‘é€ä¿¡å·ï¼Œç­‰å¾…æ­¤æ¡ä»¶
å˜é‡çš„çº¿ç¨‹ä¹Ÿæœ‰å¯èƒ½ä¼šé†’æ¥ã€‚æˆ‘ä»¬å°†æ¡ä»¶å˜é‡çš„è¿™ç§è¡Œä¸ºç§°ä¹‹ä¸º <strong>è™šå‡å”¤é†’</strong> ï¼ˆ<strong>spurious wakeup</strong>ï¼‰ã€‚å› æ­¤å°†æ¡ä»¶ï¼ˆåˆ¤æ–­ tasks.empty() ä¸ºtrueï¼‰æ”¾åœ¨ä¸€ä¸ª while å¾ªç¯ä¸­æ„å‘³ç€å…‰å”¤é†’æ¡ä»¶å˜é‡ä¸è¡Œï¼Œè¿˜å¿…é¡»æ¡ä»¶æ»¡è¶³ç¨‹åºæ‰èƒ½ç»§ç»­æ‰§è¡Œæ­£å¸¸çš„é€»è¾‘ã€‚</p>
<p>è¿™çœ‹èµ·æ¥è¿™åƒæ˜¯ä¸ªbugï¼Œä½†å®ƒåœ¨ Linux ç³»ç»Ÿä¸­æ˜¯å®å®åœ¨åœ¨å­˜åœ¨çš„ã€‚ä¸ºä»€ä¹ˆä¼šå­˜åœ¨è™šå‡å”¤é†’å‘¢ï¼Ÿä¸€ä¸ªåŸå› æ˜¯
<strong>pthread_cond_wait</strong> æ˜¯ futex ç³»ç»Ÿè°ƒç”¨ï¼Œå±äºé˜»å¡å‹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå½“ç³»ç»Ÿè°ƒç”¨è¢«ä¿¡å·ä¸­æ–­çš„æ—¶å€™ï¼Œä¼šè¿”å› <strong>-1</strong>ï¼Œå¹¶ä¸”æŠŠ errno é”™è¯¯ç ç½®ä¸ºEINTRã€‚å¾ˆå¤šè¿™ç§ç³»ç»Ÿè°ƒç”¨ä¸ºäº†é˜²æ­¢è¢«ä¿¡å·ä¸­æ–­éƒ½ä¼šé‡å¯ç³»ç»Ÿè°ƒç”¨ï¼ˆå³å†æ¬¡è°ƒç”¨ä¸€æ¬¡è¿™ä¸ªå‡½æ•°ï¼‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">pid_t</span> <span class="nf">r_wait</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">stat_loc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
    <span class="c1">//waitå‡½æ•°å› ä¸ºè¢«ä¿¡å·ä¸­æ–­å¯¼è‡´è°ƒç”¨å¤±è´¥ä¼šè¿”å›-1ï¼Œé”™è¯¯ç æ˜¯EINTR
</span><span class="c1"></span>    <span class="c1">//æ³¨æ„ï¼šè¿™é‡Œçš„whileå¾ªç¯ä½“æ˜¯ä¸€æ¡ç©ºè¯­å¥
</span><span class="c1"></span>    <span class="k">while</span><span class="p">(((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">wait</span><span class="p">(</span><span class="n">stat_loc</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä½†æ˜¯ <strong>pthread_cond_wait</strong> ç”¨é€”æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œå‡è®¾ <strong>pthread_cond_wait</strong> å‡½æ•°è¢«ä¿¡å·ä¸­æ–­äº†ï¼Œåœ¨ <strong>pthread_cond_wait</strong> è¿”å›ä¹‹åï¼Œåˆ°é‡æ–°è°ƒç”¨ä¹‹å‰ï¼Œ<strong>pthread_cond_signal</strong> æˆ–
<strong>pthread_cond_broadcast</strong> å¯èƒ½å·²ç»è°ƒç”¨è¿‡ã€‚ä¸€æ—¦é”™å¤±ï¼Œå¯èƒ½ç”±äºæ¡ä»¶ä¿¡å·ä¸å†äº§ç”Ÿï¼Œå†æ¬¡è°ƒç”¨ <strong>pthread_cond_wait</strong> å°†å¯¼è‡´ç¨‹åºæ— é™åˆ¶åœ°ç­‰å¾…ä¸‹å»ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå®å¯è™šå‡å”¤é†’ï¼Œä¹Ÿä¸èƒ½å†æ¬¡è°ƒç”¨<strong>pthread_cond_wait</strong>ï¼Œä»¥å…é™·å…¥æ— ç©·çš„ç­‰å¾…ä¸­ã€‚</p>
<p>é™¤äº†ä¸Šé¢çš„ä¿¡å·å› ç´ å¤–ï¼Œè¿˜å­˜åœ¨ä»¥ä¸‹æƒ…å†µï¼šæ¡ä»¶æ»¡è¶³äº†å‘é€ä¿¡å·ï¼Œä½†ç­‰åˆ°è°ƒç”¨ <strong>pthread_cond_wait</strong> çš„çº¿ç¨‹å¾—åˆ° CPU èµ„æºæ—¶ï¼Œæ¡ä»¶åˆå†æ¬¡ä¸æ»¡è¶³äº†ã€‚</p>
<p>å¥½åœ¨æ— è®ºæ˜¯å“ªç§æƒ…å†µï¼Œé†’æ¥ä¹‹åå†æ¬¡æµ‹è¯•æ¡ä»¶æ˜¯å¦æ»¡è¶³å°±å¯ä»¥è§£å†³è™šå‡ç­‰å¾…çš„é—®é¢˜ã€‚<strong>è¿™å°±æ˜¯ä½¿ç”¨ while å¾ªç¯æ¥åˆ¤æ–­æ¡ä»¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ if è¯­å¥çš„åŸå› ã€‚</strong></p>
<h4 id="æ¡ä»¶å˜é‡ä¿¡å·ä¸¢å¤±é—®é¢˜">æ¡ä»¶å˜é‡ä¿¡å·ä¸¢å¤±é—®é¢˜</h4>
<hr>
<p>ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ï¼Œå¦‚æœä¸€ä¸ªæ¡ä»¶å˜é‡ä¿¡å·æ¡ä»¶äº§ç”Ÿæ—¶ï¼ˆè°ƒç”¨ <strong>pthread_cond_signal</strong> æˆ–
<strong>pthread_cond_broadcast</strong>ï¼‰ï¼Œæ²¡æœ‰ç›¸å…³çš„çº¿ç¨‹è°ƒç”¨ <strong>pthread_cond_wait</strong> æ•è·è¯¥ä¿¡å·ï¼Œé‚£ä¹ˆè¯¥ä¿¡å·æ¡ä»¶å°±ä¼šæ°¸ä¹…æ€§åœ°ä¸¢å¤±äº†ï¼Œå†æ¬¡è°ƒç”¨ <strong>pthread_cond_wait</strong> ä¼šå¯¼è‡´æ°¸ä¹…æ€§çš„é˜»å¡ã€‚è¿™ç§æƒ…å†µåœ¨è®¾è®¡é‚£äº›æ¡ä»¶å˜é‡ä¿¡å·æ¡ä»¶åªä¼šäº§ç”Ÿä¸€æ¬¡çš„é€»è¾‘ä¸­å°¤å…¶éœ€è¦æ³¨æ„ï¼Œä¾‹å¦‚å‡è®¾ç°åœ¨æŸä¸ªç¨‹åºæœ‰ä¸€æ‰¹ç­‰å¾…æ¡ä»¶å˜é‡çš„çº¿ç¨‹ï¼Œå’Œä¸€ä¸ªåªäº§ç”Ÿä¸€æ¬¡æ¡ä»¶å˜é‡ä¿¡å·çš„çº¿ç¨‹ã€‚ä¸ºäº†è®©ä½ çš„ç­‰å¾…æ¡ä»¶å˜é‡çš„çº¿ç¨‹èƒ½æ­£å¸¸è¿è¡Œä¸é˜»å¡ï¼Œä½ çš„é€»è¾‘ä¸­ï¼Œä¸€å®šè¦ç¡®ä¿ç­‰å¾…çš„çº¿ç¨‹åœ¨äº§ç”Ÿæ¡ä»¶å˜é‡ä¿¡å·çš„çº¿ç¨‹å‘é€æ¡ä»¶ä¿¡å·ä¹‹å‰è°ƒç”¨ <strong>pthread_cond_wait</strong> ã€‚</p>
<blockquote>
<p>è¿™å’Œç”Ÿæ´»ä¸­çš„å¾ˆå¤šä¾‹å­ä¸€æ ·ï¼Œå³è®¸å¤šäº‹æƒ…ä½ åªæœ‰ä¸€æ¬¡æœºä¼šï¼Œä½ å¿…é¡»æå‰å‡†å¤‡å¥½å†å»å°è¯•è¿™æ¬¡æœºä¼šï¼Œè¿™ä¸ªæœºä¼šä¸ä¼šç­‰å¾…ä½ çš„å‡†å¤‡ï¼Œä¸€æ—¦ä½ é”™è¿‡ï¼Œå°±ä¸ä¼šå†æœ‰ç¬¬äºŒæ¬¡æœºä¼šäº†ã€‚</p>
</blockquote>
<p>æ¡ä»¶å˜é‡æ˜¯æœ€å¸¸ç”¨çš„ä¸€ç§å¤šçº¿ç¨‹ç¼–ç¨‹åŒæ­¥æŠ€æœ¯ä¹‹ä¸€ã€‚</p>
<h3 id="linux-è¯»å†™é”">LINUX è¯»å†™é”</h3>
<hr>
<h4 id="è¯»å†™é”çš„åº”ç”¨åœºæ™¯">è¯»å†™é”çš„åº”ç”¨åœºæ™¯</h4>
<hr>
<p>å®é™…åº”ç”¨ä¸­ï¼Œå¾ˆå¤šæ—¶å€™å¯¹å…±äº«å˜é‡çš„è®¿é—®æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">å¤§å¤šæ•°æƒ…å†µä¸‹çº¿ç¨‹åªæ˜¯è¯»å–å…±äº«å˜é‡çš„å€¼ï¼Œå¹¶ä¸ä¿®æ”¹ï¼Œåªæœ‰æå°‘æ•°æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ‰ä¼šçœŸæ­£åœ°ä¿®æ”¹å…±äº«å˜é‡çš„å€¼ã€‚
</code></pre></td></tr></table>
</div>
</div><p>å¯¹äºè¿™ç§æƒ…å†µï¼Œè¯»è¯·æ±‚ä¹‹é—´æ˜¯æ— éœ€åŒæ­¥çš„ï¼Œå®ƒä»¬ä¹‹é—´çš„å¹¶å‘è®¿é—®æ˜¯å®‰å…¨çš„ã€‚ç„¶è€Œå†™è¯·æ±‚å¿…é¡»é”ä½è¯»è¯·æ±‚å’Œå…¶ä»–å†™è¯·æ±‚ã€‚</p>
<p>è¿™ç§æƒ…å†µåœ¨å®é™…ä¸­æ˜¯å­˜åœ¨çš„ï¼Œå¦‚è¯»å–ä¸€ä¸ªå…¨å±€å¯¹è±¡çš„çŠ¶æ€å±æ€§ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹è¿™ä¸ªçŠ¶æ€å±æ€§å€¼æ˜¯ä¸ä¼šå˜åŒ–çš„ï¼Œå¶å°”æ‰ä¼šå‡ºç°è¢«ä¿®æ”¹çš„æƒ…å†µã€‚å¦‚æœä½¿ç”¨äº’æ–¥é‡ï¼Œå®Œå…¨é˜»æ­¢è¯»è¯·æ±‚å¹¶å‘ï¼Œåˆ™ä¼šé€ æˆæ€§èƒ½çš„æŸå¤±ã€‚</p>
<h4 id="è¯»å†™é”ä½¿ç”¨æ–¹æ³•">è¯»å†™é”ä½¿ç”¨æ–¹æ³•</h4>
<hr>
<p>è¯»å†™é”åœ¨ Linux ç³»ç»Ÿä¸­ä½¿ç”¨ç±»å‹ <strong>pthread_rwlock_t</strong> è¡¨ç¤ºï¼Œè¯»å†™é”çš„åˆå§‹åŒ–å’Œé”€æ¯ä½¿ç”¨å¦‚ä¸‹ç³»ç»Ÿ API å‡½æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">pthread_rwlock_init</span><span class="p">(</span><span class="n">pthread_rwlock_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">,</span> <span class="k">const</span> <span class="n">pthread_rwlockattr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_rwlock_destroy</span><span class="p">(</span><span class="n">pthread_rwlock_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>å‚æ•° <strong>rwlock</strong> å³ä½ éœ€è¦åˆå§‹åŒ–å’Œé”€æ¯çš„è¯»å†™é”å¯¹è±¡çš„åœ°å€ï¼Œ å‚æ•° <strong>attr</strong> ç”¨äºè®¾ç½®è¯»å†™é”çš„å±æ€§ï¼Œä¸€èˆ¬è®¾ç½®æœª NULL è¡¨ç¤ºä½¿ç”¨é»˜è®¤å±æ€§ã€‚å‡½æ•°è°ƒç”¨æˆåŠŸè¿”å› 0ï¼Œè°ƒç”¨å¤±è´¥è¿”å›é 0 å€¼ï¼Œä½ å¯ä»¥é€šè¿‡æ£€æµ‹é”™è¯¯ç  <strong>errno</strong> è·å–é”™è¯¯åŸå› ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœä½ ä¸éœ€è¦åŠ¨æ€åˆ›å»ºæˆ–è€…è®¾ç½®éé»˜è®¤å±æ€§çš„è¯»å†™é”å¯¹è±¡ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¯­æ³•åˆå§‹åŒ–ä¸€ä¸ªè¯»å†™é”å¯¹è±¡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">pthread_rwlock_t</span> <span class="n">myrwlock</span> <span class="o">=</span> <span class="n">PTHREAD_RWLOCK_INITIALIZER</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢æ˜¯ä¸‰ä¸ªè¯·æ±‚è¯»é”çš„ç³»ç»Ÿ API æ¥å£ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_rwlock_rdlock</span><span class="p">(</span><span class="n">pthread_rwlock_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_rwlock_tryrdlock</span><span class="p">(</span><span class="n">pthread_rwlock_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_rwlock_timedrdlock</span><span class="p">(</span><span class="n">pthread_rwlock_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span><span class="o">*</span> <span class="n">abstime</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>è€Œä¸‹é¢ä¸‰ä¸ªè¯·æ±‚å†™é”çš„ç³»ç»Ÿ API æ¥å£ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_rwlock_wrlock</span><span class="p">(</span><span class="n">pthread_rwlock_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_rwlock_trywrlock</span><span class="p">(</span><span class="n">pthread_rwlock_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_rwlock_timedwrlock</span><span class="p">(</span><span class="n">pthread_rwlock_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">timespec</span><span class="o">*</span> <span class="n">abstime</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>è¯»é”ç”¨äºå…±äº«æ¨¡å¼</strong>ï¼š</p>
<ul>
<li>å¦‚æœå½“å‰è¯»å†™é”å·²ç»è¢«æŸçº¿ç¨‹ä»¥<strong>è¯»æ¨¡å¼</strong>å æœ‰äº†ï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨ <strong>pthread_rwlock_rdlock</strong> ï¼ˆè¯·æ±‚è¯»é”ï¼‰ä¼šç«‹åˆ»è·å¾—è¯»é”ï¼›</li>
<li>å¦‚æœå½“å‰è¯»å†™é”å·²ç»è¢«æŸçº¿ç¨‹ä»¥<strong>è¯»æ¨¡å¼</strong>å æœ‰äº†ï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨ <strong>pthread_rwlock_wrlock</strong> ï¼ˆè¯·æ±‚å†™é”ï¼‰ä¼šé™·å…¥<strong>é˜»å¡</strong>ï¼›</li>
</ul>
<p><strong>å†™é”ç”¨çš„æ˜¯ç‹¬å æ¨¡å¼</strong>ï¼š</p>
<ul>
<li>å¦‚æœå½“å‰è¯»å†™é”è¢«æŸçº¿ç¨‹ä»¥<strong>å†™æ¨¡å¼</strong>å æœ‰ï¼Œæ— è®ºè°ƒç”¨ <strong>pthread_rwlock_rdlock</strong> è¿˜æ˜¯ <strong>pthread_rwlock_wrlock</strong> ** éƒ½ä¼šé™·å…¥<strong>é˜»å¡</strong>ï¼Œå³å†™æ¨¡å¼ä¸‹ä¸å…è®¸ä»»ä½•<strong>è¯»é”</strong>è¯·æ±‚é€šè¿‡ï¼Œä¹Ÿä¸å…è®¸ä»»ä½•<strong>å†™é”</strong>è¯·æ±‚é€šè¿‡ï¼Œè¯»é”è¯·æ±‚å’Œå†™é”è¯·æ±‚éƒ½è¦é™·å…¥é˜»å¡ï¼Œç›´åˆ°çº¿ç¨‹é‡Šæ”¾å†™é”ã€‚</li>
</ul>
<p>å¯ä»¥å°†ä¸Šè¿°è¯»å†™é”é€»è¾‘æ€»ç»“æˆå¦‚ä¸‹è¡¨æ ¼ï¼š</p>
<table>
<thead>
<tr>
<th>é”å½“å‰çŠ¶æ€/å…¶ä»–çº¿ç¨‹è¯·æ±‚é”ç±»å‹</th>
<th>è¯·æ±‚è¯»é”</th>
<th>è¯·æ±‚å†™é”</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ— é”</td>
<td>é€šè¿‡</td>
<td>é€šè¿‡</td>
</tr>
<tr>
<td>å·²ç»è·å¾—è¯»é”</td>
<td>é€šè¿‡</td>
<td>é˜»æ­¢</td>
</tr>
<tr>
<td>å·²ç»è·å¾—å†™é”</td>
<td>é˜»æ­¢</td>
<td>é˜»æ­¢</td>
</tr>
</tbody>
</table>
<p>æ— è®ºæ˜¯è¯»é”è¿˜æ˜¯å†™é”ï¼Œé”çš„é‡Šæ”¾éƒ½æ˜¯ä¸€ä¸ªæ¥å£ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_rwlock_unlock</span> <span class="p">(</span><span class="n">pthread_rwlock_t</span><span class="o">*</span> <span class="n">rwlock</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>æ— è®ºæ˜¯è¯·æ±‚è¯»é”è¿˜æ˜¯å†™é”ï¼Œéƒ½æä¾›äº†trylockçš„åŠŸèƒ½ï¼ˆ<strong>pthread_rwlock_tryrdlock</strong> å’Œ <strong>pthread_rwlock_trywrlock</strong>ï¼‰ï¼Œè°ƒç”¨çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œè€Œä¼šç«‹å³è¿”å›ã€‚å¦‚æœèƒ½æˆåŠŸè·å¾—è¯»é”æˆ–è€…å†™é”ï¼Œå‡½æ•°è¿”å› 0ï¼Œå¦‚æœä¸èƒ½è·å¾—è¯»é”æˆ–å†™é”æ—¶ï¼Œå‡½æ•°è¿”å›é 0 å€¼ï¼Œæ­¤æ—¶é”™è¯¯ç  errno æ˜¯ EBUSYã€‚</p>
<p>å½“ç„¶ï¼Œæ— è®ºæ˜¯è¯·æ±‚è¯»é”è¿˜æ˜¯å†™é”éƒ½æä¾›äº†é™æ—¶ç­‰å¾…åŠŸèƒ½ï¼Œå¦‚æœä¸èƒ½è·å–è¯»å†™é”ï¼Œåˆ™ä¼šé™·å…¥é˜»å¡ï¼Œæœ€å¤šç­‰å¾…åˆ°å‚æ•° <strong>abstime</strong> è®¾ç½®çš„æ—¶é—´ï¼Œå¦‚æœä»ç„¶æ— æ³•è·å¾—é”ï¼Œåˆ™è¿”å›ï¼Œé”™è¯¯ç  errno æ˜¯ ETIMEOUTã€‚</p>
<h4 id="è¯»å†™é”çš„å±æ€§">è¯»å†™é”çš„å±æ€§</h4>
<hr>
<p>ä¸Šæ–‡ä»‹ç» <strong>pthread_rwlock_init</strong> å‡½æ•°æ—¶ï¼Œæåˆ°å…¶ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥è®¾ç½®è¯»å†™é”çš„å±æ€§ï¼Œè¯»å†™é”çš„å±æ€§ç±»å‹æ˜¯ <strong>pthread_rwlockattr_t</strong> ï¼Œglibc å¼•å…¥äº†å¦‚ä¸‹æ¥å£æ¥æŸ¥è¯¢å’Œæ”¹å˜è¯»å†™é”çš„ç±»å‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">pthread_rwlockattr_setkind_np</span><span class="p">(</span><span class="n">pthread_rwlockattr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pref</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_rwlockattr_getkind_np</span><span class="p">(</span><span class="k">const</span> <span class="n">pthread_rwlockattr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">pref</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>pthread_rwlockattr_setkind_np</strong> çš„ç¬¬äºŒä¸ªå‚æ•° <strong>pref</strong> å³è®¾ç½®è¯»å†™é”çš„ç±»å‹ï¼Œå…¶å–å€¼æœ‰å¦‚ä¸‹å‡ ç§ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">enum</span>
<span class="p">{</span>
    <span class="c1">//è¯»è€…ä¼˜å…ˆ(å³åŒæ—¶è¯·æ±‚è¯»é”å’Œå†™é”æ—¶ï¼Œè¯·æ±‚è¯»é”çš„çº¿ç¨‹ä¼˜å…ˆè·å¾—é”)
</span><span class="c1"></span>    <span class="n">PTHREAD_RWLOCK_PREFER_READER_NP</span><span class="p">,</span>
    <span class="c1">//ä¸è¦è¢«åå­—æ‰€è¿·æƒ‘ï¼Œä¹Ÿæ˜¯è¯»è€…ä¼˜å…ˆ
</span><span class="c1"></span>    <span class="n">PTHREAD_RWLOCK_PREFER_WRITER_NP</span><span class="p">,</span>
    <span class="c1">//å†™è€…ä¼˜å…ˆ(å³åŒæ—¶è¯·æ±‚è¯»é”å’Œå†™é”æ—¶ï¼Œè¯·æ±‚å†™é”çš„çº¿ç¨‹ä¼˜å…ˆè·å¾—é”)
</span><span class="c1"></span>    <span class="n">PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP</span><span class="p">,</span>
    <span class="n">PTHREAD_RWLOCK_DEFAULT_NP</span> <span class="o">=</span> <span class="n">PTHREAD_RWLOCK_PREFER_READER_NP</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>å½“ç„¶ï¼Œä¸ºäº†å¾—åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„ <strong>pthread_rwlockattr_t</strong> å¯¹è±¡ï¼Œä½ éœ€è¦è°ƒç”¨ <strong>pthread_rwlockattr_init</strong> å‡½æ•°åˆå§‹åŒ–è¿™æ ·ä¸€ä¸ªå±æ€§å¯¹è±¡ï¼Œåœ¨ä½ ä¸éœ€è¦çš„æ—¶å€™è®°å¾—ä½¿ç”¨ <strong>pthread_rwlockattr_destroy</strong> é”€æ¯ä¹‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">pthread_rwlockattr_init</span><span class="p">(</span><span class="n">pthread_rwlockattr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">pthread_rwlockattr_destroy</span><span class="p">(</span><span class="n">pthread_rwlockattr_t</span><span class="o">*</span> <span class="n">attr</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>ä»¥ä¸‹ä»£ç ç‰‡æ®µæ¼”ç¤ºäº†å¦‚ä½•åˆå§‹åŒ–ä¸€ä¸ªå†™è€…ä¼˜å…ˆçš„è¯»å†™é”ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">pthread_rwlockattr_t</span> <span class="n">attr</span><span class="p">;</span>
<span class="n">pthread_rwlockattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
<span class="n">pthread_rwlockattr_setkind_np</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP</span><span class="p">);</span>
<span class="n">pthread_rwlock_t</span> <span class="n">rwlock</span><span class="p">;</span>
<span class="n">pthread_rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rwlock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="è¯»å†™é”ä½¿ç”¨ç¤ºä¾‹">è¯»å†™é”ä½¿ç”¨ç¤ºä¾‹</h4>
<hr>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="n">resourceID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">pthread_rwlock_t</span> <span class="n">myrwlock</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">read_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//è¯·æ±‚è¯»é”
</span><span class="c1"></span>		<span class="n">pthread_rwlock_rdlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>

		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;read thread ID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">pthread_self</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, resourceID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">resourceID</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

		<span class="c1">//ä½¿ç”¨ç¡çœ æ¨¡æ‹Ÿè¯»çº¿ç¨‹è¯»çš„è¿‡ç¨‹æ¶ˆè€—äº†å¾ˆä¹…çš„æ—¶é—´
</span><span class="c1"></span>		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">pthread_rwlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">write_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//è¯·æ±‚å†™é”
</span><span class="c1"></span>		<span class="n">pthread_rwlock_wrlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>

		<span class="o">++</span><span class="n">resourceID</span><span class="p">;</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;write thread ID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">pthread_self</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, resourceID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">resourceID</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

		<span class="c1">//ä½¿ç”¨ç¡çœ æ¨¡æ‹Ÿè¯»çº¿ç¨‹è¯»çš„è¿‡ç¨‹æ¶ˆè€—äº†å¾ˆä¹…çš„æ—¶é—´
</span><span class="c1"></span>		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">pthread_rwlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">pthread_rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="c1">//åˆ›å»º5ä¸ªè¯·æ±‚è¯»é”çº¿ç¨‹
</span><span class="c1"></span>	<span class="n">pthread_t</span> <span class="n">readThreadID</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readThreadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">read_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="c1">//åˆ›å»ºä¸€ä¸ªè¯·æ±‚å†™é”çº¿ç¨‹
</span><span class="c1"></span>	<span class="n">pthread_t</span> <span class="n">writeThreadID</span><span class="p">;</span>
	<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">writeThreadID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">write_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">pthread_join</span><span class="p">(</span><span class="n">writeThreadID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_join</span><span class="p">(</span><span class="n">readThreadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pthread_rwlock_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ç¨‹åºä¸­åˆ›å»ºäº”ä¸ªè¯·æ±‚è¯»é”çš„â€œè¯»â€çº¿ç¨‹å’Œä¸€ä¸ªè¯·æ±‚å†™é”çš„â€œå†™â€çº¿ç¨‹ï¼Œå…±äº«çš„èµ„æºæ˜¯ä¸€ä¸ªæ•´å½¢å˜é‡ <strong>resourceID</strong>ï¼Œæˆ‘ä»¬ç¼–è¯‘å¹¶æ‰§è¡Œå¾—åˆ°è¾“å‡ºç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># g++ -g -o rwlock rwlock.cpp -lpthread</span>
<span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># ./rwlock</span>
<span class="nb">read</span> thread ID: 140575861593856, resourceID: <span class="m">0</span>
<span class="nb">read</span> thread ID: 140575878379264, resourceID: <span class="m">0</span>
<span class="nb">read</span> thread ID: 140575853201152, resourceID: <span class="m">0</span>
<span class="nb">read</span> thread ID: 140575869986560, resourceID: <span class="m">0</span>
<span class="nb">read</span> thread ID: 140575886771968, resourceID: <span class="m">0</span>
<span class="nb">read</span> thread ID: <span class="nb">read</span> thread ID: <span class="nb">read</span> thread ID: <span class="nb">read</span> thread ID: 140575861593856140575886771968, resourceID: 0, resourceID:
<span class="m">0</span>
140575878379264read thread ID: 140575869986560, resourceID: <span class="m">0</span>
, resourceID: <span class="m">0</span>
140575853201152, resourceID: <span class="m">0</span>
<span class="nb">read</span> thread ID: <span class="nb">read</span> thread ID: <span class="nb">read</span> thread ID: 140575861593856140575853201152140575886771968, resourceID: , resourceID: 0, resourceID: <span class="m">00</span>


<span class="nb">read</span> thread ID: 140575869986560, resourceID: <span class="m">0</span>
...æ›´å¤šè¾“å‡ºç»“æœçœç•¥...
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°è¾“å‡ºç»“æœï¼Œæˆ‘ä»¬éªŒè¯äº†ä¸¤ä¸ªç»“è®ºï¼š</p>
<ul>
<li>ç”±äºè¯»å†™é”å¯¹è±¡ <strong>myrwlock</strong> ä½¿ç”¨äº†é»˜è®¤å±æ€§ï¼Œå…¶è¡Œä¸ºæ˜¯è¯·æ±‚è¯»é”çš„çº¿ç¨‹ä¼˜å…ˆè·å¾—åˆ°é”ï¼Œè¯·æ±‚å†™é”çš„çº¿ç¨‹ <strong>write_thread</strong> å¾ˆéš¾è·å¾—é”çš„æœºä¼šï¼Œå› æ­¤ç»“æœä¸­åŸºæœ¬æ²¡æœ‰è¯·æ±‚å†™é”çº¿ç¨‹çš„è¾“å‡ºç»“æœã€‚</li>
<li>ç”±äºå¤šä¸ªè¯·æ±‚è¯»é”çš„çº¿ç¨‹ <strong>read_thread</strong> å¯ä»¥è‡ªç”±è·å¾—è¯»é”ï¼Œä¸”ä»£ç  <strong>15</strong> è¡Œï¼ˆstd::cout &laquo; â€œread thread ID: â€œ &laquo; pthread_self() &laquo; â€œ, resourceID: â€œ &laquo; resourceID &laquo; std::endl;ï¼‰çš„è¾“å‡ºä¸æ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥å¤šä¸ªâ€œè¯»â€çº¿ç¨‹çš„è¾“å‡ºå¯èƒ½ä¼šäº¤æ›¿ï¼Œå‡ºç°â€œé”™ä¹±â€ç°è±¡ã€‚</li>
</ul>
<p>æˆ‘ä»¬å°†è¯»å†™é”å¯¹è±¡ <strong>myrwlock</strong> çš„å±æ€§ä¿®æ”¹æˆè¯·æ±‚å†™é”ä¼˜å…ˆï¼Œå†æ¥è¯•ä¸€è¯•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="n">resourceID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">pthread_rwlock_t</span> <span class="n">myrwlock</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">read_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//è¯·æ±‚è¯»é”
</span><span class="c1"></span>		<span class="n">pthread_rwlock_rdlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>

		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;read thread ID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">pthread_self</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, resourceID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">resourceID</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

		<span class="c1">//ä½¿ç”¨ç¡çœ æ¨¡æ‹Ÿè¯»çº¿ç¨‹è¯»çš„è¿‡ç¨‹æ¶ˆè€—äº†å¾ˆä¹…çš„æ—¶é—´
</span><span class="c1"></span>		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">pthread_rwlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">write_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//è¯·æ±‚å†™é”
</span><span class="c1"></span>		<span class="n">pthread_rwlock_wrlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>

		<span class="o">++</span><span class="n">resourceID</span><span class="p">;</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;write thread ID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">pthread_self</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, resourceID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">resourceID</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

		<span class="c1">//ä½¿ç”¨ç¡çœ æ¨¡æ‹Ÿè¯»çº¿ç¨‹è¯»çš„è¿‡ç¨‹æ¶ˆè€—äº†å¾ˆä¹…çš„æ—¶é—´
</span><span class="c1"></span>		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">pthread_rwlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">pthread_rwlockattr_t</span> <span class="n">attr</span><span class="p">;</span>
	<span class="n">pthread_rwlockattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="c1">//è®¾ç½®æˆè¯·æ±‚å†™é”ä¼˜å…ˆ
</span><span class="c1"></span>	<span class="n">pthread_rwlockattr_setkind_np</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP</span><span class="p">);</span>
	<span class="n">pthread_rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>

	<span class="c1">//åˆ›å»º5ä¸ªè¯·æ±‚è¯»é”çº¿ç¨‹
</span><span class="c1"></span>	<span class="n">pthread_t</span> <span class="n">readThreadID</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readThreadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">read_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="c1">//åˆ›å»ºä¸€ä¸ªè¯·æ±‚å†™é”çº¿ç¨‹
</span><span class="c1"></span>	<span class="n">pthread_t</span> <span class="n">writeThreadID</span><span class="p">;</span>
	<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">writeThreadID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">write_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">pthread_join</span><span class="p">(</span><span class="n">writeThreadID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_join</span><span class="p">(</span><span class="n">readThreadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pthread_rwlock_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç¼–è¯‘ç¨‹åºå¹¶è¿è¡Œï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># g++ -g -o rwlock2 rwlock2.cpp -lpthread</span>
<span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># ./rwlock2</span>
<span class="nb">read</span> thread ID: 140122217539328, resourceID: <span class="m">0</span>
<span class="nb">read</span> thread ID: 140122242717440, resourceID: <span class="m">0</span>
<span class="nb">read</span> thread ID: 140122209146624, resourceID: <span class="m">0</span>
write thread ID: 140122200753920, resourceID: <span class="m">1</span>
<span class="nb">read</span> thread ID: 140122234324736, resourceID: <span class="m">1</span>
write thread ID: 140122200753920, resourceID: <span class="m">2</span>
write thread ID: 140122200753920, resourceID: <span class="m">3</span>
write thread ID: 140122200753920, resourceID: <span class="m">4</span>
write thread ID: 140122200753920, resourceID: <span class="m">5</span>
write thread ID: 140122200753920, resourceID: <span class="m">6</span>
write thread ID: 140122200753920, resourceID: <span class="m">7</span>
write thread ID: 140122200753920, resourceID: <span class="m">8</span>
write thread ID: 140122200753920, resourceID: <span class="m">9</span>
write thread ID: 140122200753920, resourceID: <span class="m">10</span>
write thread ID: 140122200753920, resourceID: <span class="m">11</span>
write thread ID: 140122200753920, resourceID: <span class="m">12</span>
write thread ID: 140122200753920, resourceID: <span class="m">13</span>
<span class="nb">read</span> thread ID: 140122217539328, resourceID: <span class="m">13</span>
write thread ID: 140122200753920, resourceID: <span class="m">14</span>
write thread ID: 140122200753920, resourceID: <span class="m">15</span>
write thread ID: 140122200753920, resourceID: <span class="m">16</span>
write thread ID: 140122200753920, resourceID: <span class="m">17</span>
write thread ID: 140122200753920, resourceID: <span class="m">18</span>
write thread ID: 140122200753920, resourceID: <span class="m">19</span>
write thread ID: 140122200753920, resourceID: <span class="m">20</span>
write thread ID: 140122200753920, resourceID: <span class="m">21</span>
write thread ID: 140122200753920, resourceID: <span class="m">22</span>
write thread ID: 140122200753920, resourceID: <span class="m">23</span>
...æ›´å¤šè¾“å‡ºç»“æœçœç•¥...
</code></pre></td></tr></table>
</div>
</div><p>ç”±äºå°† <strong>myrwlock</strong> è®¾ç½®æˆè¯·æ±‚å†™é”ä¼˜å…ˆï¼Œä¸Šè¿°ç»“æœä¸­å‡ ä¹éƒ½æ˜¯ <strong>write_thread</strong> çš„è¾“å‡ºç»“æœã€‚</p>
<p>æˆ‘ä»¬å°† <strong>write_thread</strong> ä¸­çš„ <strong>37</strong> è¡Œ sleep è¯­å¥æŒªåˆ° <strong>39</strong> è¡Œåé¢ï¼Œå¢åŠ è¯·æ±‚å†™é”çº¿ç¨‹çš„ç¡çœ æ—¶é—´ï¼Œå†çœ‹çœ‹æ‰§è¡Œç»“æœã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="n">resourceID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">pthread_rwlock_t</span> <span class="n">myrwlock</span><span class="p">;</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">read_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//è¯·æ±‚è¯»é”
</span><span class="c1"></span>		<span class="n">pthread_rwlock_rdlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>

		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;read thread ID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">pthread_self</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, resourceID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">resourceID</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

		<span class="c1">//ä½¿ç”¨ç¡çœ æ¨¡æ‹Ÿè¯»çº¿ç¨‹è¯»çš„è¿‡ç¨‹æ¶ˆè€—äº†å¾ˆä¹…çš„æ—¶é—´
</span><span class="c1"></span>		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">pthread_rwlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">write_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//è¯·æ±‚å†™é”
</span><span class="c1"></span>		<span class="n">pthread_rwlock_wrlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>

		<span class="o">++</span><span class="n">resourceID</span><span class="p">;</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;write thread ID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">pthread_self</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, resourceID: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">resourceID</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

		<span class="n">pthread_rwlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>

		<span class="c1">//æ”¾åœ¨è¿™é‡Œå¢åŠ è¯·æ±‚è¯»é”çº¿ç¨‹è·å¾—é”çš„å‡ ç‡
</span><span class="c1"></span>		<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">pthread_rwlockattr_t</span> <span class="n">attr</span><span class="p">;</span>
	<span class="n">pthread_rwlockattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
	<span class="c1">//è®¾ç½®æˆè¯·æ±‚å†™é”ä¼˜å…ˆ
</span><span class="c1"></span>	<span class="n">pthread_rwlockattr_setkind_np</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP</span><span class="p">);</span>
	<span class="n">pthread_rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>

	<span class="c1">//åˆ›å»º5ä¸ªè¯·æ±‚è¯»é”çº¿ç¨‹
</span><span class="c1"></span>	<span class="n">pthread_t</span> <span class="n">readThreadID</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readThreadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">read_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="c1">//åˆ›å»ºä¸€ä¸ªè¯·æ±‚å†™é”çº¿ç¨‹
</span><span class="c1"></span>	<span class="n">pthread_t</span> <span class="n">writeThreadID</span><span class="p">;</span>
	<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">writeThreadID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">write_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">pthread_join</span><span class="p">(</span><span class="n">writeThreadID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pthread_join</span><span class="p">(</span><span class="n">readThreadID</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pthread_rwlock_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myrwlock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å†æ¬¡ç¼–è¯‘ç¨‹åºå¹¶æ‰§è¡Œï¼Œå¾—åˆ°è¾“å‡ºç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># g++ -g -o rwlock3 rwlock3.cpp -lpthread</span>
<span class="o">[</span>root@localhost testmultithread<span class="o">]</span><span class="c1"># ./rwlock3</span>
<span class="nb">read</span> thread ID: 140315524790016, resourceID: <span class="m">0</span>
<span class="nb">read</span> thread ID: 140315549968128, resourceID: <span class="m">0</span>
<span class="nb">read</span> thread ID: 140315541575424, resourceID: <span class="m">0</span>
write thread ID: 140315508004608, resourceID: <span class="m">1</span>
<span class="nb">read</span> thread ID: 140315549968128, resourceID: <span class="m">1</span>
<span class="nb">read</span> thread ID: 140315541575424, resourceID: <span class="m">1</span>
<span class="nb">read</span> thread ID: 140315524790016, resourceID: <span class="m">1</span>
<span class="nb">read</span> thread ID: 140315516397312, resourceID: <span class="m">1</span>
<span class="nb">read</span> thread ID: 140315533182720, resourceID: <span class="m">1</span>
write thread ID: 140315508004608, resourceID: <span class="m">2</span>
<span class="nb">read</span> thread ID: 140315541575424, resourceID: <span class="m">2</span>
<span class="nb">read</span> thread ID: 140315524790016, resourceID: <span class="m">2</span>
<span class="nb">read</span> thread ID: 140315533182720, resourceID: <span class="m">2</span>
<span class="nb">read</span> thread ID: 140315516397312, resourceID: <span class="m">2</span>
<span class="nb">read</span> thread ID: 140315549968128, resourceID: <span class="m">2</span>
<span class="nb">read</span> thread ID: 140315516397312, resourceID: <span class="m">2</span>
write thread ID: 140315508004608, resourceID: <span class="m">3</span>
<span class="nb">read</span> thread ID: 140315549968128, resourceID: <span class="m">3</span>
<span class="nb">read</span> thread ID: 140315541575424, resourceID: <span class="m">3</span>
<span class="nb">read</span> thread ID: 140315533182720, resourceID: 3read thread ID: <span class="nb">read</span> thread ID: 140315524790016, resourceID: <span class="m">3</span>
140315516397312, resourceID: <span class="m">3</span>

<span class="nb">read</span> thread ID: <span class="nb">read</span> thread ID: <span class="nb">read</span> thread ID: 140315524790016140315549968128, resourceID: , resourceID: <span class="m">33</span>
140315516397312, resourceID: <span class="m">3</span>
<span class="nb">read</span> thread ID: 140315541575424, resourceID: <span class="nb">read</span> thread ID: 140315533182720, resourceID: <span class="m">3</span>
<span class="m">3</span>

write thread ID: 140315508004608, resourceID: <span class="m">4</span>
<span class="nb">read</span> thread ID: 140315516397312, resourceID: <span class="m">4</span>
<span class="nb">read</span> thread ID: 140315541575424, resourceID: <span class="m">4</span>
<span class="nb">read</span> thread ID: 140315524790016, resourceID: <span class="m">4</span>
<span class="nb">read</span> thread ID: 140315549968128, resourceID: <span class="m">4</span>
<span class="nb">read</span> thread ID: 140315533182720, resourceID: <span class="m">4</span>
<span class="nb">read</span> thread ID: 140315524790016, resourceID: <span class="m">4</span>
<span class="nb">read</span> thread ID: 140315541575424, resourceID: <span class="m">4</span>
write thread ID: 140315508004608, resourceID: <span class="m">5</span>
<span class="nb">read</span> thread ID: 140315516397312, resourceID: <span class="m">5</span>
<span class="nb">read</span> thread ID: 140315541575424, resourceID: <span class="m">5</span>
<span class="nb">read</span> thread ID: 140315524790016, resourceID: <span class="m">5</span>
<span class="nb">read</span> thread ID: 140315533182720, resourceID: <span class="m">5</span>
<span class="nb">read</span> thread ID: 140315549968128, resourceID: <span class="m">5</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ¬¡è¯·æ±‚è¯»é”çš„çº¿ç¨‹å’Œè¯·æ±‚å†™é”çš„çº¿ç¨‹çš„è¾“å‡ºç»“æœåˆ†å¸ƒå°±æ¯”è¾ƒå‡åŒ€äº†ã€‚</p>
<h2 id="5-å¦‚ä½•ç¡®ä¿åˆ›å»ºçš„çº¿ç¨‹ä¸€å®šè¿è¡Œèµ·æ¥">5. å¦‚ä½•ç¡®ä¿åˆ›å»ºçš„çº¿ç¨‹ä¸€å®šè¿è¡Œèµ·æ¥ï¼Ÿ</h2>
<hr>
<p>åœ¨æœ¬ç« å¼€å¤´çš„å°èŠ‚é‡Œé¢æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•åˆ›å»ºçº¿ç¨‹ï¼Œä½†æ˜¯å¾ˆå°‘æœ‰äººä¼šæ³¨æ„åˆ°åˆ›å»ºçš„çº¿ç¨‹å¦‚ä½•ç¡®ä¿ä¸€å®šè¿è¡Œèµ·æ¥äº†ï¼Ÿå¾ˆå¤šäººä¼šè¯´ï¼Œå¯¹äºä½¿ç”¨ç³»ç»Ÿ API åˆ›å»ºçš„çº¿ç¨‹ï¼Œåªéœ€è¦åˆ¤æ–­ä¸€ä¸‹åˆ›å»ºçš„çº¿ç¨‹å‡½æ•°æ˜¯å¦æ˜¯è°ƒç”¨æˆåŠŸçš„ï¼Œè¿™åªåšäº†ä¸€æ­¥ï¼Œçº¿ç¨‹å‡½æ•°è°ƒç”¨æˆåŠŸï¼Œä¹Ÿæ²¡æ³•ç™¾åˆ†ç™¾ä¿è¯çº¿ç¨‹å‡½æ•°ä¸€å®šè¿è¡Œèµ·æ¥äº†ã€‚</p>
<p>åœ¨ä¸€äº›â€œå¤è€â€æˆ–è€…â€œä¸¥è°¨â€çš„é¡¹ç›®ä¸­ï¼Œä½ ä¼šå‘ç°è¿™äº›ä»£ç åˆ›å»ºçº¿ç¨‹æ—¶ä¸ä»…åˆ¤æ–­çº¿ç¨‹åˆ›å»ºå‡½æ•°æ˜¯å¦è°ƒç”¨æˆåŠŸï¼Œè¿˜ä¼šåœ¨çº¿ç¨‹å‡½æ•°ä¸­åˆ©ç”¨ä¸Šæ–‡ä»‹ç»çš„ä¸€äº›çº¿ç¨‹åŒæ­¥å¯¹è±¡æ¥é€šçŸ¥çº¿ç¨‹çš„åˆ›å»ºè€…çº¿ç¨‹æ˜¯å¦åˆ›å»ºæˆåŠŸã€‚æˆ‘ä»¬æ¥çœ‹ä¸€æ®µè¿™æ ·çš„ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;mutex&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;condition_variable&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">std</span><span class="o">::</span><span class="n">mutex</span> 				<span class="n">mymutex</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">mycv</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">thread_func</span><span class="p">()</span>
<span class="p">{</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mymutex</span><span class="p">);</span>
        <span class="n">success</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">mycv</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">//å®é™…çš„çº¿ç¨‹æ‰§è¡Œçš„å·¥ä½œä»£ç æ”¾åœ¨ä¸‹é¢
</span><span class="c1"></span>    <span class="c1">//è¿™é‡Œä¸ºäº†æ¨¡æ‹Ÿæ–¹ä¾¿ï¼Œç®€å•åœ°å†™ä¸ªæ­»å¾ªç¯
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t</span><span class="p">(</span><span class="n">thread_func</span><span class="p">);</span>

    <span class="c1">//ä½¿ç”¨èŠ±æ‹¬å·å‡å°é”çš„ç²’åº¦
</span><span class="c1"></span>    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mymutex</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">mycv</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;start thread successfully.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç ï¼Œå‘å‡ºä¸€ä¸ªåˆ›å»ºæ–°çº¿ç¨‹çš„è¯·æ±‚åï¼Œç«‹åˆ»é˜»å¡åœ¨ä¸€ä¸ªæ¡ä»¶å˜é‡ä¸Šï¼Œå·¥ä½œçº¿ç¨‹å¦‚æœæˆåŠŸè¿è¡Œèµ·æ¥ï¼Œä¼šå‘é€æ¡ä»¶å˜é‡ä¿¡å·å‘ŠçŸ¥ä¸»çº¿ç¨‹ï¼Œè¿™æ ·ä¸»çº¿ç¨‹å°±çŸ¥é“æ–°çº¿ç¨‹ä¸€å®šæˆåŠŸè¿è¡Œèµ·æ¥äº†ã€‚</p>
<p>åŸºäºä»¥ä¸Šæ€è·¯ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ç»„çº¿ç¨‹æ—¶ï¼Œå¯ä»¥ä¸€ä¸ªåœ°åˆ›å»ºï¼Œæ¯æˆåŠŸè¿è¡Œä¸€ä¸ªæ–°çº¿ç¨‹å†åˆ›å»ºä¸‹ä¸€ä¸ªï¼Œç¡®ä¿çº¿ç¨‹ç»„ä¸­çš„æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è¿è¡Œèµ·æ¥ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;mutex&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;condition_variable&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">std</span><span class="o">::</span><span class="n">mutex</span> 				<span class="n">mymutex</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">mycv</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">thread_func</span><span class="p">()</span>
<span class="p">{</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mymutex</span><span class="p">);</span>
        <span class="n">success</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">mycv</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">//å®é™…çš„çº¿ç¨‹æ‰§è¡Œçš„å·¥ä½œä»£ç æ”¾åœ¨ä¸‹é¢
</span><span class="c1"></span>    <span class="c1">//è¿™é‡Œä¸ºäº†æ¨¡æ‹Ÿæ–¹ä¾¿ï¼Œç®€å•åœ°å†™ä¸ªæ­»å¾ªç¯
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;&gt;</span> <span class="n">threads</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">spthread</span><span class="p">;</span>
        <span class="n">spthread</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">new</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">thread_func</span><span class="p">));</span>

        <span class="c1">//ä½¿ç”¨èŠ±æ‹¬å·å‡å°é”çš„ç²’åº¦
</span><span class="c1"></span>        <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mymutex</span><span class="p">);</span>
            <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">mycv</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;start thread successfullyï¼Œ index: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

        <span class="n">threads</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">spthread</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">iter</span> <span class="p">:</span> <span class="n">threads</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">iter</span><span class="o">-&gt;</span><span class="n">join</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç¼–è¯‘ä¸Šè¿°ç¨‹åºå¹¶è¿è¡Œï¼Œç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">root on 127.0.0.1.16clouds.com in ~
$ g++ -g -o makesurethreadgroup makesurethreadgroup.cpp -std<span class="o">=</span>c++0x -lpthread
root on 127.0.0.1.16clouds.com in ~
$ ./makesurethreadgroup
start thread successfullyï¼Œ index: <span class="m">0</span>
start thread successfullyï¼Œ index: <span class="m">1</span>
start thread successfullyï¼Œ index: <span class="m">2</span>
start thread successfullyï¼Œ index: <span class="m">3</span>
start thread successfullyï¼Œ index: <span class="m">4</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ï¼Œæ–°çº¿ç¨‹æŒ¨ä¸ªè¿è¡Œèµ·æ¥ã€‚å½“ç„¶ï¼Œä½ ä¸ä¸€å®šè¦ä½¿ç”¨æ¡ä»¶å˜é‡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ç±»å‹çš„çº¿ç¨‹åŒæ­¥å¯¹è±¡ï¼Œå¦‚ Windows å¹³å°çš„ Event å¯¹è±¡ç­‰ç­‰ã€‚</p>
<h2 id="6-é”ä½¿ç”¨å®è·µç»éªŒæ€»ç»“">6. é”ä½¿ç”¨å®è·µç»éªŒæ€»ç»“</h2>
<hr>
<h3 id="å‡å°‘é”çš„ä½¿ç”¨">å‡å°‘é”çš„ä½¿ç”¨</h3>
<hr>
<p>å®é™…å¼€å‘ä¸­èƒ½ä¸ä½¿ç”¨é”å°½é‡ä¸ä½¿ç”¨é”ï¼Œå½“ç„¶è¿™ä¸æ˜¯ç»å¯¹çš„ï¼Œå¦‚æœä½¿ç”¨é”ä¹Ÿèƒ½æ»¡è¶³æ€§èƒ½è¦æ±‚ï¼Œä½¿ç”¨é”ä¹Ÿæ— å¦¨ï¼Œä¸€èˆ¬ä½¿ç”¨äº†é”çš„ä»£ç ä¼šå¸¦æ¥å¦‚ä¸‹æ€§èƒ½æŸå¤±ï¼š</p>
<ul>
<li>åŠ é”å’Œè§£é”æ“ä½œï¼Œæœ¬èº«æœ‰ä¸€å®šçš„å¼€é”€ï¼›</li>
<li>ä¸´ç•ŒåŒºçš„ä»£ç ä¸èƒ½å¹¶å‘æ‰§è¡Œï¼›</li>
<li>è¿›å…¥ä¸´ç•ŒåŒºçš„æ¬¡æ•°è¿‡äºé¢‘ç¹ï¼Œçº¿ç¨‹ä¹‹é—´å¯¹ä¸´ç•ŒåŒºçš„äº‰å¤ºå¤ªè¿‡æ¿€çƒˆï¼Œè‹¥çº¿ç¨‹ç«äº‰äº’æ–¥é‡å¤±è´¥ï¼Œå°±ä¼šé™·å…¥é˜»å¡ï¼Œè®©å‡º CPUï¼Œæ‰€ä»¥æ‰§è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¬¡æ•°è¦è¿œè¿œå¤šäºä¸ä½¿ç”¨äº’æ–¥é‡çš„ç‰ˆæœ¬ã€‚</li>
</ul>
<p>æ›¿ä»£é”çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œå¦‚æ— é”é˜Ÿåˆ—ã€‚</p>
<h3 id="æ˜ç¡®é”çš„èŒƒå›´">æ˜ç¡®é”çš„èŒƒå›´</h3>
<hr>
<p>çœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">if</span><span class="p">(</span><span class="n">hashtable</span><span class="p">.</span><span class="n">is_empty</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
    <span class="n">htable_insert</span><span class="p">(</span><span class="n">hashtable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem</span><span class="p">);</span>
    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>èƒ½çœ‹å‡ºè¿™æ®µä»£ç çš„é—®é¢˜å—ï¼Ÿä»£ç è¡Œ <strong>4</strong> è™½ç„¶å¯¹ <strong>hashtable</strong> çš„æ’å…¥ä½¿ç”¨äº†é”åšä¿æŠ¤ï¼Œä½†æ˜¯åˆ¤æ–­ <strong>hash_table</strong> æ˜¯å¦ä¸ºç©ºä¹Ÿéœ€è¦ä½¿ç”¨é”ä¿æŠ¤ï¼Œæ‰€ä»¥æ­£ç¡®çš„å†™æ³•åº”è¯¥æ˜¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">hashtable</span><span class="p">.</span><span class="n">is_empty</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">htable_insert</span><span class="p">(</span><span class="n">hashtable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">elem</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="å‡å°‘é”çš„ç²’åº¦">å‡å°‘é”çš„ç²’åº¦</h3>
<hr>
<p>æ‰€è°“å‡å°é”ä½¿ç”¨ç²’åº¦æŒ‡çš„æ˜¯å°½é‡å‡å°é”ä½œç”¨çš„ä¸´ç•ŒåŒºä»£ç èŒƒå›´ï¼Œä¸´ç•ŒåŒºçš„ä»£ç èŒƒå›´è¶Šå°ï¼Œå¤šä¸ªçº¿ç¨‹æ’é˜Ÿè¿›å…¥ä¸´ç•ŒåŒºçš„æ—¶é—´å°±ä¼šè¶ŠçŸ­ã€‚è¿™å°±ç±»ä¼¼é«˜é€Ÿå…¬è·¯ä¸Šå µè½¦ï¼Œå¦‚æœå µè½¦çš„è·¯æ®µè¶Šé•¿ï¼Œé‚£ä¹ˆåç»­è¿‡æ¥çš„è½¦è¾†é€šè¡Œç­‰å¾…æ—¶é—´å°±ä¼šè¶Šé•¿ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸¤ä¸ªå…·ä½“çš„ä¾‹å­ï¼š</p>
<p><strong>ç¤ºä¾‹ä¸€</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="n">TaskPool</span><span class="o">::</span><span class="n">addTask</span><span class="p">(</span><span class="n">Task</span><span class="o">*</span> <span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">guard</span><span class="p">(</span><span class="n">m_mutexList</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span> <span class="n">spTask</span><span class="p">;</span>
    <span class="n">spTask</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
    <span class="n">m_taskList</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">spTask</span><span class="p">);</span>

    <span class="n">m_cv</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç ä¸­ <strong>guard</strong> é”ä¿æŠ¤ <strong>m_taskList</strong>ï¼Œä»”ç»†åˆ†æä¸‹è¿™æ®µä»£ç å‘ç°ï¼Œä»£ç è¡Œ <strong>4</strong>ã€<strong>5</strong> å’Œ <strong>8</strong> è¡Œå…¶å®æ²¡å¿…è¦ä½œä¸ºä¸´ç•ŒåŒºå†…çš„ä»£ç çš„ï¼Œæ‰€ä»¥å»ºè®®æŒªåˆ°ä¸´ç•ŒåŒºå¤–é¢å»ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="n">TaskPool</span><span class="o">::</span><span class="n">addTask</span><span class="p">(</span><span class="n">Task</span><span class="o">*</span> <span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Task</span><span class="o">&gt;</span> <span class="n">spTask</span><span class="p">;</span>
    <span class="n">spTask</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>

    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">guard</span><span class="p">(</span><span class="n">m_mutexList</span><span class="p">);</span>
        <span class="n">m_taskList</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">spTask</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">m_cv</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹ä¹‹åï¼Œ <strong>guard</strong> é”çš„ä½œç”¨èŒƒå›´å°±æ˜¯ <strong>7</strong> ã€<strong>8</strong> ä¸¤è¡Œäº†ï¼Œä»…å¯¹ **m_taskList.push_back() **æ“ä½œåšä¿æŠ¤ï¼Œè¿™æ ·é”çš„ç²’åº¦å°±å˜å°äº†ã€‚</p>
<p><strong>ç¤ºä¾‹äºŒ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">doPendingFunctors</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pendingFunctors_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pendingFunctors_</span><span class="p">[</span><span class="n">i</span><span class="p">]();</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°ä»£ç ä¸­ **pendingFunctors_** æ˜¯è¢«é”ä¿æŠ¤çš„å¯¹è±¡ï¼Œå®ƒçš„ç±»å‹æ˜¯ **std::vector**ï¼Œè¿™æ ·çš„ä»£ç æ•ˆç‡æ¯”è¾ƒä½ï¼Œå¿…é¡»ç­‰å½“å‰çº¿ç¨‹æŒ¨ä¸ªå¤„ç†å®Œ **pendingFunctors_** ä¸­çš„å…ƒç´ åå…¶ä»–çº¿ç¨‹æ‰èƒ½æ“ä½œ **pendingFunctors_** ã€‚ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="n">EventLoop</span><span class="o">::</span><span class="n">doPendingFunctors</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Functor</span><span class="o">&gt;</span> <span class="n">functors</span><span class="p">;</span>

	<span class="p">{</span>
		<span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
		<span class="n">functors</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">pendingFunctors_</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">functors</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">functors</span><span class="p">[</span><span class="n">i</span><span class="p">]();</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹ä¹‹åçš„ä»£ç ä½¿ç”¨äº†ä¸€ä¸ªå±€éƒ¨å˜é‡ <strong>functors</strong>ï¼Œç„¶åæŠŠ **pendingFunctors_** ä¸­çš„å†…å®¹å€’æ¢åˆ° **functors** ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥é‡Šæ”¾é”äº†ï¼Œå…è®¸å…¶ä»–çº¿ç¨‹æ“ä½œ **pendingFunctors_** ï¼Œç°åœ¨åªè¦ç»§ç»­æ“ä½œæœ¬åœ°å¯¹è±¡ **functors** å°±å¯ä»¥äº†ï¼Œæé«˜äº†æ•ˆç‡ã€‚</p>
<h3 id="é¿å…æ­»é”çš„ä¸€äº›å»ºè®®">é¿å…æ­»é”çš„ä¸€äº›å»ºè®®</h3>
<ul>
<li><strong>ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå¦‚æœæœ‰ä¸€ä¸ªåŠ é”æ“ä½œï¼Œé‚£ä¹ˆä¸€å®šè¦è®°å¾—åœ¨å‡½æ•°é€€å‡ºæ—¶è®°å¾—è§£é”ï¼Œä¸”æ¯ä¸ªé€€å‡ºè·¯å¾„ä¸Šéƒ½ä¸è¦å¿˜è®°è§£é”è·¯å¾„ã€‚</strong></li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">some_func</span><span class="p">()</span>
<span class="p">{</span>
	<span class="c1">//åŠ é”ä»£ç 
</span><span class="c1"></span>
	<span class="k">if</span> <span class="p">(</span><span class="err">æ¡ä»¶</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//å…¶ä»–ä»£ç 
</span><span class="c1"></span>		<span class="c1">//è§£é”ä»£ç 
</span><span class="c1"></span>		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="c1">//å…¶ä»–ä»£ç 
</span><span class="c1"></span>		<span class="c1">//è§£é”ä»£ç 
</span><span class="c1"></span>		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="err">æ¡ä»¶</span><span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="err">æ¡ä»¶</span><span class="mi">3</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="c1">//å…¶ä»–ä»£ç 
</span><span class="c1"></span>			<span class="c1">//è§£é”ä»£ç 
</span><span class="c1"></span>			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="err">æ¡ä»¶</span><span class="mi">4</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="c1">//å…¶ä»–ä»£ç 
</span><span class="c1"></span>			<span class="c1">//è§£é”ä»£ç 
</span><span class="c1"></span>			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="err">æ¡ä»¶</span><span class="mi">5</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="err">æ¡ä»¶</span><span class="mi">6</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="c1">//å…¶ä»–ä»£ç 
</span><span class="c1"></span>			<span class="c1">//è§£é”ä»£ç 
</span><span class="c1"></span>			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šè¿°å‡½æ•°ä¸­æ¯ä¸ªé€»è¾‘å‡ºå£å¤„éƒ½éœ€è¦å†™ä¸Šè§£é”ä»£ç ã€‚å‰é¢ä¹Ÿè¯´è¿‡ï¼Œè¿™ç§é€»è¾‘éå¸¸å®¹æ˜“å› ä¸ºç–å¿½å¿˜è®°åœ¨æŸä¸ªåœ°æ–¹åŠ ä¸Šè§£é”ä»£ç è€Œé€ æˆæ­»é”ï¼Œæ‰€ä»¥ä¸€èˆ¬å»ºè®®ä½¿ç”¨ RAII æŠ€æœ¯å°†åŠ é”å’Œè§£é”ä»£ç å°è£…èµ·æ¥ã€‚</p>
<ul>
<li><strong>çº¿ç¨‹é€€å‡ºæ—¶ä¸€å®šè¦åŠæ—¶é‡Šæ”¾å…¶æŒæœ‰çš„é”</strong></li>
</ul>
<p>å®é™…å¼€å‘ä¸­ä¼šå› ä¸€äº›ç‰¹æ®Šéœ€æ±‚åˆ›å»ºä¸€äº›ä¸´æ—¶çº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹æ‰§è¡Œå®Œç›¸åº”çš„ä»»åŠ¡åå°±ä¼šé€€å‡ºã€‚å¯¹äºè¿™ç±»çº¿ç¨‹ï¼Œå¦‚æœå…¶æŒæœ‰äº†é”ï¼Œä¸€å®šè®°å¾—åœ¨çº¿ç¨‹é€€å‡ºæ—¶è®°å¾—é‡Šæ”¾å…¶æŒæœ‰çš„é”å¯¹è±¡ã€‚</p>
<ul>
<li><strong>å¤šçº¿ç¨‹è¯·æ±‚é”çš„æ–¹å‘è¦ä¸€è‡´ï¼Œä»¥é¿å…æ­»é”</strong></li>
</ul>
<p>å‡è®¾ç°åœ¨æœ‰ä¸¤ä¸ªé” A å’Œ Bï¼Œçº¿ç¨‹ 1 åœ¨è¯·æ±‚äº†é” A ä¹‹åå†è¯·æ±‚ Bï¼Œçº¿ç¨‹ 2 åœ¨è¯·æ±‚äº†é” B åå†è¯·æ±‚é” Aï¼Œè¿™ç§çº¿ç¨‹è¯·æ±‚é”çš„æ–¹å‘å°±ä¸ä¸€è‡´äº†ï¼Œçº¿ç¨‹ 1 çš„æ–¹å‘æ˜¯ä» A åˆ° Bï¼Œçº¿ç¨‹ 2 çš„æ–¹å‘æ˜¯ä» B åˆ° Aï¼Œå¤šä¸ªçº¿ç¨‹è¯·æ±‚é”çš„æ–¹å‘ä¸ä¸€è‡´å®¹æ˜“é€ æˆæ­»é”ã€‚æ‰€ä»¥å»ºè®®çš„æ–¹å¼æ˜¯ çº¿ç¨‹ 1 å’Œ çº¿ç¨‹ 2 è¯·æ±‚é”çš„æ–¹å‘ä¿æŒä¸€è‡´ï¼Œè¦ä¹ˆéƒ½ä» A åˆ° Bï¼Œè¦ä¹ˆéƒ½ä» B åˆ° Aã€‚</p>
<ul>
<li><strong>å½“éœ€è¦åŒä¸€ä¸ªçº¿ç¨‹é‡å¤è¯·æ±‚ä¸€ä¸ªé”æ—¶ï¼Œææ¸…æ¥šä½ æ‰€ä½¿ç”¨çš„é”çš„è¡Œä¸ºï¼Œæ˜¯é€’å¢é”å¼•ç”¨è®¡æ•°ï¼Œè¿˜æ˜¯ä¼šé˜»å¡æŠ‘æˆ–æ˜¯ç›´æ¥è·å¾—é”ï¼Ÿ</strong></li>
</ul>
<h3 id="é¿å…æ´»é”çš„ä¸€äº›å»ºè®®">é¿å…æ´»é”çš„ä¸€äº›å»ºè®®</h3>
<p>å‰é¢è¯´äº†é¿å…â€œæ­»é”â€ï¼Œè¯»è€…åº”è¯¥èƒ½ç†è§£ï¼Œä½†æ˜¯è¿™é‡Œçªç„¶å‡ºç°äº†é¿å…â€œæ´»é”â€ï¼Œæˆ‘ç›¸ä¿¡å¾ˆå¤šäººçœ‹åˆ°è¿™ä¸ªæ ‡é¢˜ä¸€ä¸‹å­å°±æ‡µäº†ã€‚æ‰€è°“æ´»é”å°±æ˜¯ï¼Œå½“å¤šä¸ªçº¿ç¨‹ä½¿ç”¨ <strong>trylock</strong> ç³»åˆ—çš„å‡½æ•°æ—¶ï¼Œç”±äºå¤šä¸ªçº¿ç¨‹ç›¸äº’è°¦è®©ï¼Œå¯¼è‡´å³ä½¿åœ¨æŸæ®µæ—¶é—´å†…é”èµ„æºæ˜¯å¯ç”¨çš„ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´éœ€è¦é”çš„çº¿ç¨‹æ‹¿ä¸åˆ°é”ã€‚ä¸¾ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼Œé©¬è·¯ä¸Šä¸¤ä¸ªäººè¿é¢èµ°æ¥ï¼Œä¸¤ä¸ªäººåŒæ—¶å¾€ä¸€ä¸ªæ–¹å‘é¿è®©ï¼ŒåŸæ¥æœ¬æ„æ˜¯ç»™å¯¹æ–¹è®©è·¯ï¼Œç»“æœè¿˜æ˜¯å‘ç”Ÿäº†ç¢°æ’ã€‚</p>
<p>æˆ‘ä»¬åœ¨å®é™…ç¼–ç æ—¶ï¼Œå°½é‡é¿å…ä¸è¦è¿‡å¤šçš„çº¿ç¨‹ä½¿ç”¨ <strong>trylock</strong> è¯·æ±‚é”ï¼Œä»¥å…å‡ºç°â€œæ´»é”â€ç°è±¡ï¼Œè¿™æ˜¯å¯¹èµ„æºçš„ä¸€ç§æµªè´¹ã€‚</p>
<h2 id="7-çº¿ç¨‹å±€éƒ¨å­˜å‚¨">7. çº¿ç¨‹å±€éƒ¨å­˜å‚¨</h2>
<hr>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">rubinera1n</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2020-07-05
      
        <a href="https://github.com/rubinera1n/blogs/commit/61941393fa702c7e993ebedb22f30836cf2d6d0d" title="update">
          (6194139)
        </a>
        
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://blog.xiufuguo.com/tags/linux/">linux</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/programmer_code_interview_guide/ch02_linked_list/05_reverse_part_of_one_way_linked_list/">
            <span class="next-text nav-default">[é“¾è¡¨] 05.åè½¬éƒ¨åˆ†å•å‘é“¾è¡¨</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "rubinera1n/comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:rubinera1n@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://www.linkedin.com/in/hsiufukuo" rel="me noopener" class="iconfont"
      title="linkedin"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="33" height="33">
  <path d="M872.405333 872.618667h-151.637333v-237.610667c0-56.661333-1.152-129.578667-79.018667-129.578667-79.061333 0-91.136 61.653333-91.136 125.397334v241.792H398.976V384h145.664v66.602667h1.962667c20.352-38.4 69.845333-78.933333 143.786666-78.933334 153.642667 0 182.058667 101.12 182.058667 232.746667v268.202667zM227.712 317.141333a87.978667 87.978667 0 0 1-88.021333-88.106666 88.064 88.064 0 1 1 88.021333 88.106666z m76.032 555.477334H151.68V384h152.064v488.618667zM948.266667 0H75.562667C33.792 0 0 33.024 0 73.770667v876.458666C0 991.018667 33.792 1024 75.562667 1024h872.576C989.866667 1024 1024 991.018667 1024 950.229333V73.770667C1024 33.024 989.866667 0 948.138667 0h0.128z"></path>
</svg>

    </a>
  
    <a href="https://github.com/rubinera1n" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://blog.xiufuguo.com/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        rubinera1n
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
